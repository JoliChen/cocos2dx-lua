{"version":3,"sources":["file:///Users/mac/jenkins/workspace/Creator_3D/daily_build_mac/resources/3d/engine/cocos/core/pipeline/shadow/shadow-flow.ts"],"names":["ShadowFlow","RenderFlow","_shadowRenderPass","initialize","info","_stages","length","shadowMapStage","ShadowStage","initInfo","push","render","camera","pipeline","_pipeline","shadowInfo","pipelineSceneData","shadows","shadowFrameBufferMap","shadowObjects","enabled","type","ShadowType","ShadowMap","validLights","maxReceived","clearShadowMap","l","light","has","_initShadowFrameBuffer","shadowFrameBuffer","get","shadowMapDirty","resizeShadowMap","i","shadowStage","setUsage","pipelineUBO","updateShadowUBO","destroy","shadowFrameBuffers","Array","from","values","frameBuffer","renderTargets","colorTextures","j","renderTarget","depth","depthStencilTexture","clear","device","shadowMapSize","size","format","packing","Format","RGBA8","RGBA16F","colorAttachment","ColorAttachment","loadOp","LoadOp","CLEAR","storeOp","StoreOp","STORE","sampleCount","depthStencilAttachment","DepthStencilAttachment","depthStencilFormat","depthLoadOp","depthStoreOp","DISCARD","stencilLoadOp","stencilStoreOp","renderPassInfo","RenderPassInfo","createRenderPass","shadowRenderTargets","createTexture","TextureInfo","TextureType","TEX2D","TextureUsageBit","COLOR_ATTACHMENT","SAMPLED","x","y","DEPTH_STENCIL_ATTACHMENT","createFramebuffer","FramebufferInfo","set","scene","clearFramebuffer","width","height","resize","shadowRenderPass","renderPass","name","PIPELINE_FLOW_SHADOW","priority","ForwardFlowPriority","SHADOW","tag","RenderFlowTag","SCENE","stages"],"mappings":"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"}