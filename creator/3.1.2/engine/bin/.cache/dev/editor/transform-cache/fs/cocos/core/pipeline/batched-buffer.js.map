{"version":3,"sources":["file:///Users/mac/jenkins/workspace/Creator_3D/daily_build_mac/resources/3d/engine/cocos/core/pipeline/batched-buffer.ts"],"names":["BatchedBuffer","get","pass","extraKey","buffers","_buffers","has","set","record","constructor","batches","dynamicOffsets","_device","device","destroy","i","length","batch","j","vbs","vbIdx","ia","ubo","merge","subModel","passIdx","model","flatBuffers","subMesh","vbSize","vbIdxSize","vbCount","count","passes","hShader","SubModelPool","handle","SubModelView","SHADER_0","descriptorSet","isBatchExist","mergeCount","UBOLocalBatched","BATCHING_COUNT","vb","stride","flatBuff","batchVB","vbBuf","vbDatas","size","resize","Uint8Array","buffer","vbIdxBuf","vbIdxData","Float32Array","BYTES_PER_ELEMENT","start","end","Mat4","toArray","uboData","transform","worldMatrix","MAT_WORLDS_OFFSET","bindBuffer","BINDING","update","vertexCount","totalVBs","newVB","createBuffer","BufferInfo","BufferUsageBit","VERTEX","TRANSFER_DST","MemoryUsageBit","HOST","DEVICE","push","fill","attributes","inputAssembler","attrs","Array","a","Attribute","Format","R32F","iaInfo","InputAssemblerInfo","createInputAssembler","UNIFORM","SIZE","COUNT","clear","Map"],"mappings":"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"}