{"version":3,"sources":["../../../../../../../../../../cocos/core/pipeline/shadow/shadow-flow.ts"],"names":["ccclass","PIPELINE_FLOW_SHADOW","supportsHalfFloatTexture","RenderFlow","ForwardFlowPriority","ShadowStage","LoadOp","StoreOp","Format","TextureType","TextureUsageBit","ColorAttachment","DepthStencilAttachment","RenderPassInfo","TextureInfo","FramebufferInfo","RenderFlowTag","ShadowType","lightCollecting","ShadowFlow","_shadowRenderPass","initialize","info","_stages","length","shadowMapStage","initInfo","push","render","camera","pipeline","_pipeline","shadowInfo","pipelineSceneData","shadows","shadowFrameBufferMap","shadowObjects","enabled","type","ShadowMap","validLights","maxReceived","clearShadowMap","l","light","has","_initShadowFrameBuffer","shadowFrameBuffer","get","shadowMapDirty","resizeShadowMap","i","shadowStage","setUsage","pipelineUBO","updateShadowUBO","destroy","shadowFrameBuffers","Array","from","values","frameBuffer","renderTargets","colorTextures","j","renderTarget","depth","depthStencilTexture","clear","device","shadowMapSize","size","format","packing","RGBA8","RGBA16F","colorAttachment","loadOp","CLEAR","storeOp","STORE","sampleCount","depthStencilAttachment","depthStencilFormat","depthLoadOp","depthStoreOp","DISCARD","stencilLoadOp","stencilStoreOp","renderPassInfo","createRenderPass","shadowRenderTargets","createTexture","TEX2D","COLOR_ATTACHMENT","SAMPLED","x","y","DEPTH_STENCIL_ATTACHMENT","createFramebuffer","set","scene","clearFramebuffer","width","height","resize","shadowRenderPass","renderPass","name","priority","SHADOW","tag","SCENE","stages"],"mappings":"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"}