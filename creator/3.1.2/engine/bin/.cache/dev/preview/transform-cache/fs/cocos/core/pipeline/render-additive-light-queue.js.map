{"version":3,"sources":["../../../../../../../../../cocos/core/pipeline/render-additive-light-queue.ts"],"names":["cullSphereLight","light","model","worldBounds","intersect","aabbWithAABB","aabb","cullSpotLight","aabbFrustum","frustum","getLightPassIndices","subModels","lightPassIndices","length","hasValidLightPass","j","passes","lightPassIndex","k","phase","_phaseID","push","BatchedBuffer","BatchingSchemes","InstancedBuffer","PipelineStateManager","DSPool","ShaderPool","PassView","PassPool","SubModelPool","SubModelView","Vec3","nextPow2","Mat4","Color","Sphere","BufferUsageBit","MemoryUsageBit","BufferInfo","BufferViewInfo","Pool","RenderBatchedQueue","RenderInstancedQueue","getPhaseID","LightType","SetIndex","UBOForwardLight","UBOShadow","UNIFORM_SHADOWMAP_BINDING","UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING","supportsHalfFloatTexture","updatePlanarPROJ","_lightPassPool","subModel","passIdx","dynamicOffsets","lights","_vec4Array","Float32Array","_sphere","create","_dynamicOffsets","_lightIndices","_matShadowView","_matShadowViewProj","_lightPassIndices","RenderAdditiveLightQueue","pipeline","_pipeline","_device","_validLights","_lightPasses","_shadowUBO","COUNT","_lightBufferCount","_lightBufferStride","_lightBufferElementCount","_lightBuffer","_firstLightBufferView","_lightBufferData","_instancedQueue","_batchedQueue","_lightMeterScale","device","alignment","capabilities","uboOffsetAlignment","Math","ceil","SIZE","BYTES_PER_ELEMENT","createBuffer","UNIFORM","TRANSFER_DST","HOST","DEVICE","clear","i","lp","freeArray","destroy","descriptorSetMap","globalDSManager","keys","key","descriptorSet","get","getBuffer","BINDING","getSampler","getTexture","gatherLightPasses","camera","cmdBuff","validLights","_gatherValidLights","_updateUBOs","_updateLightDescriptorSet","renderObjects","pipelineSceneData","ro","_lightCulling","lightPassIdx","pass","bindBuffer","update","_addRenderQueue","uploadBuffers","recordCommandBuffer","renderPass","shader","handle","SHADER_0","ia","inputAssembler","pso","getOrCreatePipelineState","matDS","DESCRIPTOR_SET","localDS","bindPipelineState","bindDescriptorSet","MATERIAL","bindInputAssembler","getOrCreateDescriptorSet","GLOBAL","LOCAL","draw","scene","sphereLights","baked","set","position","x","y","z","range","sphereFrustum","spotLights","l","isCulled","type","SPHERE","SPOT","batchingScheme","INSTANCING","idx","buffer","merge","instancedAttributes","queue","add","VB_MERGING","alloc","sceneData","shadowInfo","shadows","shadowFrameBufferMap","mainLight","isSupportHalfFloat","linear","packing","SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET","size","pcf","bias","SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET","normalBias","toArray","shadowColor","SHADOW_COLOR_OFFSET","node","getWorldMatrix","MAT_LIGHT_VIEW_OFFSET","invert","perspective","spotAngle","aspect","multiply","MAT_LIGHT_VIEW_PROJ_OFFSET","SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET","selfShadow","has","texture","colorTextures","bindTexture","updateBuffer","exposure","isHDR","fpScale","resize","initialize","offset","LIGHT_POS_OFFSET","LIGHT_SIZE_RANGE_ANGLE_OFFSET","color","useColorTemperature","tempRGB","colorTemperatureRGB","luminance","LIGHT_COLOR_OFFSET","direction","LIGHT_DIR_OFFSET"],"mappings":"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"}