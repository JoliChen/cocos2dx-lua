System.register(["./fog-01fb8507.js","./screen-3553948d.js","./renderable-component-a695dbe3.js","./texture-buffer-pool-f1baf3ef.js","./transform-utils-753c4611.js","./json-asset-60ef8fb2.js","./create-mesh-b65f8c32.js","./mesh-ffbbac2d.js","./mesh-renderer-966bb16f.js","./skeleton-7e3103f3.js"],(function(t){"use strict";var e,i,n,r,o,s,a,l,u,h,c,f,p,d,_,m,g,y,v,b,k,w,T,S,A,M,x,I,O,B,C,N,P,j,z,E,D,R,L,U,F,H,W,V,K,G,J,Y,q,X,Z,Q,$,tt,et,it,nt,rt,ot,st,at,lt,ut,ht,ct,ft,pt,dt,_t,mt,gt,yt,vt,bt,kt,wt,Tt,St,At,Mt,xt,It,Ot,Bt;return{setters:[function(t){e=t.d3,i=t.dH,n=t.l,r=t.fU,o=t.dy,s=t.cY,a=t.eu,l=t.ew,u=t.ex,h=t.eB,c=t.eA,f=t.ev,p=t.eD,d=t.eE,_=t.eF,m=t.gl,g=t.eH,y=t.eN,v=t.eq,b=t.da,k=t.gn,w=t.go,T=t.gp,S=t.gE,A=t.di,M=t.d0,x=t.bQ,I=t.L,O=t.N,B=t.eZ,C=t.b2,N=t.F,P=t.x,j=t.ap,z=t.z,E=t.G,D=t.gF,R=t.t,L=t.ch,U=t.cg,F=t.gG,H=t.gH,W=t.gI,V=t.bR,K=t.gJ,G=t.en,J=t.gD,Y=t.aG,q=t.b1,X=t.e7,Z=t.dX,Q=t.e4,$=t.gK,tt=t.gb,et=t.ey,it=t.cW,nt=t.eG,rt=t.al,ot=t.T},function(t){st=t.L,at=t.g,lt=t.n},function(t){ut=t.D,ht=t.S,ct=t.b,ft=t.M},function(t){pt=t.T},function(t){dt=t.l,_t=t.S,mt=t.o,gt=t.p,yt=t.n,vt=t.A,bt=t.c},function(t){kt=t.f,wt=t.r,Tt=t.w,St=t.m},function(t){At=t.r,Mt=t.c},function(t){xt=t.M},function(t){It=t.M,Ot=t.a},function(t){Bt=t.S}],execute:function(){var Ct,Nt,Pt,jt,zt,Et,Dt,Rt,Lt,Ut,Ft,Ht,Wt,Vt,Kt,Gt,Jt,Yt,qt,Xt,Zt,Qt=Object.freeze({__proto__:null,find:kt,toPPM:function(t,e,i){return"P3 "+e+" "+i+" 255\n"+t.filter((function(t,e){return e%4<3})).toString()+"\n"},readMesh:At,createMesh:Mt,readBuffer:wt,writeBuffer:Tt,mapBuffer:St});function $t(t,e){var i=t.sharedMaterials.length;if(i!==e.sharedMaterials.length)return!1;for(var n=0;n<i;n++)if(t.getRenderMaterial(n)!==e.getRenderMaterial(n))return!1;return!0}t("u",Qt),t("B",function(){function t(){}return t.batchStaticModel=function(t,i){var n=t.getComponentsInChildren(It);if(n.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var r=1;r<n.length;r++){if(!n[0].mesh.validateMergingMesh(n[r].mesh))return console.error("the meshes of "+n[0].node.name+" and "+n[r].node.name+" can't be merged"),!1;if(!$t(n[0],n[r]))return console.error("the materials of "+n[0].node.name+" and "+n[r].node.name+" can't be merged"),!1}var o=new xt,s=new e,a=new e;t.getWorldMatrix(a),e.invert(a,a);for(var l=0;l<n.length;l++){var u=n[l];u.node.getWorldMatrix(s),e.multiply(s,a,s),o.merge(n[l].mesh,s),u.enabled=!1}var h=i.addComponent(It);return h.mesh=o,h.sharedMaterials=n[0].sharedMaterials,!0},t.unbatchStaticModel=function(t,e){for(var i=t.getComponentsInChildren(It),n=0;n<i.length;n++)i[n].enabled=!0;var r=e.getComponent(It);return r&&(r.mesh&&r.mesh.destroyRenderingMesh(),r.destroy()),!0},t}()),i(It.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),n.ModelComponent=It,r.setClassAlias(It,"cc.ModelComponent");var te,ee,ie,ne,re,oe,se,ae,le,ue,he,ce,fe,pe,de,_e,me,ge,ye,ve,be,ke,we,Te,Se,Ae,Me,xe,Ie,Oe,Be,Ce,Ne,Pe,je,ze,Ee,De,Re,Le,Ue,Fe,He,We,Ve,Ke,Ge,Je,Ye=o({LUMINOUS_POWER:0,LUMINANCE:1}),qe=new s,Xe=a("cc.StaticLightSettings")((Dt=function(){function t(){d(this,"_baked",Pt,this),d(this,"_editorOnly",jt,this),d(this,"_bakeable",zt,this),d(this,"_castShadow",Et,this)}return l(t,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(t){this._editorOnly=t}},{key:"baked",get:function(){return this._baked},set:function(t){this._baked=t}},{key:"bakeable",get:function(){return this._bakeable},set:function(t){this._bakeable=t}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}}]),t}(),Pt=u((Nt=Dt).prototype,"_baked",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jt=u(Nt.prototype,"_editorOnly",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zt=u(Nt.prototype,"_bakeable",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Et=u(Nt.prototype,"_castShadow",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),u(Nt.prototype,"editorOnly",[h],Object.getOwnPropertyDescriptor(Nt.prototype,"editorOnly"),Nt.prototype),u(Nt.prototype,"bakeable",[h],Object.getOwnPropertyDescriptor(Nt.prototype,"bakeable"),Nt.prototype),u(Nt.prototype,"castShadow",[h],Object.getOwnPropertyDescriptor(Nt.prototype,"castShadow"),Nt.prototype),Ct=Nt))||Ct,Ze=t("L",(Rt=a("cc.Light"),Lt=m(),Ut=m(),Ft=g(),Ht=m(),Wt=c(Xe),Rt((Zt=Xt=function(t){function e(){var e;return e=t.call(this)||this,d(e,"_color",Gt,y(e)),d(e,"_useColorTemperature",Jt,y(e)),d(e,"_colorTemperature",Yt,y(e)),d(e,"_staticSettings",qt,y(e)),e._type=st.UNKNOWN,e._lightType=void 0,e._light=null,e._lightType=at,e}f(e,t);var i=e.prototype;return i.onLoad=function(){this._createLight()},i.onEnable=function(){this._attachToScene()},i.onDisable=function(){this._detachFromScene()},i.onDestroy=function(){this._destroyLight()},i._createLight=function(){this._light||(this._light=n.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked},i._destroyLight=function(){this._light&&(n.director.root.destroyLight(this),this._light=null)},i._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var t=this._getRenderScene();switch(this._type){case st.DIRECTIONAL:t.addDirectionalLight(this._light),t.setMainLight(this._light);break;case st.SPHERE:t.addSphereLight(this._light);break;case st.SPOT:t.addSpotLight(this._light)}}},i._detachFromScene=function(){if(this._light&&this._light.scene){var t=this._light.scene;switch(this._type){case st.DIRECTIONAL:t.removeDirectionalLight(this._light),t.unsetMainLight(this._light);break;case st.SPHERE:t.removeSphereLight(this._light);break;case st.SPOT:t.removeSpotLight(this._light)}}},l(e,[{key:"color",get:function(){return this._color},set:function(t){this._color=t,this._light&&(qe.x=t.r/255,qe.y=t.g/255,qe.z=t.b/255,this._light.color=qe)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(t){this._useColorTemperature=t,this._light&&(this._light.useColorTemperature=t)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(t){this._colorTemperature=t,this._light&&(this._light.colorTemperature=t)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(t){this._staticSettings=t}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(t){this.staticSettings.baked=t,null!==this._light&&(this._light.baked=t)}}]),e}(v),Xt.Type=st,Xt.PhotometricTerm=Ye,Gt=u((Kt=Zt).prototype,"_color",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return b.WHITE.clone()}}),Jt=u(Kt.prototype,"_useColorTemperature",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Yt=u(Kt.prototype,"_colorTemperature",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),qt=u(Kt.prototype,"_staticSettings",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xe}}),u(Kt.prototype,"color",[Lt],Object.getOwnPropertyDescriptor(Kt.prototype,"color"),Kt.prototype),u(Kt.prototype,"useColorTemperature",[Ut],Object.getOwnPropertyDescriptor(Kt.prototype,"useColorTemperature"),Kt.prototype),u(Kt.prototype,"colorTemperature",[p,Ft,Ht],Object.getOwnPropertyDescriptor(Kt.prototype,"colorTemperature"),Kt.prototype),u(Kt.prototype,"staticSettings",[Wt],Object.getOwnPropertyDescriptor(Kt.prototype,"staticSettings"),Kt.prototype),Vt=Kt))||Vt)),Qe=t("D",(te=a("cc.DirectionalLight"),ee=w(),ie=T(),ne=S(),re=m(),te(oe=ee(oe=ie(oe=k((le=function(t){function e(){var e;return e=t.call(this)||this,d(e,"_illuminance",ae,y(e)),e._type=st.DIRECTIONAL,e._light=null,e._lightType=ut,e}return f(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this._light&&(this.illuminance=this._illuminance)},l(e,[{key:"illuminance",get:function(){return this._illuminance},set:function(t){this._illuminance=t,this._light&&(this._light.illuminance=this._illuminance)}}]),e}(Ze),ae=u((se=le).prototype,"_illuminance",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),u(se.prototype,"illuminance",[ne,re],Object.getOwnPropertyDescriptor(se.prototype,"illuminance"),se.prototype),oe=se))||oe)||oe)||oe)||oe)),$e=t("S",(ue=a("cc.SphereLight"),he=w(),ce=T(),fe=S(),pe=m(),de=S(),_e=m(),me=c(Ye),ge=m(),ye=m(),ve=m(),ue(be=he(be=ce(be=k((Me=function(t){function e(){var e;return e=t.call(this)||this,d(e,"_size",we,y(e)),d(e,"_luminance",Te,y(e)),d(e,"_term",Se,y(e)),d(e,"_range",Ae,y(e)),e._type=st.SPHERE,e._light=null,e._lightType=ht,e}return f(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this._light&&(this.luminance=this._luminance,this.size=this._size,this.range=this._range)},l(e,[{key:"luminousPower",get:function(){return this._luminance*lt(this._size)},set:function(t){this._luminance=t/lt(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(t){this._luminance=t,this._light&&(this._light.luminance=t)}},{key:"term",get:function(){return this._term},set:function(t){this._term=t}},{key:"size",get:function(){return this._size},set:function(t){this._size=t,this._light&&(this._light.size=t)}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._light&&(this._light.range=t)}}]),e}(Ze),we=u((ke=Me).prototype,"_size",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),Te=u(ke.prototype,"_luminance",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/lt(.15)}}),Se=u(ke.prototype,"_term",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ye.LUMINOUS_POWER}}),Ae=u(ke.prototype,"_range",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),u(ke.prototype,"luminousPower",[fe,pe],Object.getOwnPropertyDescriptor(ke.prototype,"luminousPower"),ke.prototype),u(ke.prototype,"luminance",[de,_e],Object.getOwnPropertyDescriptor(ke.prototype,"luminance"),ke.prototype),u(ke.prototype,"term",[me,ge],Object.getOwnPropertyDescriptor(ke.prototype,"term"),ke.prototype),u(ke.prototype,"size",[ye],Object.getOwnPropertyDescriptor(ke.prototype,"size"),ke.prototype),u(ke.prototype,"range",[ve],Object.getOwnPropertyDescriptor(ke.prototype,"range"),ke.prototype),be=ke))||be)||be)||be)||be)),ti=t("a",(xe=a("cc.SpotLight"),Ie=w(),Oe=T(),Be=S(),Ce=m(),Ne=S(),Pe=m(),je=c(Ye),ze=m(),Ee=m(),De=m(),Re=g(),Le=m(),xe(Ue=Ie(Ue=Oe(Ue=k((Je=function(t){function e(){var e;return e=t.call(this)||this,d(e,"_size",He,y(e)),d(e,"_luminance",We,y(e)),d(e,"_term",Ve,y(e)),d(e,"_range",Ke,y(e)),d(e,"_spotAngle",Ge,y(e)),e._type=st.SPOT,e._light=null,e._lightType=ct,e}return f(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this._light&&(this.luminance=this._luminance,this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle)},l(e,[{key:"luminousPower",get:function(){return this._luminance*lt(this._size)},set:function(t){this._luminance=t/lt(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(t){this._luminance=t,this._light&&(this._light.luminance=t)}},{key:"term",get:function(){return this._term},set:function(t){this._term=t}},{key:"size",get:function(){return this._size},set:function(t){this._size=t,this._light&&(this._light.size=t)}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._light&&(this._light.range=t)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(t){this._spotAngle=t,this._light&&(this._light.spotAngle=A(t))}}]),e}(Ze),He=u((Fe=Je).prototype,"_size",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),We=u(Fe.prototype,"_luminance",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/lt(.15)}}),Ve=u(Fe.prototype,"_term",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ye.LUMINOUS_POWER}}),Ke=u(Fe.prototype,"_range",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ge=u(Fe.prototype,"_spotAngle",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),u(Fe.prototype,"luminousPower",[Be,Ce],Object.getOwnPropertyDescriptor(Fe.prototype,"luminousPower"),Fe.prototype),u(Fe.prototype,"luminance",[Ne,Pe],Object.getOwnPropertyDescriptor(Fe.prototype,"luminance"),Fe.prototype),u(Fe.prototype,"term",[je,ze],Object.getOwnPropertyDescriptor(Fe.prototype,"term"),Fe.prototype),u(Fe.prototype,"size",[Ee],Object.getOwnPropertyDescriptor(Fe.prototype,"size"),Fe.prototype),u(Fe.prototype,"range",[De],Object.getOwnPropertyDescriptor(Fe.prototype,"range"),Fe.prototype),u(Fe.prototype,"spotAngle",[p,Re,Le],Object.getOwnPropertyDescriptor(Fe.prototype,"spotAngle"),Fe.prototype),Ue=Fe))||Ue)||Ue)||Ue)||Ue));n.LightComponent=Ze,r.setClassAlias(Ze,"cc.LightComponent"),n.DirectionalLightComponent=Qe,r.setClassAlias(Qe,"cc.DirectionalLightComponent"),n.SphereLightComponent=$e,r.setClassAlias($e,"cc.SphereLightComponent"),n.SpotLightComponent=ti,r.setClassAlias(ti,"cc.SpotLightComponent");var ei=function(t,e,i){t[e+0]=i.m00,t[e+1]=i.m01,t[e+2]=i.m02,t[e+3]=i.m12,t[e+4]=i.m04,t[e+5]=i.m05,t[e+6]=i.m06,t[e+7]=i.m13,t[e+8]=i.m08,t[e+9]=i.m09,t[e+10]=i.m10,t[e+11]=i.m14};function ii(t,e){var i=4/Math.sqrt(e);return 12*Math.ceil(Math.max(480*i,t)/12)}new M,new M,new s,new M,new s;var ni=x([I.POINT,I.POINT,I.NONE,O.CLAMP,O.CLAMP,O.CLAMP]),ri=new s,oi=new s,si=new s,ai=new s,li=new e,ui=new e,hi=new B,ci=Number.MAX_SAFE_INTEGER,fi=function(){function t(t){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=t;var e=function(t){return t.hasFeature(N.TEXTURE_FLOAT)?P.RGBA32F:P.RGBA8}(this._device);this._formatSize=C[e].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new pt(t),this._pool.initialize({format:e,roundUpFn:ii}),this._customPool=new pt(t),this._customPool.initialize({format:e,roundUpFn:ii})}var i=t.prototype;return i.clear=function(){this._pool.destroy(),this._textureBuffers.clear()},i.registerCustomTextureLayouts=function(t){for(var e=0;e<t.length;e++)for(var i=t[e],n=this._customPool.createChunk(i.textureLength),r=0;r<i.contents.length;r++){var o=i.contents[r],s=o.skeleton;this._chunkIdxMap.set(s,n);for(var a=0;a<o.clips.length;a++){var l=o.clips[a];this._chunkIdxMap.set(s^l,n)}}},i.getDefaultPoseTexture=function(t,i,n){var r=0^t.hash,o=this._textureBuffers.get(r)||null;if(o&&o.bounds.has(i.hash))return o.refCount++,o;var a=t.joints,l=t.bindposes,u=null,h=!1,c=a.length;if(o)o.refCount++;else{var f=12*c,p=this._chunkIdxMap.get(r),d=void 0!==p?this._customPool.alloc(f*Float32Array.BYTES_PER_ELEMENT,p):this._pool.alloc(f*Float32Array.BYTES_PER_ELEMENT);if(!d)return o;o={pixelOffset:d.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:0,readyToBeDeleted:!1,handle:d},u=new Float32Array(f),h=!0}s.set(si,ci,ci,ci),s.set(ai,-ci,-ci,-ci);for(var _=i.getBoneSpaceBounds(t),m=0,g=0;m<c;m++,g+=12){var y=n.getChildByPath(a[m]),v=y?dt(y,n,li):t.inverseBindposes[m],b=_[m];b&&(B.transform(hi,b,v),hi.getBoundary(ri,oi),s.min(si,si,ri),s.max(ai,ai,oi)),h&&(y&&e.multiply(v,v,l[m]),ei(u,g,y?v:e.IDENTITY))}var k=[new B];return o.bounds.set(i.hash,k),B.fromPoints(k[0],si,ai),h&&(this._pool.update(o.handle,u.buffer),this._textureBuffers.set(r,o)),o},i.getSequencePoseTexture=function(t,i,n,r){var o=t.hash^i.hash,a=this._textureBuffers.get(o)||null;if(a&&a.bounds.has(n.hash))return a.refCount++,a;var l=t.joints,u=t.bindposes,h=_t.getOrExtract(i).info.frames,c=null,f=!1,p=l.length;if(a)a.refCount++;else{var d=12*p*h,_=this._chunkIdxMap.get(o),m=void 0!==_?this._customPool.alloc(d*Float32Array.BYTES_PER_ELEMENT,_):this._pool.alloc(d*Float32Array.BYTES_PER_ELEMENT);if(!m)return null;var g=this._createAnimInfos(t,i,r);a={pixelOffset:m.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:i.hash,readyToBeDeleted:!1,handle:m,animInfos:g},c=new Float32Array(d),f=!0}var y=n.getBoneSpaceBounds(t),v=[];a.bounds.set(n.hash,v);for(var b=0;b<h;b++)v.push(new B(ci,ci,ci,-ci,-ci,-ci));for(var k=0,w=0;k<h;k++){for(var T=v[k],S=0;S<p;S++,w+=12){var A=a.animInfos[S],M=A.curveData,x=A.downstream,I=A.bindposeIdx,O=A.bindposeCorrection,C=void 0,N=!0;M&&x?C=e.multiply(li,M[k],x):M?C=M[k]:x?C=x:(C=t.inverseBindposes[I],N=!1);var P=y[S];if(P){var j=O?e.multiply(ui,C,O):C;B.transform(hi,P,j),hi.getBoundary(ri,oi),s.min(T.center,T.center,ri),s.max(T.halfExtents,T.halfExtents,oi)}f&&(N&&e.multiply(li,C,u[I]),ei(c,w,N?li:e.IDENTITY))}B.fromPoints(T,T.center,T.halfExtents)}return f&&(this._pool.update(a.handle,c.buffer),this._textureBuffers.set(o,a)),a},i.releaseHandle=function(t){if(t.refCount>0&&t.refCount--,!t.refCount&&t.readyToBeDeleted){var e=t.skeletonHash^t.clipHash;(void 0!==this._chunkIdxMap.get(e)?this._customPool:this._pool).free(t.handle),this._textureBuffers.get(e)===t&&this._textureBuffers.delete(e)}},i.releaseSkeleton=function(t){for(var e=this._textureBuffers.values(),i=e.next();!i.done;){var n=i.value;n.skeletonHash===t.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=e.next()}},i.releaseAnimationClip=function(t){for(var e=this._textureBuffers.values(),i=e.next();!i.done;){var n=i.value;n.clipHash===t.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=e.next()}},i._createAnimInfos=function(t,i,n){for(var r=[],o=t.joints,s=t.bindposes,a=o.length,l=_t.getOrExtract(i),u=0;u<a;u++){for(var h=o[u],c=l.data[h],f=n.getChildByPath(h),p=void 0,d=void 0;!c;){var _=h.lastIndexOf("/");if(h=h.substring(0,_),c=l.data[h],f?(p||(p=new e),e.fromRTS(li,f.rotation,f.position,f.scale),e.multiply(p,li,p),f=f.parent):d=h,_<0)break}var m=u,g=void 0;if(void 0!==d&&c){m=u-1;for(var y=0;y<a;y++)if(o[y]===d){m=y,g=new e,e.multiply(g,s[y],t.inverseBindposes[u]);break}}r.push({curveData:c&&c.worldMatrix.values,downstream:p,bindposeIdx:m,bindposeCorrection:g})}return r},l(t,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),t}(),pi=function(){function t(t){this._pool=new Map,this._device=void 0,this._device=t}var e=t.prototype;return e.getData=function(t){void 0===t&&(t="-1");var e=this._pool.get(t);if(e)return e;var i=this._device.createBuffer(new j(z.UNIFORM|z.TRANSFER_DST,E.HOST|E.DEVICE,D.SIZE,D.SIZE)),n=new Float32Array([0,0,0,0]);i.update(n);var r={buffer:i,data:n,dirty:!1};return this._pool.set(t,r),r},e.destroy=function(t){var e=this._pool.get(t);e&&(e.buffer.destroy(),this._pool.delete(t))},e.switchClip=function(t){return t.data[0]=0,t.buffer.update(t.data),t.dirty=!1,t},e.clear=function(){for(var t,e=R(this._pool.values());!(t=e()).done;)t.value.buffer.destroy();this._pool.clear()},t}(),di=function(){function t(t){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new fi(t),this.jointAnimationInfo=new pi(t)}var e=t.prototype;return e.releaseSkeleton=function(t){this.jointTexturePool.releaseSkeleton(t)},e.releaseAnimationClip=function(t){this.jointTexturePool.releaseAnimationClip(t)},e.clear=function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()},t}();n.internal.DataPoolManager=di;var _i=[{name:"CC_USE_SKINNING",value:!0}];function mi(t,e,i,n){for(var r=0;r<i.length;r++){for(var o=i[r],s=-1,a=0;a<o.length;a++)if(o[a]===n){s=a;break}s>=0&&(e.push(r),t.push(s))}}var gi,yi,vi,bi,ki,wi,Ti,Si,Ai,Mi,xi,Ii,Oi,Bi,Ci,Ni,Pi,ji,zi,Ei,Di,Ri,Li,Ui,Fi,Hi,Wi,Vi,Ki,Gi,Ji,Yi,qi,Xi,Zi,Qi,$i,tn,en,nn,rn,on,sn,an,ln,un=new s,hn=new s,cn=new s,fn=new s,pn=new e,dn=new B,_n=function(t){function i(){var e;return(e=t.call(this)||this).uploadAnimation=null,e._buffers=[],e._dataArray=[],e._joints=[],e._bufferIndices=null,e.type=ft.SKINNING,e}f(i,t);var n=i.prototype;return n.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}t.prototype.destroy.call(this)},n.bindSkeleton=function(t,e,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null);for(var n=0;n<this._joints.length;n++)mt(this._joints[n].target);if(this._bufferIndices=null,this._joints.length=0,t&&e&&i){this.transform=e;var r=i.getBoneSpaceBounds(t),o=i.struct.jointMaps;this._ensureEnoughBuffers(o&&o.length||1),this._bufferIndices=i.jointBufferIndices;for(var s=0;s<t.joints.length;s++){var a=r[s],l=e.getChildByPath(t.joints[s]);if(a&&l){var u=gt(l,e),h=t.bindposes[s],c=[],f=[];o?mi(c,f,o,s):(c.push(s),f.push(0)),this._joints.push({indices:c,buffers:f,bound:a,target:l,bindpose:h,transform:u})}}}},n.updateTransform=function(t){var e=this.transform;(e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdated=!0),s.set(un,1/0,1/0,1/0),s.set(hn,-1/0,-1/0,-1/0);for(var i=0;i<this._joints.length;i++){var n=this._joints[i],r=n.bound,o=n.transform,a=yt(o,t);B.transform(dn,r,a),dn.getBoundary(cn,fn),s.min(un,un,cn),s.max(hn,hn,fn)}var l=this._worldBounds;this._modelBounds&&l&&(B.fromPoints(this._modelBounds,un,hn),this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds),L.setVec3(this._hWorldBounds,U.CENTER,l.center),L.setVec3(this._hWorldBounds,U.HALF_EXTENSION,l.halfExtents))},n.updateUBOs=function(i){t.prototype.updateUBOs.call(this,i);for(var n=0;n<this._joints.length;n++){var r=this._joints[n],o=r.indices,s=r.buffers,a=r.transform,l=r.bindpose;e.multiply(pn,a.world,l);for(var u=0;u<s.length;u++)ei(this._dataArray[s[u]],12*o[u],pn)}for(var h=0;h<this._buffers.length;h++)this._buffers[h].update(this._dataArray[h]);return!0},n.initSubModel=function(e,i,n){var r=i.vertexBuffers,o=i.iaInfo;o.vertexBuffers=i.jointMappedBuffers,t.prototype.initSubModel.call(this,e,i,n),o.vertexBuffers=r},n.getMacroPatches=function(e){var i=t.prototype.getMacroPatches.call(this,e);return i?_i.concat(i):_i},n._updateLocalDescriptors=function(e,i){t.prototype._updateLocalDescriptors.call(this,e,i);var n=this._buffers[this._bufferIndices[e]];n&&i.bindBuffer(F.BINDING,n)},n._ensureEnoughBuffers=function(t){for(var e=0;e<t;e++)this._buffers[e]||(this._buffers[e]=this._device.createBuffer(new j(z.UNIFORM|z.TRANSFER_DST,E.HOST|E.DEVICE,F.SIZE,F.SIZE))),this._dataArray[e]||(this._dataArray[e]=new Float32Array(F.COUNT))},i}(Ot),mn=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],gn=function(t){function e(){var e;(e=t.call(this)||this).uploadedAnim=void 0,e._jointsMedium=void 0,e._skeleton=null,e._mesh=null,e._dataPoolManager=void 0,e._instAnimInfoIdx=-1,e.type=ft.BAKED_SKINNING,e._dataPoolManager=n.director.root.dataPoolManager;var i=new Float32Array(4),r=e._dataPoolManager.jointAnimationInfo.getData();return e._jointsMedium={buffer:null,jointTextureInfo:i,animInfo:r,texture:null,boundsInfo:null},e}f(e,t);var i=e.prototype;return i.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),t.prototype.destroy.call(this)},i.bindSkeleton=function(t,e,i){if(void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null),this._skeleton=t,this._mesh=i,t&&e&&i){this.transform=e;var n=this._dataPoolManager;this._jointsMedium.animInfo=n.jointAnimationInfo.getData(e.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new j(z.UNIFORM|z.TRANSFER_DST,E.HOST|E.DEVICE,H.SIZE,H.SIZE)))}},i.updateTransform=function(e){if(t.prototype.updateTransform.call(this,e),this.uploadedAnim){var i=this._jointsMedium,n=i.animInfo,r=i.boundsInfo[n.data[0]],o=this._worldBounds;if(o&&r){var s=this.transform;r.transform(s._mat,s._pos,s._rot,s._scale,o),L.setVec3(this._hWorldBounds,U.CENTER,o.center),L.setVec3(this._hWorldBounds,U.HALF_EXTENSION,o.halfExtents)}}},i.updateUBOs=function(e){t.prototype.updateUBOs.call(this,e);var i=this._jointsMedium.animInfo,n=this._instAnimInfoIdx;return n>=0?this.instancedAttributes.views[n][0]=i.data[0]:i.dirty&&(i.buffer.update(i.data),i.dirty=!1),!0},i.uploadAnimation=function(t){if(this._skeleton&&this._mesh&&this.uploadedAnim!==t){this.uploadedAnim=t;var e=this._dataPoolManager,i=null;t?(i=e.jointTexturePool.getSequencePoseTexture(this._skeleton,t,this._mesh,this.transform),this._jointsMedium.boundsInfo=i&&i.bounds.get(this._mesh.hash),this._modelBounds=null):(i=e.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._modelBounds=i&&i.bounds.get(this._mesh.hash)[0]),this._applyJointTexture(i)}},i._applyJointTexture=function(t){void 0===t&&(t=null);var e=this._jointsMedium.texture;if(e&&e!==t&&this._dataPoolManager.jointTexturePool.releaseHandle(e),this._jointsMedium.texture=t,t){var i=this._jointsMedium,n=i.buffer,r=i.jointTextureInfo;r[0]=t.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=t.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),n&&n.update(r);for(var o=t.handle.texture,s=0;s<this._subModels.length;++s)this._subModels[s].descriptorSet.bindTexture(W,o)}},i.getMacroPatches=function(e){var i=t.prototype.getMacroPatches.call(this,e);return i?i.concat(mn):mn},i._updateLocalDescriptors=function(e,i){t.prototype._updateLocalDescriptors.call(this,e,i);var n=this._jointsMedium,r=n.buffer,o=n.texture,s=n.animInfo;if(i.bindBuffer(H.BINDING,r),i.bindBuffer(D.BINDING,s.buffer),o){var a=V.getSampler(this._device,ni);i.bindTexture(W,o.handle.texture),i.bindSampler(W,a)}},i._updateInstancedAttributes=function(e,i){t.prototype._updateInstancedAttributes.call(this,e,i),this._instAnimInfoIdx=this._getInstancedAttributeIndex(K),this.updateInstancedJointTextureInfo()},i.updateInstancedJointTextureInfo=function(){var t=this._jointsMedium,e=t.jointTextureInfo,i=t.animInfo,n=this._instAnimInfoIdx;if(n>=0){var r=this.instancedAttributes.views[n];r[0]=i.data[0],r[1]=e[1],r[2]=e[2]}},e}(Ot),yn=t("b",(gi=a("cc.SkinnedMeshRenderer"),yi=w(),vi=J(100),bi=T(),ki=c(Bt),wi=c(G),Ti=c(Bt),Si=c(G),Ai=m(),gi(Mi=yi(Mi=vi(Mi=k(Mi=bi((Bi=function(t){function e(){var e;return e=t.call(this)||this,d(e,"_skeleton",Ii,y(e)),d(e,"_skinningRoot",Oi,y(e)),e._clip=null,e._modelType=gn,e}f(e,t);var i=e.prototype;return i.__preload=function(){this._updateModelType()},i.uploadAnimation=function(t){this._clip=t,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(t)},i.setUseBakedAnimation=function(t){void 0===t&&(t=!0);var e=t?gn:_n;this._modelType!==e&&(this._modelType=e,this._model&&(n.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this.enabledInHierarchy&&this._attachToScene()))},i.setMaterial=function(e,i){t.prototype.setMaterial.call(this,e,i),this._modelType===_n&&this.getMaterialInstance(i)},i._updateModelParams=function(){this._update(),t.prototype._updateModelParams.call(this)},i._updateModelType=function(){if(this._skinningRoot){var t=this._skinningRoot.getComponent("cc.SkeletalAnimation");t?this.setUseBakedAnimation(t.useBakedAnimation):this.setUseBakedAnimation(!1)}},i._update=function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))},l(e,[{key:"skeleton",get:function(){return this._skeleton},set:function(t){t!==this._skeleton&&(this._skeleton=t,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(t){t!==this._skinningRoot&&(this._skinningRoot=t,this._updateModelType(),this._update())}},{key:"model",get:function(){return this._model}}]),e}(It),Ii=u((xi=Bi).prototype,"_skeleton",[ki],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oi=u(xi.prototype,"_skinningRoot",[wi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),u(xi.prototype,"skeleton",[Ti],Object.getOwnPropertyDescriptor(xi.prototype,"skeleton"),xi.prototype),u(xi.prototype,"skinningRoot",[Si,Ai],Object.getOwnPropertyDescriptor(xi.prototype,"skinningRoot"),xi.prototype),Mi=xi))||Mi)||Mi)||Mi)||Mi)||Mi)),vn=new Y(q.ATTR_BATCH_ID,P.R32F),bn=new Y(q.ATTR_BATCH_UV,P.RG32F),kn=C[vn.format].size+C[bn.format].size,wn=t("d",(Ci=a("cc.SkinnedMeshUnit"),Ni=c(xt),Pi=c(Bt),ji=c(X),zi=c(yn),Ci((Vi=function(){function t(){d(this,"mesh",Ri,this),d(this,"skeleton",Li,this),d(this,"material",Ui,this),d(this,"_localTransform",Fi,this),d(this,"_offset",Hi,this),d(this,"_size",Wi,this)}return l(t,[{key:"offset",get:function(){return this._offset},set:function(t){it.copy(this._offset,t)}},{key:"size",get:function(){return this._size},set:function(t){it.copy(this._size,t)}},{key:"copyFrom",get:function(){return null},set:function(t){t&&(this.mesh=t.mesh,this.skeleton=t.skeleton,this.material=t.getMaterial(0),t.skinningRoot&&dt(t.node,t.skinningRoot,this._localTransform))}}]),t}(),Ri=u((Di=Vi).prototype,"mesh",[Ni],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Li=u(Di.prototype,"skeleton",[Pi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ui=u(Di.prototype,"material",[ji],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fi=u(Di.prototype,"_localTransform",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),Hi=u(Di.prototype,"_offset",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new it(0,0)}}),Wi=u(Di.prototype,"_size",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new it(1,1)}}),u(Di.prototype,"offset",[h],Object.getOwnPropertyDescriptor(Di.prototype,"offset"),Di.prototype),u(Di.prototype,"size",[h],Object.getOwnPropertyDescriptor(Di.prototype,"size"),Di.prototype),u(Di.prototype,"copyFrom",[zi],Object.getOwnPropertyDescriptor(Di.prototype,"copyFrom"),Di.prototype),Ei=Di))||Ei)),Tn=new e,Sn=(new e,new s),An=t("c",(Ki=a("cc.SkinnedMeshBatchRenderer"),Gi=w(),Ji=J(100),Yi=T(),qi=m(),Xi=c([Z]),Zi=m(),Qi=c([wn]),$i=m(),tn=nt(),en=nt(),Ki(nn=Gi(nn=Ji(nn=k(nn=Yi((ln=function(t){function i(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return e=t.call.apply(t,[this].concat(n))||this,d(e,"atlasSize",on,y(e)),d(e,"batchableTextureNames",sn,y(e)),d(e,"units",an,y(e)),e._textures={},e._batchMaterial=null,e}f(i,t);var r=i.prototype;return r.onLoad=function(){t.prototype.onLoad.call(this),this.cook()},r.onDestroy=function(){for(var e in this._textures)this._textures[e].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),t.prototype.onDestroy.call(this)},r._onMaterialModified=function(e){this.cookMaterials(),t.prototype._onMaterialModified.call(this,e,this.getMaterialInstance(e))},r.cook=function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()},r.cookMaterials=function(){var t=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var e=this.getMaterialInstance(0);if(e&&this._batchMaterial&&this._batchMaterial.effectAsset){e.copy(this._batchMaterial),this.resizeAtlases();for(var i=e.effectAsset.techniques[e.technique],n=function(n){var r=i.passes[n];if(!r.properties)return"continue";var o=function(i){if(r.properties[i].type>=ot.SAMPLER1D){var o=null;t.batchableTextureNames.find((function(t){return t===i}))?((o=t._textures[i])||(o=t.createTexture(i)),t.cookTextures(o,i,n)):t.units.some((function(t){return o=t.material&&t.material.getProperty(i,n)})),o&&e.setProperty(i,o,n)}else{for(var s=[],a=0;a<t.units.length;a++){var l=t.units[a];l.material&&s.push(l.material.getProperty(i.slice(0,-3),n))}e.setProperty(i,s,n)}};for(var s in r.properties)o(s)},r=0;r<i.passes.length;r++)n(r)}else console.warn("incomplete batch material!")},r.cookSkeletons=function(){if(this._skinningRoot){for(var t=[],i=[],n=0;n<this.units.length;n++){var r=this.units[n];if(r&&r.skeleton){var o=r.skeleton;e.invert(Tn,r._localTransform);for(var s=function(n){var r=o.joints[n];if(t.findIndex((function(t){return t===r}))>=0)return"continue";t.push(r),i.push(e.multiply(new e,o.bindposes[n]||e.IDENTITY,Tn))},a=0;a<o.joints.length;a++)s(a)}}var l=Array.from(Array(t.length).keys()).sort((function(e,i){return t[e]>t[i]?1:t[e]<t[i]?-1:0})),u=new Bt;u.joints=t.map((function(t,e,i){return i[l[e]]})),u.bindposes=i.map((function(t,e,i){return i[l[e]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=u}else console.warn("no skinning root specified!")},r.cookMeshes=function(){for(var t=this,i=!1,n=0;n<this.units.length;n++)if(this.units[n].mesh){i=!0;break}if(i&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new xt;for(var r=0,o=P.UNKNOWN,a=0,l=P.UNKNOWN,u=0,h=P.UNKNOWN,c=0,f=P.UNKNOWN,p=0,d=P.UNKNOWN,_=new Array(this.units.length),m=this.units.length,g=0;g<m;g++){var y=this.units[g];y&&y.skeleton&&(_[g]=y.skeleton.joints.map((function(e){return t._skeleton.joints.findIndex((function(t){return e===t}))})))}for(var v=function(i){var n=t.units[i];if(!n||!n.mesh||!n.mesh.data)return"continue";var m=t._createUnitMesh(i,n.mesh),g=new DataView(m.data.buffer);e.inverseTranspose(Tn,n._localTransform);for(var y=n.offset,v=n.size,b=function(t){var e=m.struct.vertexBundles[t];r=e.view.offset,o=P.UNKNOWN;for(var b=0;b<e.attributes.length;b++){var k=e.attributes[b];if(k.name===q.ATTR_POSITION){o=k.format;break}r+=C[k.format].size}if(o){for(var w=wt(g,o,r,e.view.length,e.view.stride),T=0;T<w.length;T+=3)s.fromArray(Sn,w,T),s.transformMat4(Sn,Sn,n._localTransform),s.toArray(w,Sn,T);Tt(g,w,o,r,e.view.stride)}a=e.view.offset,l=P.UNKNOWN;for(var S=0;S<e.attributes.length;S++){var A=e.attributes[S];if(A.name===q.ATTR_NORMAL){l=A.format;break}a+=C[A.format].size}if(l){for(var M=wt(g,l,a,e.view.length,e.view.stride),x=0;x<M.length;x+=3)s.fromArray(Sn,M,x),s.transformMat4Normal(Sn,Sn,Tn),s.toArray(M,Sn,x);Tt(g,M,l,a,e.view.stride)}u=e.view.offset,h=P.UNKNOWN;for(var I=0;I<e.attributes.length;I++){var O=e.attributes[I];if(O.name===q.ATTR_TANGENT){h=O.format;break}u+=C[O.format].size}if(h){for(var B=wt(g,h,u,e.view.length,e.view.stride),N=0;N<B.length;N+=3)s.fromArray(Sn,B,N),s.transformMat4Normal(Sn,Sn,Tn),s.toArray(B,Sn,N);Tt(g,B,h,u,e.view.stride)}c=e.view.offset,f=P.UNKNOWN;for(var j=0;j<e.attributes.length;j++){var z=e.attributes[j];if(z.name===q.ATTR_BATCH_UV){f=z.format;break}c+=C[z.format].size}f&&St(g,(function(t,e){var i,n=0===e?"x":"y";return(t=(i=t)-Math.floor(i))*v[n]+y[n]}),f,c,e.view.length,e.view.stride,g);var E=_[i];if(!E)return"continue";p=e.view.offset,d=P.UNKNOWN;for(var D=0;D<e.attributes.length;D++){var R=e.attributes[D];if(R.name===q.ATTR_JOINTS){d=R.format;break}p+=C[R.format].size}d&&St(g,(function(t){return E[t]}),d,p,e.view.length,e.view.stride,g)},k=0;k<m.struct.vertexBundles.length;k++)b(k);t._mesh.merge(m)},b=0;b<m;b++)v(b);this._onMeshChanged(this._mesh),this._updateModels()}},r.cookTextures=function(t,e,i){for(var r=[],o=[],s=[],a=[],l=0;l<this.units.length;l++){var u=this.units[l];if(u.material){var h=u.material.getProperty(e,i);if(h&&h.image&&h.image.data){var c=new rt;c.texOffset.x=u.offset.x*this.atlasSize,c.texOffset.y=u.offset.y*this.atlasSize,c.texExtent.width=u.size.x*this.atlasSize,c.texExtent.height=u.size.y*this.atlasSize;var f=h.image.data;ArrayBuffer.isView(f)?(s.push(f),a.push(c)):(r.push(f),o.push(c))}}}var p=t.getGFXTexture(),d=n.director.root.device;s.length>0&&d.copyBuffersToTexture(s,p,a),r.length>0&&d.copyTexImagesToTexture(r,p,o)},r.createTexture=function(t){var e=new Q;return e.setFilters($.LINEAR,$.LINEAR),e.setMipFilter($.NEAREST),e.reset({width:this.atlasSize,height:this.atlasSize,format:tt.RGBA8888}),e.loaded=!0,this._textures[t]=e,e},r.resizeAtlases=function(){for(var t in this._textures)this._textures[t].reset({width:this.atlasSize,height:this.atlasSize,format:tt.RGBA8888})},r._createUnitMesh=function(t,e){for(var i=JSON.parse(JSON.stringify(e.struct)),r={},o=0;o<e.struct.primitives.length;o++){for(var s=e.struct.primitives[o],a=0,l=P.UNKNOWN,u=0;u<s.vertexBundelIndices.length;u++){var h=e.struct.vertexBundles[s.vertexBundelIndices[u]];a=h.view.offset,l=P.UNKNOWN;for(var c=0;c<h.attributes.length;c++){var f=h.attributes[c];if(f.name===q.ATTR_TEX_COORD){l=f.format;break}a+=C[f.format].size}if(l)break}if(void 0===r[u]){r[u]=[l,a];var p=i.vertexBundles[u];p.attributes.push(vn),p.attributes.push(bn),p.view.offset=0,p.view.length+=p.view.count*kn,p.view.stride+=kn}}for(var d=0,_=0;_<i.vertexBundles.length;_++)d+=i.vertexBundles[_].view.length;for(var m=0;m<i.primitives.length;m++){var g=i.primitives[m];g.indexView&&(g.indexView.offset=d,d+=g.indexView.length)}var y=new Uint8Array(d),v=e.data,b=new DataView(y.buffer),k=new DataView(v.buffer),w=n.sys.isLittleEndian;for(var T in r)for(var S=i.vertexBundles[T],A=e.struct.vertexBundles[T],M=r[T],x=M[0],I=M[1],O=wt(k,x,I,A.view.length,A.view.stride),B=A.view,N=S.view,j=B.stride,z=N.stride,E=B.offset,D=N.offset,R=0;R<N.count;R++){var L=v.subarray(E,E+j);y.set(L,D),b.setFloat32(D+j,t),b.setFloat32(D+j+4,O[2*R],w),b.setFloat32(D+j+8,O[2*R+1],w),D+=z,E+=j}for(var U=0;U<i.primitives.length;U++){var F=e.struct.primitives[U],H=i.primitives[U];if(F.indexView&&H.indexView)for(var W=F.indexView.stride,V=H.indexView.stride,K=F.indexView.offset,G=H.indexView.offset,J=0;J<H.indexView.count;J++){var Y=v.subarray(K,K+W);y.set(Y,G),G+=V,K+=W}}var X=new xt;return X.reset({struct:i,data:y}),X},l(i,[{key:"mesh",get:function(){return t.prototype.mesh},set:function(t){this.mesh=t}},{key:"skeleton",get:function(){return t.prototype.skeleton},set:function(t){this.skeleton=t}}]),i}(yn),on=u((rn=ln).prototype,"atlasSize",[_,qi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),sn=u(rn.prototype,"batchableTextureNames",[Xi,_,Zi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),an=u(rn.prototype,"units",[Qi,_,$i],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),u(rn.prototype,"mesh",[et,tn],Object.getOwnPropertyDescriptor(rn.prototype,"mesh"),rn.prototype),u(rn.prototype,"skeleton",[et,en],Object.getOwnPropertyDescriptor(rn.prototype,"skeleton"),rn.prototype),nn=rn))||nn)||nn)||nn)||nn)||nn));n.SkinningModelComponent=yn,r.setClassAlias(yn,"cc.SkinningModelComponent"),n.SkinningModelUnit=wn,r.setClassAlias(wn,"cc.SkinningModelUnit"),n.BatchedSkinningModelComponent=An,r.setClassAlias(An,"cc.BatchedSkinningModelComponent");var Mn,xn,In,On,Bn,Cn,Nn,Pn,jn,zn,En,Dn,Rn,Ln,Un,Fn,Hn,Wn,Vn,Kn,Gn=new e,Jn=new e,Yn=[],qn=t("e",function(t){function i(e,i){var r;return void 0===i&&(i=""),(r=t.call(this,e,i)||this)._frames=1,r._bakedDuration=0,r._animInfo=null,r._sockets=[],r._animInfoMgr=void 0,r._comps=[],r._parent=null,r._curvesInited=!1,r._animInfoMgr=n.director.root.dataPoolManager.jointAnimationInfo,r}f(i,t);var r=i.prototype;return r.initialize=function(e){if(!this._curveLoaded){this._comps.length=0;for(var i=e.getComponentsInChildren(yn),n=0;n<i.length;++n){var r=i[n];r.skinningRoot===e&&this._comps.push(r)}this._parent=e.getComponent("cc.SkeletalAnimation");var o=this._parent.useBakedAnimation;t.prototype.initialize.call(this,e,o?Yn:void 0),this._curvesInited=!o;var s=_t.getOrExtract(this.clip).info;this._frames=s.frames-1,this._animInfo=this._animInfoMgr.getData(e.uuid),this._bakedDuration=this._frames/s.sample}},r.onPlay=function(){if(t.prototype.onPlay.call(this),this._parent.useBakedAnimation){this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration,this._animInfoMgr.switchClip(this._animInfo,this.clip);for(var e=0;e<this._comps.length;++e)this._comps[e].uploadAnimation(this.clip)}else this._sampleCurves=t.prototype._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,t.prototype.initialize.call(this,this._targetNode),this._curvesInited=!0)},r.rebuildSocketCurves=function(t){if(this._sockets.length=0,this._targetNode)for(var i=this._targetNode,n=0;n<t.length;++n){var r=t[n],o=i.getChildByPath(r.path);if(r.target){for(var a=_t.getOrExtract(this.clip),l=r.path,u=a.data[l],h=o,c=void 0;!u;){var f=l.lastIndexOf("/");if(l=l.substring(0,f),u=a.data[l],h&&(c||(c=e.identity(Jn)),e.fromRTS(Gn,h.rotation,h.position,h.scale),e.multiply(c,Gn,c),h=h.parent),f<0)break}for(var p=u&&u.worldMatrix.values,d=a.info.frames,_=[],m=0;m<d;m++){var g;g=p&&c?e.multiply(Gn,p[m],c):p?p[m]:c||e.IDENTITY;var y={pos:new s,rot:new M,scale:new s};e.toRTS(g,y.rot,y.pos,y.scale),_.push(y)}this._sockets.push({target:r.target,frames:_})}}},r._sampleCurvesBaked=function(t){var e=this._animInfo,i=t*this._frames+.5|0;if(i!==e.data[0]){e.data[0]=i,e.dirty=!0;for(var n=0;n<this._sockets.length;++n){var r=this._sockets[n],o=r.target,s=r.frames[i],a=s.pos,l=s.rot,u=s.scale;o.setRTS(l,a,u)}}},i}(vt)),Xn=t("f",(Mn=a("cc.SkeletalAnimation.Socket"),xn=c(G),Mn((Bn=u((On=function(t,e){void 0===t&&(t=""),void 0===e&&(e=null),d(this,"path",Bn,this),d(this,"target",Cn,this),this.path=t,this.target=e}).prototype,"path",[_,h],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Cn=u(On.prototype,"target",[xn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),In=On))||In));r.setClassAlias(Xn,"cc.SkeletalAnimationComponent.Socket");var Zn=new e,Qn=new e;function $n(t,e,i){void 0===e&&(e=""),void 0===i&&(i=[]);for(var n=0;n<t.children.length;n++){var r=t.children[n];if(r){var o=e?e+"/"+r.name:r.name;i.push(o),$n(r,o,i)}}return i}var tr=t("g",(Nn=a("cc.SkeletalAnimation"),Pn=w(),jn=J(99),zn=T(),En=c([Xn]),Dn=m(),Rn=m(),Ln=c([Xn]),Nn(Un=Pn(Un=jn(Un=k(Un=zn((Kn=Vn=function(t){function i(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return e=t.call.apply(t,[this].concat(n))||this,d(e,"_useBakedAnimation",Hn,y(e)),d(e,"_sockets",Wn,y(e)),e}f(i,t);var r=i.prototype;return r.onDestroy=function(){t.prototype.onDestroy.call(this),n.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),n.director.getAnimationManager().removeSockets(this.node,this._sockets)},r.start=function(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,t.prototype.start.call(this)},r.querySockets=function(){var t=this._defaultClip&&Object.keys(_t.getOrExtract(this._defaultClip).data).sort().reduce((function(t,e){return e.startsWith(t[t.length-1])||t.push(e),t}),[])||[];if(!t.length)return["please specify a valid default animation clip first"];for(var e=[],i=0;i<t.length;i++){var n=t[i],r=this.node.getChildByPath(n);r&&(e.push(n),$n(r,n,e))}return e},r.rebuildSocketAnimations=function(){for(var t,i=R(this._sockets);!(t=i()).done;){var n=t.value,r=this.node.getChildByPath(n.path),o=n.target;r&&o&&(o.name=n.path.substring(n.path.lastIndexOf("/")+1)+" Socket",o.parent=this.node,dt(r,this.node,Zn),e.fromRTS(Qn,o.rotation,o.position,o.scale),e.equals(Qn,Zn)||(o.matrix=Zn))}for(var s=0,a=Object.keys(this._nameToState);s<a.length;s++){var l=a[s];this._nameToState[l].rebuildSocketCurves(this._sockets)}},r.createSocket=function(t){var e=this._sockets.find((function(e){return e.path===t}));if(e)return e.target;if(!this.node.getChildByPath(t))return console.warn("illegal socket path"),null;var i=new G;return i.parent=this.node,this._sockets.push(new Xn(t,i)),this.rebuildSocketAnimations(),i},r._createState=function(t,e){return new qn(t,e)},r._doCreateState=function(e,i){var n=t.prototype._doCreateState.call(this,e,i);return n.rebuildSocketCurves(this._sockets),n},l(i,[{key:"sockets",get:function(){return this._sockets},set:function(t){if(!this._useBakedAnimation){var e=n.director.getAnimationManager();e.removeSockets(this.node,this._sockets),e.addSockets(this.node,t)}this._sockets=t,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(t){this._useBakedAnimation=t;for(var e=this.node.getComponentsInChildren(yn),i=0;i<e.length;++i){var r=e[i];r.skinningRoot===this.node&&r.setUseBakedAnimation(this._useBakedAnimation)}this._useBakedAnimation?n.director.getAnimationManager().removeSockets(this.node,this._sockets):n.director.getAnimationManager().addSockets(this.node,this._sockets)}}]),i}(bt),Vn.Socket=Xn,u((Fn=Kn).prototype,"sockets",[En,Dn],Object.getOwnPropertyDescriptor(Fn.prototype,"sockets"),Fn.prototype),u(Fn.prototype,"useBakedAnimation",[Rn],Object.getOwnPropertyDescriptor(Fn.prototype,"useBakedAnimation"),Fn.prototype),Hn=u(Fn.prototype,"_useBakedAnimation",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Wn=u(Fn.prototype,"_sockets",[Ln],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Un=Fn))||Un)||Un)||Un)||Un)||Un));n.SkeletalAnimationComponent=tr,r.setClassAlias(tr,"cc.SkeletalAnimationComponent"),n.utils=Qt}}}));
