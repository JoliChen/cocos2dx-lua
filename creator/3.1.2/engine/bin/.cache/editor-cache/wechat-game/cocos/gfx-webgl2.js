System.register(["./fog-01fb8507.js","./screen-3553948d.js","./webgl-define-f890b6ea.js"],(function(e){"use strict";var t,r,s,a,n,i,u,l,_,c,o,f,h,d,g,R,A,T,E,p,S,B,m,C,x,b,F,I,P,G,O,M,v,D,L,U,N,y,w,k,H,V,X,W,z,K,Y,q,Z,j,Q,J,$,ee,te,re,se,ae,ne,ie,ue,le,_e,ce,oe,fe,he;return{setters:[function(e){t=e.ev,r=e.b3,s=e.b4,a=e.ew,n=e.D,i=e.x,u=e.af,l=e.a_,_=e.ar,c=e.G,o=e.z,f=e.H,h=e.f,d=e.b8,g=e.J,R=e.b2,A=e.K,T=e.L,E=e.e,p=e.Z,S=e.X,B=e.a5,m=e.a6,C=e.T,x=e.Y,b=e.C,F=e.at,I=e.B,P=e.a7,G=e.aa,O=e.u,M=e.bd,v=e.be,D=e.b5,L=e.bf,U=e.bg,N=e.bm,y=e.bn,w=e.bo,k=e.bp,H=e.bq,V=e.am,X=e.bh,W=e.bi,z=e.bk,K=e.b7,Y=e.b9,q=e.br,Z=e.eh,j=e.A,Q=e.t,J=e.F,$=e.aW,ee=e.a9,te=e.aV,re=e.au,se=e.I,ae=e.bs,ne=e.bt,ie=e.bb,ue=e.d,le=e.w,_e=e.ao,ce=e.al,oe=e.bc,fe=e.l},function(){},function(e){he=e.W}],execute:function(){var de=function(e){function n(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSet=null,t}t(n,e);var i=n.prototype;return i.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,r=t.bindings,s=t.descriptorIndices,a=t.descriptorCount;this._buffers=Array(a).fill(null),this._textures=Array(a).fill(null),this._samplers=Array(a).fill(null);var n=[];this._gpuDescriptorSet={gpuDescriptors:n,descriptorIndices:s};for(var i=0;i<r.length;++i)for(var u=r[i],l=0;l<u.count;l++)n.push({type:u.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null});return!0},i.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},i.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)e[t].type&r?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&s&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},a(n,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),n}(n),ge=[10497,33648,33071,33071],Re=[1,2,4,8,16,32,64],Ae=new Float32Array(4);function Te(e,t){switch(e){case i.R8:return t.UNSIGNED_BYTE;case i.R8SN:return t.BYTE;case i.R8UI:return t.UNSIGNED_BYTE;case i.R8I:return t.BYTE;case i.R16F:return t.HALF_FLOAT;case i.R16UI:return t.UNSIGNED_SHORT;case i.R16I:return t.SHORT;case i.R32F:return t.FLOAT;case i.R32UI:return t.UNSIGNED_INT;case i.R32I:return t.INT;case i.RG8:return t.UNSIGNED_BYTE;case i.RG8SN:return t.BYTE;case i.RG8UI:return t.UNSIGNED_BYTE;case i.RG8I:return t.BYTE;case i.RG16F:return t.HALF_FLOAT;case i.RG16UI:return t.UNSIGNED_SHORT;case i.RG16I:return t.SHORT;case i.RG32F:return t.FLOAT;case i.RG32UI:return t.UNSIGNED_INT;case i.RG32I:return t.INT;case i.RGB8:case i.SRGB8:return t.UNSIGNED_BYTE;case i.RGB8SN:return t.BYTE;case i.RGB8UI:return t.UNSIGNED_BYTE;case i.RGB8I:return t.BYTE;case i.RGB16F:return t.HALF_FLOAT;case i.RGB16UI:return t.UNSIGNED_SHORT;case i.RGB16I:return t.SHORT;case i.RGB32F:return t.FLOAT;case i.RGB32UI:return t.UNSIGNED_INT;case i.RGB32I:return t.INT;case i.BGRA8:case i.RGBA8:case i.SRGB8_A8:return t.UNSIGNED_BYTE;case i.RGBA8SN:return t.BYTE;case i.RGBA8UI:return t.UNSIGNED_BYTE;case i.RGBA8I:return t.BYTE;case i.RGBA16F:return t.HALF_FLOAT;case i.RGBA16UI:return t.UNSIGNED_SHORT;case i.RGBA16I:return t.SHORT;case i.RGBA32F:return t.FLOAT;case i.RGBA32UI:return t.UNSIGNED_INT;case i.RGBA32I:return t.INT;case i.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case i.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case i.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case i.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case i.RGB10A2:case i.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case i.RGB9E5:return t.FLOAT;case i.D16:return t.UNSIGNED_SHORT;case i.D16S8:return t.UNSIGNED_INT_24_8;case i.D24:return t.UNSIGNED_INT;case i.D24S8:return t.UNSIGNED_INT_24_8;case i.D32F:return t.FLOAT;case i.D32F_S8:return t.FLOAT_32_UNSIGNED_INT_24_8_REV;case i.BC1:case i.BC1_SRGB:case i.BC2:case i.BC2_SRGB:case i.BC3:case i.BC3_SRGB:case i.BC4:return t.UNSIGNED_BYTE;case i.BC4_SNORM:return t.BYTE;case i.BC5:return t.UNSIGNED_BYTE;case i.BC5_SNORM:return t.BYTE;case i.BC6H_SF16:case i.BC6H_UF16:return t.FLOAT;case i.BC7:case i.BC7_SRGB:case i.ETC_RGB8:case i.ETC2_RGB8:case i.ETC2_SRGB8:case i.ETC2_RGB8_A1:case i.ETC2_SRGB8_A1:case i.EAC_R11:return t.UNSIGNED_BYTE;case i.EAC_R11SN:return t.BYTE;case i.EAC_RG11:return t.UNSIGNED_BYTE;case i.EAC_RG11SN:return t.BYTE;case i.PVRTC_RGB2:case i.PVRTC_RGBA2:case i.PVRTC_RGB4:case i.PVRTC_RGBA4:case i.PVRTC2_2BPP:case i.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case i.ASTC_RGBA_4x4:case i.ASTC_RGBA_5x4:case i.ASTC_RGBA_5x5:case i.ASTC_RGBA_6x5:case i.ASTC_RGBA_6x6:case i.ASTC_RGBA_8x5:case i.ASTC_RGBA_8x6:case i.ASTC_RGBA_8x8:case i.ASTC_RGBA_10x5:case i.ASTC_RGBA_10x6:case i.ASTC_RGBA_10x8:case i.ASTC_RGBA_10x10:case i.ASTC_RGBA_12x10:case i.ASTC_RGBA_12x12:case i.ASTC_SRGBA_4x4:case i.ASTC_SRGBA_5x4:case i.ASTC_SRGBA_5x5:case i.ASTC_SRGBA_6x5:case i.ASTC_SRGBA_6x6:case i.ASTC_SRGBA_8x5:case i.ASTC_SRGBA_8x6:case i.ASTC_SRGBA_8x8:case i.ASTC_SRGBA_10x5:case i.ASTC_SRGBA_10x6:case i.ASTC_SRGBA_10x8:case i.ASTC_SRGBA_10x10:case i.ASTC_SRGBA_12x10:case i.ASTC_SRGBA_12x12:default:return t.UNSIGNED_BYTE}}function Ee(e,t){switch(e){case i.A8:return t.ALPHA;case i.L8:return t.LUMINANCE;case i.LA8:return t.LUMINANCE_ALPHA;case i.R8:return t.R8;case i.R8SN:return t.R8_SNORM;case i.R8UI:return t.R8UI;case i.R8I:return t.R8I;case i.RG8:return t.RG8;case i.RG8SN:return t.RG8_SNORM;case i.RG8UI:return t.RG8UI;case i.RG8I:return t.RG8I;case i.RGB8:return t.RGB8;case i.RGB8SN:return t.RGB8_SNORM;case i.RGB8UI:return t.RGB8UI;case i.RGB8I:return t.RGB8I;case i.BGRA8:case i.RGBA8:return t.RGBA8;case i.RGBA8SN:return t.RGBA8_SNORM;case i.RGBA8UI:return t.RGBA8UI;case i.RGBA8I:return t.RGBA8I;case i.R16I:return t.R16I;case i.R16UI:return t.R16UI;case i.R16F:return t.R16F;case i.RG16I:return t.RG16I;case i.RG16UI:return t.RG16UI;case i.RG16F:return t.RG16F;case i.RGB16I:return t.RGB16I;case i.RGB16UI:return t.RGB16UI;case i.RGB16F:return t.RGB16F;case i.RGBA16I:return t.RGBA16I;case i.RGBA16UI:return t.RGBA16UI;case i.RGBA16F:return t.RGBA16F;case i.R32I:return t.R32I;case i.R32UI:return t.R32UI;case i.R32F:return t.R32F;case i.RG32I:return t.RG32I;case i.RG32UI:return t.RG32UI;case i.RG32F:return t.RG32F;case i.RGB32I:return t.RGB32I;case i.RGB32UI:return t.RGB32UI;case i.RGB32F:return t.RGB32F;case i.RGBA32I:return t.RGBA32I;case i.RGBA32UI:return t.RGBA32UI;case i.RGBA32F:return t.RGBA32F;case i.R5G6B5:return t.RGB565;case i.RGB5A1:return t.RGB5_A1;case i.RGBA4:return t.RGBA4;case i.RGB10A2:return t.RGB10_A2;case i.RGB10A2UI:return t.RGB10_A2UI;case i.R11G11B10F:return t.R11F_G11F_B10F;case i.D16:return t.DEPTH_COMPONENT16;case i.D16S8:return t.DEPTH24_STENCIL8;case i.D24:return t.DEPTH_COMPONENT24;case i.D24S8:return t.DEPTH24_STENCIL8;case i.D32F:return t.DEPTH_COMPONENT32F;case i.D32F_S8:return t.DEPTH32F_STENCIL8;case i.BC1:return he.COMPRESSED_RGB_S3TC_DXT1_EXT;case i.BC1_ALPHA:return he.COMPRESSED_RGBA_S3TC_DXT1_EXT;case i.BC1_SRGB:return he.COMPRESSED_SRGB_S3TC_DXT1_EXT;case i.BC1_SRGB_ALPHA:return he.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case i.BC2:return he.COMPRESSED_RGBA_S3TC_DXT3_EXT;case i.BC2_SRGB:return he.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case i.BC3:return he.COMPRESSED_RGBA_S3TC_DXT5_EXT;case i.BC3_SRGB:return he.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case i.ETC_RGB8:return he.COMPRESSED_RGB_ETC1_WEBGL;case i.ETC2_RGB8:return he.COMPRESSED_RGB8_ETC2;case i.ETC2_SRGB8:return he.COMPRESSED_SRGB8_ETC2;case i.ETC2_RGB8_A1:return he.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case i.ETC2_SRGB8_A1:return he.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case i.ETC2_RGBA8:return he.COMPRESSED_RGBA8_ETC2_EAC;case i.ETC2_SRGB8_A8:return he.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case i.EAC_R11:return he.COMPRESSED_R11_EAC;case i.EAC_R11SN:return he.COMPRESSED_SIGNED_R11_EAC;case i.EAC_RG11:return he.COMPRESSED_RG11_EAC;case i.EAC_RG11SN:return he.COMPRESSED_SIGNED_RG11_EAC;case i.PVRTC_RGB2:return he.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case i.PVRTC_RGBA2:return he.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case i.PVRTC_RGB4:return he.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case i.PVRTC_RGBA4:return he.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case i.ASTC_RGBA_4x4:return he.COMPRESSED_RGBA_ASTC_4x4_KHR;case i.ASTC_RGBA_5x4:return he.COMPRESSED_RGBA_ASTC_5x4_KHR;case i.ASTC_RGBA_5x5:return he.COMPRESSED_RGBA_ASTC_5x5_KHR;case i.ASTC_RGBA_6x5:return he.COMPRESSED_RGBA_ASTC_6x5_KHR;case i.ASTC_RGBA_6x6:return he.COMPRESSED_RGBA_ASTC_6x6_KHR;case i.ASTC_RGBA_8x5:return he.COMPRESSED_RGBA_ASTC_8x5_KHR;case i.ASTC_RGBA_8x6:return he.COMPRESSED_RGBA_ASTC_8x6_KHR;case i.ASTC_RGBA_8x8:return he.COMPRESSED_RGBA_ASTC_8x8_KHR;case i.ASTC_RGBA_10x5:return he.COMPRESSED_RGBA_ASTC_10x5_KHR;case i.ASTC_RGBA_10x6:return he.COMPRESSED_RGBA_ASTC_10x6_KHR;case i.ASTC_RGBA_10x8:return he.COMPRESSED_RGBA_ASTC_10x8_KHR;case i.ASTC_RGBA_10x10:return he.COMPRESSED_RGBA_ASTC_10x10_KHR;case i.ASTC_RGBA_12x10:return he.COMPRESSED_RGBA_ASTC_12x10_KHR;case i.ASTC_RGBA_12x12:return he.COMPRESSED_RGBA_ASTC_12x12_KHR;case i.ASTC_SRGBA_4x4:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case i.ASTC_SRGBA_5x4:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case i.ASTC_SRGBA_5x5:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case i.ASTC_SRGBA_6x5:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case i.ASTC_SRGBA_6x6:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case i.ASTC_SRGBA_8x5:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case i.ASTC_SRGBA_8x6:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case i.ASTC_SRGBA_8x8:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case i.ASTC_SRGBA_10x5:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case i.ASTC_SRGBA_10x6:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case i.ASTC_SRGBA_10x8:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case i.ASTC_SRGBA_10x10:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case i.ASTC_SRGBA_12x10:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case i.ASTC_SRGBA_12x12:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}function pe(e,t){switch(e){case i.A8:return t.ALPHA;case i.L8:return t.LUMINANCE;case i.LA8:return t.LUMINANCE_ALPHA;case i.R8:case i.R8SN:return t.RED;case i.R8UI:case i.R8I:return t.RED;case i.RG8:case i.RG8SN:case i.RG8UI:case i.RG8I:return t.RG;case i.RGB8:case i.RGB8SN:case i.RGB8UI:case i.RGB8I:return t.RGB;case i.BGRA8:case i.RGBA8:case i.RGBA8SN:case i.RGBA8UI:case i.RGBA8I:return t.RGBA;case i.R16UI:case i.R16I:case i.R16F:return t.RED;case i.RG16UI:case i.RG16I:case i.RG16F:return t.RG;case i.RGB16UI:case i.RGB16I:case i.RGB16F:return t.RGB;case i.RGBA16UI:case i.RGBA16I:case i.RGBA16F:return t.RGBA;case i.R32UI:case i.R32I:case i.R32F:return t.RED;case i.RG32UI:case i.RG32I:case i.RG32F:return t.RG;case i.RGB32UI:case i.RGB32I:case i.RGB32F:return t.RGB;case i.RGBA32UI:case i.RGBA32I:case i.RGBA32F:case i.RGB10A2:return t.RGBA;case i.R11G11B10F:case i.R5G6B5:return t.RGB;case i.RGB5A1:case i.RGBA4:return t.RGBA;case i.D16:return t.DEPTH_COMPONENT;case i.D16S8:return t.DEPTH_STENCIL;case i.D24:return t.DEPTH_COMPONENT;case i.D24S8:return t.DEPTH_STENCIL;case i.D32F:return t.DEPTH_COMPONENT;case i.D32F_S8:return t.DEPTH_STENCIL;case i.BC1:return he.COMPRESSED_RGB_S3TC_DXT1_EXT;case i.BC1_ALPHA:return he.COMPRESSED_RGBA_S3TC_DXT1_EXT;case i.BC1_SRGB:return he.COMPRESSED_SRGB_S3TC_DXT1_EXT;case i.BC1_SRGB_ALPHA:return he.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case i.BC2:return he.COMPRESSED_RGBA_S3TC_DXT3_EXT;case i.BC2_SRGB:return he.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case i.BC3:return he.COMPRESSED_RGBA_S3TC_DXT5_EXT;case i.BC3_SRGB:return he.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case i.ETC_RGB8:return he.COMPRESSED_RGB_ETC1_WEBGL;case i.ETC2_RGB8:return he.COMPRESSED_RGB8_ETC2;case i.ETC2_SRGB8:return he.COMPRESSED_SRGB8_ETC2;case i.ETC2_RGB8_A1:return he.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case i.ETC2_SRGB8_A1:return he.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case i.ETC2_RGBA8:return he.COMPRESSED_RGBA8_ETC2_EAC;case i.ETC2_SRGB8_A8:return he.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case i.EAC_R11:return he.COMPRESSED_R11_EAC;case i.EAC_R11SN:return he.COMPRESSED_SIGNED_R11_EAC;case i.EAC_RG11:return he.COMPRESSED_RG11_EAC;case i.EAC_RG11SN:return he.COMPRESSED_SIGNED_RG11_EAC;case i.PVRTC_RGB2:return he.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case i.PVRTC_RGBA2:return he.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case i.PVRTC_RGB4:return he.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case i.PVRTC_RGBA4:return he.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case i.ASTC_RGBA_4x4:return he.COMPRESSED_RGBA_ASTC_4x4_KHR;case i.ASTC_RGBA_5x4:return he.COMPRESSED_RGBA_ASTC_5x4_KHR;case i.ASTC_RGBA_5x5:return he.COMPRESSED_RGBA_ASTC_5x5_KHR;case i.ASTC_RGBA_6x5:return he.COMPRESSED_RGBA_ASTC_6x5_KHR;case i.ASTC_RGBA_6x6:return he.COMPRESSED_RGBA_ASTC_6x6_KHR;case i.ASTC_RGBA_8x5:return he.COMPRESSED_RGBA_ASTC_8x5_KHR;case i.ASTC_RGBA_8x6:return he.COMPRESSED_RGBA_ASTC_8x6_KHR;case i.ASTC_RGBA_8x8:return he.COMPRESSED_RGBA_ASTC_8x8_KHR;case i.ASTC_RGBA_10x5:return he.COMPRESSED_RGBA_ASTC_10x5_KHR;case i.ASTC_RGBA_10x6:return he.COMPRESSED_RGBA_ASTC_10x6_KHR;case i.ASTC_RGBA_10x8:return he.COMPRESSED_RGBA_ASTC_10x8_KHR;case i.ASTC_RGBA_10x10:return he.COMPRESSED_RGBA_ASTC_10x10_KHR;case i.ASTC_RGBA_12x10:return he.COMPRESSED_RGBA_ASTC_12x10_KHR;case i.ASTC_RGBA_12x12:return he.COMPRESSED_RGBA_ASTC_12x12_KHR;case i.ASTC_SRGBA_4x4:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case i.ASTC_SRGBA_5x4:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case i.ASTC_SRGBA_5x5:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case i.ASTC_SRGBA_6x5:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case i.ASTC_SRGBA_6x6:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case i.ASTC_SRGBA_8x5:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case i.ASTC_SRGBA_8x6:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case i.ASTC_SRGBA_8x8:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case i.ASTC_SRGBA_10x5:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case i.ASTC_SRGBA_10x6:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case i.ASTC_SRGBA_10x8:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case i.ASTC_SRGBA_10x10:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case i.ASTC_SRGBA_12x10:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case i.ASTC_SRGBA_12x12:return he.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}function Se(e,t){switch(e){case C.BOOL:return t.BOOL;case C.BOOL2:return t.BOOL_VEC2;case C.BOOL3:return t.BOOL_VEC3;case C.BOOL4:return t.BOOL_VEC4;case C.INT:return t.INT;case C.INT2:return t.INT_VEC2;case C.INT3:return t.INT_VEC3;case C.INT4:return t.INT_VEC4;case C.UINT:return t.UNSIGNED_INT;case C.FLOAT:return t.FLOAT;case C.FLOAT2:return t.FLOAT_VEC2;case C.FLOAT3:return t.FLOAT_VEC3;case C.FLOAT4:return t.FLOAT_VEC4;case C.MAT2:return t.FLOAT_MAT2;case C.MAT2X3:return t.FLOAT_MAT2x3;case C.MAT2X4:return t.FLOAT_MAT2x4;case C.MAT3X2:return t.FLOAT_MAT3x2;case C.MAT3:return t.FLOAT_MAT3;case C.MAT3X4:return t.FLOAT_MAT3x4;case C.MAT4X2:return t.FLOAT_MAT4x2;case C.MAT4X3:return t.FLOAT_MAT4x3;case C.MAT4:return t.FLOAT_MAT4;case C.SAMPLER2D:return t.SAMPLER_2D;case C.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case C.SAMPLER3D:return t.SAMPLER_3D;case C.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),C.UNKNOWN}}function Be(e,t){switch(e){case t.BOOL:return C.BOOL;case t.BOOL_VEC2:return C.BOOL2;case t.BOOL_VEC3:return C.BOOL3;case t.BOOL_VEC4:return C.BOOL4;case t.INT:return C.INT;case t.INT_VEC2:return C.INT2;case t.INT_VEC3:return C.INT3;case t.INT_VEC4:return C.INT4;case t.UNSIGNED_INT:return C.UINT;case t.UNSIGNED_INT_VEC2:return C.UINT2;case t.UNSIGNED_INT_VEC3:return C.UINT3;case t.UNSIGNED_INT_VEC4:return C.UINT4;case t.FLOAT:return C.FLOAT;case t.FLOAT_VEC2:return C.FLOAT2;case t.FLOAT_VEC3:return C.FLOAT3;case t.FLOAT_VEC4:return C.FLOAT4;case t.FLOAT_MAT2:return C.MAT2;case t.FLOAT_MAT2x3:return C.MAT2X3;case t.FLOAT_MAT2x4:return C.MAT2X4;case t.FLOAT_MAT3x2:return C.MAT3X2;case t.FLOAT_MAT3:return C.MAT3;case t.FLOAT_MAT3x4:return C.MAT3X4;case t.FLOAT_MAT4x2:return C.MAT4X2;case t.FLOAT_MAT4x3:return C.MAT4X3;case t.FLOAT_MAT4:return C.MAT4;case t.SAMPLER_2D:return C.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return C.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return C.SAMPLER3D;case t.SAMPLER_CUBE:return C.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),C.UNKNOWN}}function me(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function Ce(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var xe,be=[512,513,514,515,516,517,518,519],Fe=[0,7680,7681,7682,7683,5386,34055,34056],Ie=[32774,32778,32779,32775,32776],Pe=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(xe||(xe={}));var Ge=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},Oe=function(e){function r(){var t;return(t=e.call(this,xe.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new u,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return t(r,e),r.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},r}(Ge),Me=function(e){function r(){var t;return(t=e.call(this,xe.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new l,t}return t(r,e),r.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0},r}(Ge),ve=function(e){function r(){var t;return(t=e.call(this,xe.DRAW)||this).drawInfo=new _,t}return t(r,e),r.prototype.clear=function(){},r}(Ge),De=function(e){function r(){var t;return(t=e.call(this,xe.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return t(r,e),r.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},r}(Ge),Le=function(e){function r(){var t;return(t=e.call(this,xe.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return t(r,e),r.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},r}(Ge),Ue=function(){function e(){this.cmds=new b(1),this.beginRenderPassCmds=new b(1),this.bindStatesCmds=new b(1),this.drawCmds=new b(1),this.updateBufferCmds=new b(1),this.copyBufferToTextureCmds=new b(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function Ne(e,t,r,s,a){if(t.usage&o.INDIRECT)t.indirects.length=s,Array.prototype.push.apply(t.indirects,r.drawInfos);else{var n=r,i=e.gl,u=e.stateCache;switch(t.glTarget){case i.ARRAY_BUFFER:u.glVAO&&(i.bindVertexArray(null),u.glVAO=ye.gpuInputAssembler=null),u.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),u.glArrayBuffer=t.glBuffer),a===n.byteLength?i.bufferSubData(t.glTarget,s,n):i.bufferSubData(t.glTarget,s,n.slice(0,a));break;case i.ELEMENT_ARRAY_BUFFER:u.glVAO&&(i.bindVertexArray(null),u.glVAO=ye.gpuInputAssembler=null),u.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),u.glElementArrayBuffer=t.glBuffer),a===n.byteLength?i.bufferSubData(t.glTarget,s,n):i.bufferSubData(t.glTarget,s,n.slice(0,a));break;case i.UNIFORM_BUFFER:u.glUniformBuffer!==t.glBuffer&&(i.bindBuffer(i.UNIFORM_BUFFER,t.glBuffer),u.glUniformBuffer=t.glBuffer),a===n.byteLength?i.bufferSubData(t.glTarget,s,n):i.bufferSubData(t.glTarget,s,new Float32Array(n,0,a/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}var ye={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function we(e,t,r,s,a,n,u){var l=e.gl,_=e.stateCache,c=0;if(r&&t){_.glFramebuffer!==r.glFramebuffer&&(l.bindFramebuffer(l.FRAMEBUFFER,r.glFramebuffer),_.glFramebuffer=r.glFramebuffer),_.viewport.left===s.x&&_.viewport.top===s.y&&_.viewport.width===s.width&&_.viewport.height===s.height||(l.viewport(s.x,s.y,s.width,s.height),_.viewport.left=s.x,_.viewport.top=s.y,_.viewport.width=s.width,_.viewport.height=s.height),_.scissorRect.x===s.x&&_.scissorRect.y===s.y&&_.scissorRect.width===s.width&&_.scissorRect.height===s.height||(l.scissor(s.x,s.y,s.width,s.height),_.scissorRect.x=s.x,_.scissorRect.y=s.y,_.scissorRect.width=s.width,_.scissorRect.height=s.height),ye.invalidateAttachments.length=0;for(var o=0;o<a.length;++o){var f=t.colorAttachments[o];if(f.format!==i.UNKNOWN)switch(f.loadOp){case p.LOAD:break;case p.CLEAR:if(_.bs.targets[0].blendColorMask!==S.ALL&&l.colorMask(!0,!0,!0,!0),r.isOffscreen)Ae[0]=a[o].x,Ae[1]=a[o].y,Ae[2]=a[o].z,Ae[3]=a[o].w,l.clearBufferfv(l.COLOR,o,Ae);else{var h=a[0];l.clearColor(h.x,h.y,h.z,h.w),c|=l.COLOR_BUFFER_BIT}break;case p.DISCARD:ye.invalidateAttachments.push(l.COLOR_ATTACHMENT0+o)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==i.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case p.LOAD:break;case p.CLEAR:_.dss.depthWrite||l.depthMask(!0),l.clearDepth(n),c|=l.DEPTH_BUFFER_BIT;break;case p.DISCARD:ye.invalidateAttachments.push(l.DEPTH_ATTACHMENT)}if(R[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case p.LOAD:break;case p.CLEAR:_.dss.stencilWriteMaskFront||l.stencilMaskSeparate(l.FRONT,65535),_.dss.stencilWriteMaskBack||l.stencilMaskSeparate(l.BACK,65535),l.clearStencil(u),c|=l.STENCIL_BUFFER_BIT;break;case p.DISCARD:ye.invalidateAttachments.push(l.STENCIL_ATTACHMENT)}}if(r.glFramebuffer&&ye.invalidateAttachments.length&&l.invalidateFramebuffer(l.FRAMEBUFFER,ye.invalidateAttachments),c&&l.clear(c),c&l.COLOR_BUFFER_BIT){var d=_.bs.targets[0].blendColorMask;if(d!==S.ALL){var g=(d&S.R)!==S.NONE,A=(d&S.G)!==S.NONE,T=(d&S.B)!==S.NONE,E=(d&S.A)!==S.NONE;l.colorMask(g,A,T,E)}}c&l.DEPTH_BUFFER_BIT&&!_.dss.depthWrite&&l.depthMask(!1),c&l.STENCIL_BUFFER_BIT&&(_.dss.stencilWriteMaskFront||l.stencilMaskSeparate(l.FRONT,0),_.dss.stencilWriteMaskBack||l.stencilMaskSeparate(l.BACK,0))}}function ke(e,t,r,s,a,n){var i=e.gl,u=e.stateCache,l=t&&t.gpuShader,_=!1;if(t&&ye.gpuPipelineState!==t){if(ye.gpuPipelineState=t,ye.glPrimitive=t.glPrimitive,l){var c=l.glProgram;u.glProgram!==c&&(i.useProgram(c),u.glProgram=c,_=!0)}var o=t.rs;if(o){if(u.rs.cullMode!==o.cullMode){switch(o.cullMode){case B.NONE:i.disable(i.CULL_FACE);break;case B.FRONT:i.enable(i.CULL_FACE),i.cullFace(i.FRONT);break;case B.BACK:i.enable(i.CULL_FACE),i.cullFace(i.BACK)}e.stateCache.rs.cullMode=o.cullMode}var f=o.isFrontFaceCCW;e.stateCache.rs.isFrontFaceCCW!==f&&(i.frontFace(f?i.CCW:i.CW),e.stateCache.rs.isFrontFaceCCW=f),e.stateCache.rs.depthBias===o.depthBias&&e.stateCache.rs.depthBiasSlop===o.depthBiasSlop||(i.polygonOffset(o.depthBias,o.depthBiasSlop),e.stateCache.rs.depthBias=o.depthBias,e.stateCache.rs.depthBiasSlop=o.depthBiasSlop),e.stateCache.rs.lineWidth!==o.lineWidth&&(i.lineWidth(o.lineWidth),e.stateCache.rs.lineWidth=o.lineWidth)}var h=t.dss;h&&(u.dss.depthTest!==h.depthTest&&(h.depthTest?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),u.dss.depthTest=h.depthTest),u.dss.depthWrite!==h.depthWrite&&(i.depthMask(h.depthWrite),u.dss.depthWrite=h.depthWrite),u.dss.depthFunc!==h.depthFunc&&(i.depthFunc(be[h.depthFunc]),u.dss.depthFunc=h.depthFunc),u.dss.stencilTestFront===h.stencilTestFront&&u.dss.stencilTestBack===h.stencilTestBack||(h.stencilTestFront||h.stencilTestBack?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST),u.dss.stencilTestFront=h.stencilTestFront,u.dss.stencilTestBack=h.stencilTestBack),u.dss.stencilFuncFront===h.stencilFuncFront&&u.dss.stencilRefFront===h.stencilRefFront&&u.dss.stencilReadMaskFront===h.stencilReadMaskFront||(i.stencilFuncSeparate(i.FRONT,be[h.stencilFuncFront],h.stencilRefFront,h.stencilReadMaskFront),u.dss.stencilFuncFront=h.stencilFuncFront,u.dss.stencilRefFront=h.stencilRefFront,u.dss.stencilReadMaskFront=h.stencilReadMaskFront),u.dss.stencilFailOpFront===h.stencilFailOpFront&&u.dss.stencilZFailOpFront===h.stencilZFailOpFront&&u.dss.stencilPassOpFront===h.stencilPassOpFront||(i.stencilOpSeparate(i.FRONT,Fe[h.stencilFailOpFront],Fe[h.stencilZFailOpFront],Fe[h.stencilPassOpFront]),u.dss.stencilFailOpFront=h.stencilFailOpFront,u.dss.stencilZFailOpFront=h.stencilZFailOpFront,u.dss.stencilPassOpFront=h.stencilPassOpFront),u.dss.stencilWriteMaskFront!==h.stencilWriteMaskFront&&(i.stencilMaskSeparate(i.FRONT,h.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=h.stencilWriteMaskFront),u.dss.stencilFuncBack===h.stencilFuncBack&&u.dss.stencilRefBack===h.stencilRefBack&&u.dss.stencilReadMaskBack===h.stencilReadMaskBack||(i.stencilFuncSeparate(i.BACK,be[h.stencilFuncBack],h.stencilRefBack,h.stencilReadMaskBack),u.dss.stencilFuncBack=h.stencilFuncBack,u.dss.stencilRefBack=h.stencilRefBack,u.dss.stencilReadMaskBack=h.stencilReadMaskBack),u.dss.stencilFailOpBack===h.stencilFailOpBack&&u.dss.stencilZFailOpBack===h.stencilZFailOpBack&&u.dss.stencilPassOpBack===h.stencilPassOpBack||(i.stencilOpSeparate(i.BACK,Fe[h.stencilFailOpBack],Fe[h.stencilZFailOpBack],Fe[h.stencilPassOpBack]),u.dss.stencilFailOpBack=h.stencilFailOpBack,u.dss.stencilZFailOpBack=h.stencilZFailOpBack,u.dss.stencilPassOpBack=h.stencilPassOpBack),u.dss.stencilWriteMaskBack!==h.stencilWriteMaskBack&&(i.stencilMaskSeparate(i.BACK,h.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=h.stencilWriteMaskBack));var d=t.bs;if(d){u.bs.isA2C!==d.isA2C&&(d.isA2C?i.enable(i.SAMPLE_ALPHA_TO_COVERAGE):i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=d.isA2C),u.bs.blendColor.x===d.blendColor.x&&u.bs.blendColor.y===d.blendColor.y&&u.bs.blendColor.z===d.blendColor.z&&u.bs.blendColor.w===d.blendColor.w||(i.blendColor(d.blendColor.x,d.blendColor.y,d.blendColor.z,d.blendColor.w),u.bs.blendColor.x=d.blendColor.x,u.bs.blendColor.y=d.blendColor.y,u.bs.blendColor.z=d.blendColor.z,u.bs.blendColor.w=d.blendColor.w);var g=d.targets[0],R=u.bs.targets[0];R.blend!==g.blend&&(g.blend?i.enable(i.BLEND):i.disable(i.BLEND),R.blend=g.blend),R.blendEq===g.blendEq&&R.blendAlphaEq===g.blendAlphaEq||(i.blendEquationSeparate(Ie[g.blendEq],Ie[g.blendAlphaEq]),R.blendEq=g.blendEq,R.blendAlphaEq=g.blendAlphaEq),R.blendSrc===g.blendSrc&&R.blendDst===g.blendDst&&R.blendSrcAlpha===g.blendSrcAlpha&&R.blendDstAlpha===g.blendDstAlpha||(i.blendFuncSeparate(Pe[g.blendSrc],Pe[g.blendDst],Pe[g.blendSrcAlpha],Pe[g.blendDstAlpha]),R.blendSrc=g.blendSrc,R.blendDst=g.blendDst,R.blendSrcAlpha=g.blendSrcAlpha,R.blendDstAlpha=g.blendDstAlpha),R.blendColorMask!==g.blendColorMask&&(i.colorMask((g.blendColorMask&S.R)!==S.NONE,(g.blendColorMask&S.G)!==S.NONE,(g.blendColorMask&S.B)!==S.NONE,(g.blendColorMask&S.A)!==S.NONE),R.blendColorMask=g.blendColorMask)}}if(t&&t.gpuPipelineLayout&&l){for(var A=l.glBlocks.length,T=t.gpuPipelineLayout.dynamicOffsetIndices,p=0;p<A;p++){var C=l.glBlocks[p],x=s[C.set],b=x&&x.descriptorIndices[C.binding],F=b>=0&&x.gpuDescriptors[b];if(F&&F.gpuBuffer){var I=T[C.set],P=I&&I[C.binding],G=F.gpuBuffer.glOffset;P>=0&&(G+=a[P]),u.glBindUBOs[C.glBinding]===F.gpuBuffer.glBuffer&&u.glBindUBOOffsets[C.glBinding]===G||(G?i.bindBufferRange(i.UNIFORM_BUFFER,C.glBinding,F.gpuBuffer.glBuffer,G,F.gpuBuffer.size):i.bindBufferBase(i.UNIFORM_BUFFER,C.glBinding,F.gpuBuffer.glBuffer),u.glUniformBuffer=u.glBindUBOs[C.glBinding]=F.gpuBuffer.glBuffer,u.glBindUBOOffsets[C.glBinding]=G)}else E("Buffer binding '"+C.name+"' at set "+C.set+" binding "+C.binding+" is not bounded")}for(var O=l.glSamplerTextures.length,M=0;M<O;M++)for(var v=l.glSamplerTextures[M],D=s[v.set],L=D&&D.descriptorIndices[v.binding],U=L>=0&&D.gpuDescriptors[L],N=0;N<v.units.length;N++){var y=v.units[N],w=u.glTexUnits[y];if(U&&U.gpuTexture&&U.gpuSampler){if(U.gpuTexture&&U.gpuTexture.size>0){var k=U.gpuTexture;w.glTexture!==k.glTexture&&(u.texUnit!==y&&(i.activeTexture(i.TEXTURE0+y),u.texUnit=y),k.glTexture?i.bindTexture(k.glTarget,k.glTexture):i.bindTexture(k.glTarget,e.nullTex2D.gpuTexture.glTexture),w.glTexture=k.glTexture);var H=U.gpuSampler;u.glSamplerUnits[y]!==H.glSampler&&(i.bindSampler(y,H.glSampler),u.glSamplerUnits[y]=H.glSampler)}U=D.gpuDescriptors[++L]}else E("Sampler binding '"+v.name+"' at set "+v.set+" binding "+v.binding+" index "+N+" is not bounded")}}if(r&&l&&(_||ye.gpuInputAssembler!==r))if(ye.gpuInputAssembler=r,e.useVAO){var V=r.glVAOs.get(l.glProgram);if(!V){var X;V=i.createVertexArray(),r.glVAOs.set(l.glProgram,V),i.bindVertexArray(V),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var W=0;W<l.glInputs.length;W++){var z=l.glInputs[W];X=null;for(var K=0;K<r.glAttribs.length;K++){var Y=r.glAttribs[K];if(Y.name===z.name){X=Y;break}}if(X){u.glArrayBuffer!==X.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,X.glBuffer),u.glArrayBuffer=X.glBuffer);for(var q=0;q<X.componentCount;++q){var Z=z.glLoc+q,j=X.offset+X.size*q;i.enableVertexAttribArray(Z),u.glCurrentAttribLocs[Z]=!0,i.vertexAttribPointer(Z,X.count,X.glType,X.isNormalized,X.stride,j),i.vertexAttribDivisor(Z,X.isInstanced?1:0)}}}var Q=r.gpuIndexBuffer;Q&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,Q.glBuffer),i.bindVertexArray(null),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==V&&(i.bindVertexArray(V),u.glVAO=V)}else{for(var J=0;J<e.capabilities.maxVertexAttributes;++J)u.glCurrentAttribLocs[J]=!1;for(var $=0;$<l.glInputs.length;$++){for(var ee=l.glInputs[$],te=null,re=0;re<r.glAttribs.length;re++){var se=r.glAttribs[re];if(se.name===ee.name){te=se;break}}if(te){u.glArrayBuffer!==te.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,te.glBuffer),u.glArrayBuffer=te.glBuffer);for(var ae=0;ae<te.componentCount;++ae){var ne=ee.glLoc+ae,ie=te.offset+te.size*ae;!u.glEnabledAttribLocs[ne]&&ne>=0&&(i.enableVertexAttribArray(ne),u.glEnabledAttribLocs[ne]=!0),u.glCurrentAttribLocs[ne]=!0,i.vertexAttribPointer(ne,te.count,te.glType,te.isNormalized,te.stride,ie),i.vertexAttribDivisor(ne,te.isInstanced?1:0)}}}var ue=r.gpuIndexBuffer;ue&&u.glElementArrayBuffer!==ue.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,ue.glBuffer),u.glElementArrayBuffer=ue.glBuffer);for(var le=0;le<e.capabilities.maxVertexAttributes;++le)u.glEnabledAttribLocs[le]!==u.glCurrentAttribLocs[le]&&(i.disableVertexAttribArray(le),u.glEnabledAttribLocs[le]=!1)}if(t&&t.dynamicStates.length)for(var _e=t.dynamicStates.length,ce=0;ce<_e;ce++)switch(t.dynamicStates[ce]){case m.VIEWPORT:var oe=n.viewport;u.viewport.left===oe.left&&u.viewport.top===oe.top&&u.viewport.width===oe.width&&u.viewport.height===oe.height||(i.viewport(oe.left,oe.top,oe.width,oe.height),u.viewport.left=oe.left,u.viewport.top=oe.top,u.viewport.width=oe.width,u.viewport.height=oe.height);break;case m.SCISSOR:var fe=n.scissor;u.scissorRect.x===fe.x&&u.scissorRect.y===fe.y&&u.scissorRect.width===fe.width&&u.scissorRect.height===fe.height||(i.scissor(fe.x,fe.y,fe.width,fe.height),u.scissorRect.x=fe.x,u.scissorRect.y=fe.y,u.scissorRect.width=fe.width,u.scissorRect.height=fe.height);break;case m.LINE_WIDTH:u.rs.lineWidth!==n.lineWidth&&(i.lineWidth(n.lineWidth),u.rs.lineWidth=n.lineWidth);break;case m.DEPTH_BIAS:u.rs.depthBias===n.depthBiasConstant&&u.rs.depthBiasSlop===n.depthBiasSlope||(i.polygonOffset(n.depthBiasConstant,n.depthBiasSlope),u.rs.depthBias=n.depthBiasConstant,u.rs.depthBiasSlop=n.depthBiasSlope);break;case m.BLEND_CONSTANTS:var he=n.blendConstant;u.bs.blendColor.x===he.x&&u.bs.blendColor.y===he.y&&u.bs.blendColor.z===he.z&&u.bs.blendColor.w===he.w||(i.blendColor(he.x,he.y,he.z,he.w),u.bs.blendColor.copy(he));break;case m.STENCIL_WRITE_MASK:var de=n.stencilStatesFront,ge=n.stencilStatesBack;u.dss.stencilWriteMaskFront!==de.writeMask&&(i.stencilMaskSeparate(i.FRONT,de.writeMask),u.dss.stencilWriteMaskFront=de.writeMask),u.dss.stencilWriteMaskBack!==ge.writeMask&&(i.stencilMaskSeparate(i.BACK,ge.writeMask),u.dss.stencilWriteMaskBack=ge.writeMask);break;case m.STENCIL_COMPARE_MASK:var Re=n.stencilStatesFront,Ae=n.stencilStatesBack;u.dss.stencilRefFront===Re.reference&&u.dss.stencilReadMaskFront===Re.compareMask||(i.stencilFuncSeparate(i.FRONT,be[u.dss.stencilFuncFront],Re.reference,Re.compareMask),u.dss.stencilRefFront=Re.reference,u.dss.stencilReadMaskFront=Re.compareMask),u.dss.stencilRefBack===Ae.reference&&u.dss.stencilReadMaskBack===Ae.compareMask||(i.stencilFuncSeparate(i.BACK,be[u.dss.stencilFuncBack],Ae.reference,Ae.compareMask),u.dss.stencilRefBack=Ae.reference,u.dss.stencilReadMaskBack=Ae.compareMask)}}function He(e,t){var r=e.gl,s=ye.gpuInputAssembler,a=ye.glPrimitive;if(s)if(s.gpuIndirectBuffer)for(var n=s.gpuIndirectBuffer.indirects,i=0;i<n.length;i++){var u=n[i],l=s.gpuIndexBuffer;if(u.instanceCount)if(l){if(u.indexCount>0){var _=u.firstIndex*l.stride;r.drawElementsInstanced(a,u.indexCount,s.glIndexType,_,u.instanceCount)}}else u.vertexCount>0&&r.drawArraysInstanced(a,u.firstVertex,u.vertexCount,u.instanceCount);else if(l){if(u.indexCount>0){var c=u.firstIndex*l.stride;r.drawElements(a,u.indexCount,s.glIndexType,c)}}else u.vertexCount>0&&r.drawArrays(a,u.firstVertex,u.vertexCount)}else if(t.instanceCount)if(s.gpuIndexBuffer){if(t.indexCount>0){var o=t.firstIndex*s.gpuIndexBuffer.stride;r.drawElementsInstanced(a,t.indexCount,s.glIndexType,o,t.instanceCount)}}else t.vertexCount>0&&r.drawArraysInstanced(a,t.firstVertex,t.vertexCount,t.instanceCount);else if(s.gpuIndexBuffer){if(t.indexCount>0){var f=t.firstIndex*s.gpuIndexBuffer.stride;r.drawElements(a,t.indexCount,s.glIndexType,f)}}else t.vertexCount>0&&r.drawArrays(a,t.firstVertex,t.vertexCount)}var Ve=new Array(xe.COUNT);function Xe(e,t){Ve.fill(0);for(var r=0;r<t.cmds.length;++r){var s=t.cmds.array[r],a=Ve[s]++;switch(s){case xe.BEGIN_RENDER_PASS:var n=t.beginRenderPassCmds.array[a];we(e,n.gpuRenderPass,n.gpuFramebuffer,n.renderArea,n.clearColors,n.clearDepth,n.clearStencil);break;case xe.BIND_STATES:var i=t.bindStatesCmds.array[a];ke(e,i.gpuPipelineState,i.gpuInputAssembler,i.gpuDescriptorSets,i.dynamicOffsets,i.dynamicStates);break;case xe.DRAW:He(e,t.drawCmds.array[a].drawInfo);break;case xe.UPDATE_BUFFER:var u=t.updateBufferCmds.array[a];Ne(e,u.gpuBuffer,u.buffer,u.offset,u.size);break;case xe.COPY_BUFFER_TO_TEXTURE:var l=t.copyBufferToTextureCmds.array[a];We(e,l.buffers,l.gpuTexture,l.regions)}}}function We(e,t,r,s){var a=e.gl,n=e.stateCache.glTexUnits[e.stateCache.texUnit];n.glTexture!==r.glTexture&&(a.bindTexture(r.glTarget,r.glTexture),n.glTexture=r.glTexture);var i=0,u=1,l=1,_=0,c=R[r.format].isCompressed;switch(r.glTarget){case a.TEXTURE_2D:for(var o=0;o<s.length;o++){var f=s[o];u=f.texExtent.width,l=f.texExtent.height;var h=t[i++];c?r.glInternalFmt!==he.COMPRESSED_RGB_ETC1_WEBGL?a.compressedTexSubImage2D(a.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,u,l,r.glFormat,h):a.compressedTexImage2D(a.TEXTURE_2D,f.texSubres.mipLevel,r.glInternalFmt,u,l,0,h):a.texSubImage2D(a.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,u,l,r.glFormat,r.glType,h)}break;case a.TEXTURE_CUBE_MAP:for(var d=0;d<s.length;d++){var A=s[d],T=A.texSubres.baseArrayLayer+A.texSubres.layerCount;for(_=A.texSubres.baseArrayLayer;_<T;++_){u=A.texExtent.width,l=A.texExtent.height;var E=t[i++];c?r.glInternalFmt!==he.COMPRESSED_RGB_ETC1_WEBGL?a.compressedTexSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+_,A.texSubres.mipLevel,A.texOffset.x,A.texOffset.y,u,l,r.glFormat,E):a.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+_,A.texSubres.mipLevel,r.glInternalFmt,u,l,0,E):a.texSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+_,A.texSubres.mipLevel,A.texOffset.x,A.texOffset.y,u,l,r.glFormat,r.glType,E)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&g.GEN_MIPMAP&&a.generateMipmap(r.glTarget)}var ze=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuBuffer=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&o.INDIRECT&&(this._indirectBuffer=new F),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:[],glTarget:0,glBuffer:null,glOffset:0},e.usage&o.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),function(e,t){var r=e.gl,s=e.stateCache,a=t.memUsage&c.HOST?r.DYNAMIC_DRAW:r.STATIC_DRAW;if(t.usage&o.VERTEX){t.glTarget=r.ARRAY_BUFFER;var n=r.createBuffer();n&&(t.glBuffer=n,t.size>0&&(e.useVAO&&s.glVAO&&(r.bindVertexArray(null),s.glVAO=ye.gpuInputAssembler=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),r.bufferData(r.ARRAY_BUFFER,t.size,a),r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&o.INDEX){t.glTarget=r.ELEMENT_ARRAY_BUFFER;var i=r.createBuffer();i&&(t.glBuffer=i,t.size>0&&(e.useVAO&&s.glVAO&&(r.bindVertexArray(null),s.glVAO=ye.gpuInputAssembler=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,t.size,a),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&o.UNIFORM){t.glTarget=r.UNIFORM_BUFFER;var u=r.createBuffer();u&&t.size>0&&(t.glBuffer=u,e.stateCache.glUniformBuffer!==t.glBuffer&&(r.bindBuffer(r.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),r.bufferData(r.UNIFORM_BUFFER,t.size,a),r.bindBuffer(r.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&o.INDIRECT||t.usage&o.TRANSFER_DST||t.usage&o.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=r.NONE}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size;return!0},s.destroy=function(){this._gpuBuffer&&(this._isBufferView||(function(e,t){var r=e.gl;if(t.glBuffer){switch(t.glTarget){case r.ARRAY_BUFFER:e.useVAO&&e.stateCache.glVAO&&(r.bindVertexArray(null),e.stateCache.glVAO=ye.gpuInputAssembler=null),r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case r.ELEMENT_ARRAY_BUFFER:e.useVAO&&e.stateCache.glVAO&&(r.bindVertexArray(null),e.stateCache.glVAO=ye.gpuInputAssembler=null),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case r.UNIFORM_BUFFER:r.bindBuffer(r.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}r.deleteBuffer(t.glBuffer),t.glBuffer=null}}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)},s.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t,r,s,a,n,i=this._size;i!==e&&(this._size=e,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=e,e>0&&(t=this._device,r=this._gpuBuffer,s=t.gl,a=t.stateCache,n=r.memUsage&c.HOST?s.DYNAMIC_DRAW:s.STATIC_DRAW,r.usage&o.VERTEX?(t.useVAO&&a.glVAO&&(s.bindVertexArray(null),a.glVAO=ye.gpuInputAssembler=null),a.glArrayBuffer!==r.glBuffer&&s.bindBuffer(s.ARRAY_BUFFER,r.glBuffer),r.buffer?s.bufferData(s.ARRAY_BUFFER,r.buffer,n):s.bufferData(s.ARRAY_BUFFER,r.size,n),s.bindBuffer(s.ARRAY_BUFFER,null),a.glArrayBuffer=null):r.usage&o.INDEX?(t.useVAO&&a.glVAO&&(s.bindVertexArray(null),a.glVAO=ye.gpuInputAssembler=null),t.stateCache.glElementArrayBuffer!==r.glBuffer&&s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,r.glBuffer),r.buffer?s.bufferData(s.ELEMENT_ARRAY_BUFFER,r.buffer,n):s.bufferData(s.ELEMENT_ARRAY_BUFFER,r.size,n),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):r.usage&o.UNIFORM?(t.stateCache.glUniformBuffer!==r.glBuffer&&s.bindBuffer(s.UNIFORM_BUFFER,r.glBuffer),s.bufferData(s.UNIFORM_BUFFER,r.size,n),s.bindBuffer(s.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null):(r.usage&o.INDIRECT||r.usage&o.TRANSFER_DST||r.usage&o.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),r.glTarget=s.NONE),this._device.memoryStatus.bufferSize-=i,this._device.memoryStatus.bufferSize+=e)))}},s.update=function(e,t){var r;this._isBufferView?console.warn("cannot update through buffer views!"):(r=void 0!==t?t:this._usage&o.INDIRECT?0:e.byteLength,Ne(this._device,this._gpuBuffer,e,0,r))},a(r,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),r}(I),Ke=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new b(t);for(var r=0;r<t;++r)this._frees[r]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,r=this._frees;this._frees=new Array(t);for(var s=t-r.length,a=0;a<s;++a)this._frees[a]=new e;for(var n=s,i=0;n<t;++n,++i)this._frees[n]=r[i];this._freeIdx+=s}var u=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++u.refCount,u},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),Ye=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new Ke(Oe,1),this.bindStatesCmdPool=new Ke(Me,1),this.drawCmdPool=new Ke(ve,1),this.updateBufferCmdPool=new Ke(De,1),this.copyBufferToTextureCmdPool=new Ke(Le,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),qe=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).cmdPackage=new Ue,t._webGLAllocator=null,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUDescriptorSets=[],t._curGPUInputAssembler=null,t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new l,t._isStateInvalied=!1,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._type=e.type,this._queue=e.queue,this._webGLAllocator=this._device.cmdAllocator;for(var t=this._device.bindingMappingInfo.bufferOffsets.length,r=0;r<t;r++)this._curGPUDescriptorSets.push(null);return!0},s.destroy=function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._webGLAllocator=null)},s.begin=function(){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},s.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},s.beginRenderPass=function(e,t,r,s,a,n){var i=this._webGLAllocator.beginRenderPassCmdPool.alloc(Oe);i.gpuRenderPass=e.gpuRenderPass,i.gpuFramebuffer=t.gpuFramebuffer,i.renderArea=r;for(var u=0;u<s.length;++u)i.clearColors[u]=s[u];i.clearDepth=a,i.clearStencil=n,this.cmdPackage.beginRenderPassCmds.push(i),this.cmdPackage.cmds.push(xe.BEGIN_RENDER_PASS),this._isInRenderPass=!0},s.endRenderPass=function(){this._isInRenderPass=!1},s.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},s.bindDescriptorSet=function(e,t,r){var s=t.gpuDescriptorSet;if(s!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=s,this._isStateInvalied=!0),r){var a,n=null===(a=this._curGPUPipelineState)||void 0===a?void 0:a.gpuPipelineLayout;if(n){for(var i=this._curDynamicOffsets,u=n.dynamicOffsetOffsets[e],l=0;l<r.length;l++)i[u+l]=r[l];this._isStateInvalied=!0}}},s.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},s.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},s.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},s.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},s.setDepthBias=function(e,t,r){var s=this._curDynamicStates;s.depthBiasConstant===e&&s.depthBiasClamp===t&&s.depthBiasSlope===r||(s.depthBiasConstant=e,s.depthBiasClamp=t,s.depthBiasSlope=r,this._isStateInvalied=!0)},s.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},s.setDepthBound=function(e,t){var r=this._curDynamicStates;r.depthMinBounds===e&&r.depthMaxBounds===t||(r.depthMinBounds=e,r.depthMaxBounds=t,this._isStateInvalied=!0)},s.setStencilWriteMask=function(e,t){var r=this._curDynamicStates.stencilStatesFront,s=this._curDynamicStates.stencilStatesBack;e&P.FRONT&&r.writeMask!==t&&(r.writeMask=t,this._isStateInvalied=!0),e&P.BACK&&s.writeMask!==t&&(s.writeMask=t,this._isStateInvalied=!0)},s.setStencilCompareMask=function(e,t,r){var s=this._curDynamicStates.stencilStatesFront,a=this._curDynamicStates.stencilStatesBack;e&P.FRONT&&(s.compareMask===r&&s.reference===t||(s.reference=t,s.compareMask=r,this._isStateInvalied=!0)),e&P.BACK&&(a.compareMask===r&&a.reference===t||(a.reference=t,a.compareMask=r,this._isStateInvalied=!0))},s.draw=function(e){if(this._type===G.PRIMARY&&this._isInRenderPass||this._type===G.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._webGLAllocator.drawCmdPool.alloc(ve);t.drawInfo.vertexCount=e.vertexCount,t.drawInfo.firstVertex=e.firstVertex,t.drawInfo.indexCount=e.indexCount,t.drawInfo.firstIndex=e.firstIndex,t.drawInfo.vertexOffset=e.vertexOffset,t.drawInfo.instanceCount=e.instanceCount,t.drawInfo.firstInstance=e.firstInstance,this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(xe.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var r=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=r/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(r-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},s.updateBuffer=function(e,t,r){if(this._type===G.PRIMARY&&!this._isInRenderPass||this._type===G.SECONDARY){var s=e.gpuBuffer;if(s){var a,n=this._webGLAllocator.updateBufferCmdPool.alloc(De),i=0;e.usage&o.INDIRECT||(i=void 0!==r?r:t.byteLength),a=t,n.gpuBuffer=s,n.buffer=a,n.offset=0,n.size=i,this.cmdPackage.updateBufferCmds.push(n),this.cmdPackage.cmds.push(xe.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},s.copyBuffersToTexture=function(e,t,r){if(this._type===G.PRIMARY&&!this._isInRenderPass||this._type===G.SECONDARY){var s=t.gpuTexture;if(s){var a=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(Le);a.gpuTexture=s,a.regions=r,a.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(a),this.cmdPackage.cmds.push(xe.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},s.execute=function(e,t){for(var r=0;r<t;++r){for(var s=e[r],a=0;a<s.cmdPackage.beginRenderPassCmds.length;++a){var n=s.cmdPackage.beginRenderPassCmds.array[a];++n.refCount,this.cmdPackage.beginRenderPassCmds.push(n)}for(var i=0;i<s.cmdPackage.bindStatesCmds.length;++i){var u=s.cmdPackage.bindStatesCmds.array[i];++u.refCount,this.cmdPackage.bindStatesCmds.push(u)}for(var l=0;l<s.cmdPackage.drawCmds.length;++l){var _=s.cmdPackage.drawCmds.array[l];++_.refCount,this.cmdPackage.drawCmds.push(_)}for(var c=0;c<s.cmdPackage.updateBufferCmds.length;++c){var o=s.cmdPackage.updateBufferCmds.array[c];++o.refCount,this.cmdPackage.updateBufferCmds.push(o)}for(var f=0;f<s.cmdPackage.copyBufferToTextureCmds.length;++f){var h=s.cmdPackage.copyBufferToTextureCmds.array[f];++h.refCount,this.cmdPackage.copyBufferToTextureCmds.push(h)}this.cmdPackage.cmds.concat(s.cmdPackage.cmds.array),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},s.pipelineBarrier=function(){},s.bindStates=function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(Me);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(xe.BIND_STATES),this._isStateInvalied=!1},a(r,[{key:"webGLDevice",get:function(){return this._device}}]),r}(O),Ze=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuFramebuffer=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null,0!==e.depthStencilMipmapLevel&&console.warn("The mipmap level of th texture image to be attached of depth stencil attachment should be 0. Convert to 0.");for(var t=0;t<e.colorMipmapLevels.length;++t)0!==e.colorMipmapLevels[t]&&console.warn("The mipmap level of th texture image to be attached of color attachment "+t+" should be 0. Convert to 0.");for(var r=[],s=0;s<e.colorTextures.length;s++){var a=e.colorTextures[s];a&&r.push(a.gpuTexture)}var n=null;return e.depthStencilTexture&&(n=e.depthStencilTexture.gpuTexture),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:r,gpuDepthStencilTexture:n,glFramebuffer:null},function(e,t){if(t.gpuColorTextures.length||t.gpuDepthStencilTexture){var r=e.gl,s=[],a=r.createFramebuffer();if(a){t.glFramebuffer=a,e.stateCache.glFramebuffer!==t.glFramebuffer&&r.bindFramebuffer(r.FRAMEBUFFER,t.glFramebuffer);for(var n=0;n<t.gpuColorTextures.length;++n){var i=t.gpuColorTextures[n];i&&(i.glTexture?r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0+n,i.glTarget,i.glTexture,0):r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0+n,r.RENDERBUFFER,i.glRenderbuffer),s.push(r.COLOR_ATTACHMENT0+n))}var u=t.gpuDepthStencilTexture;if(u){var l=R[u.format].hasStencil?r.DEPTH_STENCIL_ATTACHMENT:r.DEPTH_ATTACHMENT;u.glTexture?r.framebufferTexture2D(r.FRAMEBUFFER,l,u.glTarget,u.glTexture,0):r.framebufferRenderbuffer(r.FRAMEBUFFER,l,r.RENDERBUFFER,u.glRenderbuffer)}r.drawBuffers(s);var _=r.checkFramebufferStatus(r.FRAMEBUFFER);if(_!==r.FRAMEBUFFER_COMPLETE)switch(_){case r.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case r.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case r.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case r.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&r.bindFramebuffer(r.FRAMEBUFFER,e.stateCache.glFramebuffer)}}}(this._device,this._gpuFramebuffer),!0},s.destroy=function(){var e,t;this._gpuFramebuffer&&(e=this._device,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null),this._gpuFramebuffer=null)},a(r,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),r}(M),je=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuInputAssembler=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){if(0===e.vertexBuffers.length)return console.error("InputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._firstIndex=0;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride,this._firstVertex=0,this._vertexOffset=0}this._instanceCount=0,this._firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var r=new Array(e.vertexBuffers.length),s=0;s<e.vertexBuffers.length;++s){var a=e.vertexBuffers[s];a.gpuBuffer&&(r[s]=a.gpuBuffer)}var n=null,i=0;if(e.indexBuffer&&(n=e.indexBuffer.gpuBuffer))switch(n.stride){case 1:i=5121;break;case 2:i=5123;break;case 4:i=5125;break;default:console.error("Illegal index buffer stride.")}var u=null;return e.indirectBuffer&&(u=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:r,gpuIndexBuffer:n,gpuIndirectBuffer:u,glAttribs:[],glIndexType:i,glVAOs:new Map},function(e,t){var r=e.gl;t.glAttribs=new Array(t.attributes.length);for(var s=[0,0,0,0,0,0,0,0],a=0;a<t.attributes.length;++a){var n=t.attributes[a],i=void 0!==n.stream?n.stream:0,u=t.gpuVertexBuffers[i],l=Te(n.format,r),_=R[n.format].size;t.glAttribs[a]={name:n.name,glBuffer:u.glBuffer,glType:l,size:_,count:R[n.format].count,stride:u.stride,componentCount:Ce(l,r),isNormalized:void 0!==n.isNormalized&&n.isNormalized,isInstanced:void 0!==n.isInstanced&&n.isInstanced,offset:s[i]},s[i]+=_}}(this._device,this._gpuInputAssembler),!0},s.destroy=function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){for(var r=t.glVAOs.values(),s=r.next();!s.done;)e.gl.deleteVertexArray(s.value),s=r.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},a(r,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),r}(v),Qe=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSetLayout=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,r=-1,s=[],a=0;a<this._bindings.length;a++){var n=this._bindings[a];s.push(t),t+=n.count,n.binding>r&&(r=n.binding)}this._bindingIndices=Array(r+1).fill(-1);for(var i=this._descriptorIndices=Array(r+1).fill(-1),u=0;u<this._bindings.length;u++){var l=this._bindings[u];this._bindingIndices[l.binding]=u,i[l.binding]=s[u]}for(var _=[],c=0;c<this._bindings.length;c++){var o=this._bindings[c];if(o.descriptorType&D)for(var f=0;f<o.count;f++)_.push(o.binding)}return this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:_,descriptorIndices:i,descriptorCount:t},!0},s.destroy=function(){this._bindings.length=0},a(r,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),r}(L),Je=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineLayout=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],r=[],s=0,a=[],n=0;n<this._setLayouts.length;n++){for(var i=this._setLayouts[n],u=i.gpuDescriptorSetLayout.dynamicBindings,l=Array(i.bindingIndices.length).fill(-1),_=0;_<u.length;_++){var c=u[_];l[c]<0&&(l[c]=s+_)}r.push(i.gpuDescriptorSetLayout),t.push(l),a.push(s),s+=u.length}return this._gpuPipelineLayout={gpuSetLayouts:r,dynamicOffsetIndices:t,dynamicOffsetCount:s,dynamicOffsetOffsets:a},!0},s.destroy=function(){this._setLayouts.length=0},a(r,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),r}(U),$e=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],et=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineState=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var r=e.blendState,s=r.targets;s&&s.forEach((function(e,r){t.setTarget(r,e)})),void 0!==r.isA2C&&(t.isA2C=r.isA2C),void 0!==r.isIndepend&&(t.isIndepend=r.isIndepend),void 0!==r.blendColor&&(t.blendColor=r.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var a=[],n=0;n<31;n++)this._dynamicStates&1<<n&&a.push(1<<n);return this._gpuPipelineState={glPrimitive:$e[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:a},!0},s.destroy=function(){this._gpuPipelineState=null},a(r,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),r}(N),tt=function(e){function r(){return e.apply(this,arguments)||this}t(r,e);var s=r.prototype;return s.beginRenderPass=function(e,t,r,s,a,n){we(this._device,e.gpuRenderPass,t.gpuFramebuffer,r,s,a,n),this._isInRenderPass=!0},s.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates(),He(this._device,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var t=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=t/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(t-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},s.updateBuffer=function(e,t,r){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var s,a=e.gpuBuffer;a&&(s=void 0!==r?r:e.usage&o.INDIRECT?0:t.byteLength,Ne(this._device,a,t,0,s))}},s.copyBuffersToTexture=function(e,t,r){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var s=t.gpuTexture;s&&We(this._device,e,s,r)}},s.execute=function(e,t){for(var r=0;r<t;++r){var s=e[r];Xe(this._device,s.cmdPackage),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},s.bindStates=function(){ke(this._device,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},r}(qe),rt=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}t(r,e);var s=r.prototype;return s.initialize=function(e){return this._type=e.type,!0},s.destroy=function(){},s.submit=function(e){if(!this._isAsync)for(var t=0;t<e.length;t++){var r=e[t];this.numDrawCalls+=r.numDrawCalls,this.numInstances+=r.numInstances,this.numTris+=r.numTris}},s.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},r}(y),st=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuRenderPass=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){return this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,e.subpasses&&(this._subpasses=e.subpasses),this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash(),!0},s.destroy=function(){this._gpuRenderPass=null},a(r,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),r}(w),at=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuSampler=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){var t,r,s,a;return this._minFilter=e.minFilter,this._magFilter=e.magFilter,this._mipFilter=e.mipFilter,this._addressU=e.addressU,this._addressV=e.addressV,this._addressW=e.addressW,this._maxAnisotropy=e.maxAnisotropy,this._cmpFunc=e.cmpFunc,this._borderColor=e.borderColor,this._mipLODBias=e.mipLODBias,this._gpuSampler={glSampler:null,minFilter:this._minFilter,magFilter:this._magFilter,mipFilter:this._mipFilter,addressU:this._addressU,addressV:this._addressV,addressW:this._addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},t=this._device,r=this._gpuSampler,(a=(s=t.gl).createSampler())&&(r.minFilter===T.LINEAR||r.minFilter===T.ANISOTROPIC?r.mipFilter===T.LINEAR||r.mipFilter===T.ANISOTROPIC?r.glMinFilter=s.LINEAR_MIPMAP_LINEAR:r.mipFilter===T.POINT?r.glMinFilter=s.LINEAR_MIPMAP_NEAREST:r.glMinFilter=s.LINEAR:r.mipFilter===T.LINEAR||r.mipFilter===T.ANISOTROPIC?r.glMinFilter=s.NEAREST_MIPMAP_LINEAR:r.mipFilter===T.POINT?r.glMinFilter=s.NEAREST_MIPMAP_NEAREST:r.glMinFilter=s.NEAREST,r.magFilter===T.LINEAR||r.magFilter===T.ANISOTROPIC?r.glMagFilter=s.LINEAR:r.glMagFilter=s.NEAREST,r.glWrapS=ge[r.addressU],r.glWrapT=ge[r.addressV],r.glWrapR=ge[r.addressW],r.glSampler=a,s.samplerParameteri(a,s.TEXTURE_MIN_FILTER,r.glMinFilter),s.samplerParameteri(a,s.TEXTURE_MAG_FILTER,r.glMagFilter),s.samplerParameteri(a,s.TEXTURE_WRAP_S,r.glWrapS),s.samplerParameteri(a,s.TEXTURE_WRAP_T,r.glWrapT),s.samplerParameteri(a,s.TEXTURE_WRAP_R,r.glWrapR),s.samplerParameterf(a,s.TEXTURE_MIN_LOD,0),s.samplerParameterf(a,s.TEXTURE_MAX_LOD,1e3)),!0},s.destroy=function(){var e,t;this._gpuSampler&&(e=this._device,(t=this._gpuSampler).glSampler&&(e.gl.deleteSampler(t.glSampler),t.glSampler=null),this._gpuSampler=null)},a(r,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),r}(k),nt=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuShader=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks,samplerTextures:e.samplerTextures,gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var r=e.stages[t];this._gpuShader.gpuStages[t]={type:r.stage,source:r.source,glShader:null}}return function(e,t){for(var r=e.gl,s=function(e){var s=t.gpuStages[e],a=0,n="",i=1;switch(s.type){case x.VERTEX:n="VertexShader",a=r.VERTEX_SHADER;break;case x.FRAGMENT:n="FragmentShader",a=r.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var u=r.createShader(a);if(u&&(s.glShader=u,r.shaderSource(s.glShader,"#version 300 es\n"+s.source),r.compileShader(s.glShader),!r.getShaderParameter(s.glShader,r.COMPILE_STATUS))){console.error(n+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",s.source.replace(/^|\n/g,(function(){return"\n"+i+++" "}))),console.error(r.getShaderInfoLog(s.glShader));for(var l=0;l<t.gpuStages.length;l++){var _=t.gpuStages[e];_.glShader&&(r.deleteShader(_.glShader),_.glShader=null)}return{v:void 0}}},a=0;a<t.gpuStages.length;a++){var n=s(a);if("object"==typeof n)return n.v}var i=r.createProgram();if(i){t.glProgram=i;for(var u=0;u<t.gpuStages.length;u++){var l=t.gpuStages[u];r.attachShader(t.glProgram,l.glShader)}r.linkProgram(t.glProgram);for(var _=0;_<t.gpuStages.length;_++){var c=t.gpuStages[_];c.glShader&&(r.detachShader(t.glProgram,c.glShader),r.deleteShader(c.glShader),c.glShader=null)}if(!r.getProgramParameter(t.glProgram,r.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(r.getProgramInfoLog(t.glProgram));console.info("Shader '"+t.name+"' compilation succeeded.");var o=r.getProgramParameter(t.glProgram,r.ACTIVE_ATTRIBUTES);t.glInputs=new Array(o);for(var f=0;f<o;++f){var h=r.getActiveAttrib(t.glProgram,f);if(h){var d,g=h.name.indexOf("[");d=-1!==g?h.name.substr(0,g):h.name;var R=r.getAttribLocation(t.glProgram,d),A=Be(h.type,r),T=me(h.type,r);t.glInputs[f]={name:d,type:A,stride:T,count:h.size,size:T*h.size,glType:h.type,glLoc:R}}}var p,S,B,m,C=r.getProgramParameter(t.glProgram,r.ACTIVE_UNIFORM_BLOCKS);if(C){t.glBlocks=new Array(C);for(var b=0;b<C;++b){var F=(p=r.getActiveUniformBlockName(t.glProgram,b)).indexOf("[");-1!==F&&(p=p.substr(0,F)),m=null;for(var I=0;I<t.blocks.length;I++)if(t.blocks[I].name===p){m=t.blocks[I];break}if(m){S=b,B=r.getActiveUniformBlockParameter(t.glProgram,S,r.UNIFORM_BLOCK_DATA_SIZE);var P=m.binding+(e.bindingMappingInfo.bufferOffsets[m.set]||0);r.uniformBlockBinding(t.glProgram,S,P),t.glBlocks[b]={set:m.set,binding:m.binding,idx:S,name:p,size:B,glBinding:P}}else E("Block '"+p+"' does not bound")}}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var G=0;G<t.samplerTextures.length;++G){var O=t.samplerTextures[G];t.glSamplerTextures[G]={set:O.set,binding:O.binding,name:O.name,type:O.type,count:O.count,units:[],glUnits:null,glType:Se(O.type,r),glLoc:null}}}for(var M=[],v=[],D=e.stateCache.texUnitCacheMap,L=0,U=0;U<t.blocks.length;++U)t.blocks[U].set===e.bindingMappingInfo.flexibleSet&&L++;for(var N=0,y=0;y<t.samplerTextures.length;++y){var w=t.samplerTextures[y],k=r.getUniformLocation(t.glProgram,w.name);if(null===k||"number"!=typeof k&&-1===k.id||(M.push(t.glSamplerTextures[y]),v.push(k)),void 0===D[w.name]){var H=w.binding+e.bindingMappingInfo.samplerOffsets[w.set]+N;w.set===e.bindingMappingInfo.flexibleSet&&(H-=L),D[w.name]=H%e.capabilities.maxTextureUnits,N+=w.count-1}}if(M.length){for(var V=[],X=0;X<M.length;++X){var W=M[X],z=D[W.name];if(void 0!==z){W.glLoc=v[X];for(var K=0;K<W.count;++K){for(;V[z];)z=(z+1)%e.capabilities.maxTextureUnits;W.units.push(z),V[z]=!0}}}for(var Y=0,q=0;q<M.length;++q){var Z=M[q];if(!Z.glLoc){for(Z.glLoc=v[q];V[Y];)Y++;for(var j=0;j<Z.count;++j){for(;V[Y];)Y=(Y+1)%e.capabilities.maxTextureUnits;void 0===D[Z.name]&&(D[Z.name]=Y),Z.units.push(Y),V[Y]=!0}}}e.stateCache.glProgram!==t.glProgram&&r.useProgram(t.glProgram);for(var Q=0;Q<M.length;Q++){var J=M[Q];J.glUnits=new Int32Array(J.units),r.uniform1iv(J.glLoc,J.glUnits)}e.stateCache.glProgram!==t.glProgram&&r.useProgram(e.stateCache.glProgram)}t.glSamplerTextures=M}}(this._device,this._gpuShader),!0},s.destroy=function(){var e,t;this._gpuShader&&(e=this._device,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null),this._gpuShader=null)},a(r,[{key:"gpuShader",get:function(){return this._gpuShader}}]),r}(H),it=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new V,this.scissorRect=new u(0,0,0,0),this.rs=new X,this.dss=new W,this.bs=new z,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t,r){for(var s=0;s<e;++s)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=e,this.glSamplerUnits.fill(null),this.glBindUBOs.length=t,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=t,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=r,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=r,this.glCurrentAttribLocs.fill(!1)},e}(),ut=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuTexture=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){return"texture"in e?(console.log("WebGL2 does not support texture view."),!1):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=K(this._width)&&K(this._height),this._size=Y(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var r=e.gl;t.glInternalFmt=Ee(t.format,r),t.glFormat=pe(t.format,r),t.glType=Te(t.format,r);var s=t.width,a=t.height;switch(t.type){case f.TEX2D:t.glTarget=r.TEXTURE_2D;var n=Math.max(s,a);if(n>e.capabilities.maxTextureSize&&h(9100,n,e.capabilities.maxTextureSize),t.samples===A.X1){var i=r.createTexture();if(i&&t.size>0){t.glTexture=i;var u=e.stateCache.glTexUnits[e.stateCache.texUnit];if(u.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),u.glTexture=t.glTexture),t.glInternalFmt===he.COMPRESSED_RGB_ETC1_WEBGL){var l=d(t.format,2,2,1),_=new Uint8Array(l);r.compressedTexImage2D(r.TEXTURE_2D,0,t.glInternalFmt,2,2,0,_)}else if(t.flags&g.IMMUTABLE)r.texStorage2D(r.TEXTURE_2D,t.mipLevel,t.glInternalFmt,s,a);else if(R[t.format].isCompressed)for(var c=0;c<t.mipLevel;++c){var o=d(t.format,s,a,1),T=new Uint8Array(o);r.compressedTexImage2D(r.TEXTURE_2D,c,t.glInternalFmt,s,a,0,T),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}else for(var E=0;E<t.mipLevel;++E)r.texImage2D(r.TEXTURE_2D,E,t.glInternalFmt,s,a,0,t.glFormat,t.glType,null),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}else r.deleteTexture(i)}else{var p=r.createRenderbuffer();p&&t.size>0&&(t.glRenderbuffer=p,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,Re[t.samples],t.glInternalFmt,t.width,t.height))}break;case f.CUBE:t.glTarget=r.TEXTURE_CUBE_MAP;var S=Math.max(s,a);S>e.capabilities.maxCubeMapTextureSize&&h(9100,S,e.capabilities.maxTextureSize);var B=r.createTexture();if(B&&t.size>0){t.glTexture=B;var m=e.stateCache.glTexUnits[e.stateCache.texUnit];if(m.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),m.glTexture=t.glTexture),t.glInternalFmt===he.COMPRESSED_RGB_ETC1_WEBGL)for(var C=0;C<6;++C){var x=d(t.format,2,2,1),b=new Uint8Array(x);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+C,0,t.glInternalFmt,2,2,0,b)}else if(t.flags&g.IMMUTABLE)r.texStorage2D(r.TEXTURE_CUBE_MAP,t.mipLevel,t.glInternalFmt,s,a);else if(R[t.format].isCompressed)for(var F=0;F<t.mipLevel;++F){for(var I=d(t.format,s,a,1),P=new Uint8Array(I),G=0;G<6;++G)r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+G,F,t.glInternalFmt,s,a,0,P);s=Math.max(1,s>>1),a=Math.max(1,a>>1)}else for(var O=0;O<t.mipLevel;++O){for(var M=0;M<6;++M)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+M,O,t.glInternalFmt,s,a,0,t.glFormat,t.glType,null);s=Math.max(1,s>>1),a=Math.max(1,a>>1)}}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=f.TEX2D,t.glTarget=r.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,!0)},s.destroy=function(){var e,t;this._gpuTexture&&(e=this._device,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},s.resize=function(e,t){var r=this._size;this._width=e,this._height=t,this._size=Y(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){var r=e.gl;t.glInternalFmt=Ee(t.format,r),t.glFormat=pe(t.format,r),t.glType=Te(t.format,r);var s=t.width,a=t.height;switch(t.type){case f.TEX2D:t.glTarget=r.TEXTURE_2D;var n=Math.max(s,a);if(n>e.capabilities.maxTextureSize&&h(9100,n,e.capabilities.maxTextureSize),t.samples===A.X1){var i=e.stateCache.glTexUnits[e.stateCache.texUnit];if(i.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),i.glTexture=t.glTexture),R[t.format].isCompressed){if(t.glInternalFmt!==he.COMPRESSED_RGB_ETC1_WEBGL)for(var u=0;u<t.mipLevel;++u){var l=d(t.format,s,a,1),_=new Uint8Array(l);r.compressedTexImage2D(r.TEXTURE_2D,u,t.glInternalFmt,s,a,0,_),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}}else for(var c=0;c<t.mipLevel;++c)r.texImage2D(r.TEXTURE_2D,c,t.glInternalFmt,s,a,0,t.glFormat,t.glType,null),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}else{var o=r.createRenderbuffer();o&&t.size>0&&(t.glRenderbuffer=o,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,Re[t.samples],t.glInternalFmt,t.width,t.height))}break;case f.CUBE:t.type=f.CUBE,t.glTarget=r.TEXTURE_CUBE_MAP;var g=Math.max(s,a);g>e.capabilities.maxCubeMapTextureSize&&h(9100,g,e.capabilities.maxTextureSize);var T=e.stateCache.glTexUnits[e.stateCache.texUnit];if(T.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),T.glTexture=t.glTexture),R[t.format].isCompressed){if(t.glInternalFmt!==he.COMPRESSED_RGB_ETC1_WEBGL)for(var E=0;E<6;++E){s=t.width,a=t.height;for(var p=0;p<t.mipLevel;++p){var S=d(t.format,s,a,1),B=new Uint8Array(S);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+E,p,t.glInternalFmt,s,a,0,B),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}}}else for(var m=0;m<6;++m){s=t.width,a=t.height;for(var C=0;C<t.mipLevel;++C)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+m,C,t.glInternalFmt,s,a,0,t.glFormat,t.glType,null),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=f.TEX2D,t.glTarget=r.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=r,this._device.memoryStatus.textureSize+=this._size)},a(r,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),r}(q),lt="webglcontextlost",_t=e("WebGL2Device",function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).stateCache=new it,t.cmdAllocator=new Ye,t.nullTex2D=null,t.nullTexCube=null,t._webGL2RC=null,t._isAntialias=!0,t._isPremultipliedAlpha=!0,t._useVAO=!0,t._bindingMappingInfo=new _e,t._webGLContextLostHandler=null,t._extensions=null,t._EXT_texture_filter_anisotropic=null,t._OES_texture_float_linear=null,t._OES_texture_half_float_linear=null,t._EXT_color_buffer_float=null,t._EXT_disjoint_timer_query_webgl2=null,t._WEBGL_compressed_texture_etc1=null,t._WEBGL_compressed_texture_etc=null,t._WEBGL_compressed_texture_pvrtc=null,t._WEBGL_compressed_texture_astc=null,t._WEBGL_compressed_texture_s3tc=null,t._WEBGL_compressed_texture_s3tc_srgb=null,t._WEBGL_debug_renderer_info=null,t._WEBGL_texture_storage_multisample=null,t._WEBGL_debug_shaders=null,t._WEBGL_lose_context=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._canvas=e.canvasElm,this._isAntialias=e.isAntialias,this._isPremultipliedAlpha=e.isPremultipliedAlpha,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);try{var t={alpha:Z.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGL2RC=this._canvas.getContext("webgl2",t)}catch(e){return console.warn(e),!1}if(!this._webGL2RC)return console.warn("This device does not support WebGL2."),!1;this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(lt,this._onWebGLContextLost),this._canvas2D=document.createElement("canvas"),console.info("WebGL2 device initialized."),this._gfxAPI=j.WEBGL2,this._deviceName="WebGL2";var r=this._webGL2RC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=r.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=r.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=r.getParameter(r.RENDERER),this._vendor=r.getParameter(r.VENDOR)),this._version=r.getParameter(r.VERSION),this._caps.maxVertexAttributes=r.getParameter(r.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=r.getParameter(r.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=r.getParameter(r.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=r.getParameter(r.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=r.getParameter(r.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=r.getParameter(r.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=r.getParameter(r.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=r.getParameter(r.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=r.getParameter(r.UNIFORM_BUFFER_OFFSET_ALIGNMENT),this._caps.depthBits=r.getParameter(r.DEPTH_BITS),this._caps.stencilBits=r.getParameter(r.STENCIL_BITS),this.stateCache.initialize(this._caps.maxTextureUnits,this._caps.maxUniformBufferBindings,this._caps.maxVertexAttributes),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=i.RGBA8,32===this._caps.depthBits?8===this._caps.stencilBits?this._depthStencilFmt=i.D32F_S8:this._depthStencilFmt=i.D32F:24===this._caps.depthBits?8===this._caps.stencilBits?this._depthStencilFmt=i.D24S8:this._depthStencilFmt=i.D24:8===this._caps.stencilBits?this._depthStencilFmt=i.D16S8:this._depthStencilFmt=i.D16,this._extensions=r.getSupportedExtensions();var s="";if(this._extensions){for(var a,n=Q(this._extensions);!(a=n()).done;)s+=a.value+" ";console.debug("EXTENSIONS: "+s)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_color_buffer_float=this.getExtension("EXT_color_buffer_float"),this._EXT_disjoint_timer_query_webgl2=this.getExtension("EXT_disjoint_timer_query_webgl2"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_texture_storage_multisample=this.getExtension("WEBGL_texture_storage_multisample"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._features.fill(!1),this._features[J.TEXTURE_FLOAT]=!0,this._features[J.TEXTURE_HALF_FLOAT]=!0,this._features[J.FORMAT_R11G11B10F]=!0,this._features[J.FORMAT_RGB8]=!0,this._features[J.FORMAT_D16]=!0,this._features[J.FORMAT_D24]=!0,this._features[J.FORMAT_D32F]=!0,this._features[J.FORMAT_D24S8]=!0,this._features[J.FORMAT_D32FS8]=!0,this._features[J.MSAA]=!0,this._features[J.ELEMENT_INDEX_UINT]=!0,this._features[J.INSTANCED_ARRAYS]=!0,this._features[J.MULTIPLE_RENDER_TARGETS]=!0,this._features[J.BLEND_MINMAX]=!0,this._EXT_color_buffer_float&&(this._features[J.COLOR_FLOAT]=!0,this._features[J.COLOR_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[J.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[J.TEXTURE_HALF_FLOAT_LINEAR]=!0);var u="";this._WEBGL_compressed_texture_etc1&&(this._features[J.FORMAT_ETC1]=!0,u+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[J.FORMAT_ETC2]=!0,u+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[J.FORMAT_DXT]=!0,u+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[J.FORMAT_PVRTC]=!0,u+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[J.FORMAT_ASTC]=!0,u+="astc "),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_ATTRIBS: "+this._caps.maxVertexAttributes),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._caps.maxVertexUniformVectors),console.info("MAX_FRAGMENT_UNIFORM_VECTORS: "+this._caps.maxFragmentUniformVectors),console.info("MAX_TEXTURE_IMAGE_UNITS: "+this._caps.maxTextureUnits),console.info("MAX_VERTEX_TEXTURE_IMAGE_UNITS: "+this._caps.maxVertexTextureUnits),console.info("MAX_UNIFORM_BUFFER_BINDINGS: "+this._caps.maxUniformBufferBindings),console.info("MAX_UNIFORM_BLOCK_SIZE: "+this._caps.maxUniformBlockSize),console.info("DEPTH_BITS: "+this._caps.depthBits),console.info("STENCIL_BITS: "+this._caps.stencilBits),console.info("UNIFORM_BUFFER_OFFSET_ALIGNMENT: "+this._caps.uboOffsetAlignment),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+u),this.initStates(r),this._queue=this.createQueue(new $(ee.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new te(this._queue)),this.nullTex2D=this.createTexture(new re(f.TEX2D,se.SAMPLED,i.RGBA8,2,2,g.GEN_MIPMAP)),this.nullTexCube=new ut(this),this.nullTexCube.initialize(new re(f.CUBE,se.SAMPLED,i.RGBA8,2,2,g.GEN_MIPMAP,6));var l=new ce;l.texExtent.width=2,l.texExtent.height=2;var _=new Uint8Array(this.nullTex2D.size);return _.fill(0),this.copyBuffersToTexture([_],this.nullTex2D,[l]),l.texSubres.layerCount=6,this.copyBuffersToTexture([_,_,_,_,_,_],this.nullTexCube,[l]),!0},s.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(lt,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._extensions=null,this._webGL2RC=null},s.resize=function(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)},s.flushCommands=function(){},s.acquire=function(){this.cmdAllocator.releaseCmds()},s.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},s.createCommandBuffer=function(e){var t=new(e.type===G.PRIMARY?tt:qe)(this);return t.initialize(e)?t:null},s.createBuffer=function(e){var t=new ze(this);return t.initialize(e)?t:null},s.createTexture=function(e){var t=new ut(this);return t.initialize(e)?t:null},s.createSampler=function(e){var t=new at(this);return t.initialize(e)?t:null},s.createDescriptorSet=function(e){var t=new de(this);return t.initialize(e)?t:null},s.createShader=function(e){var t=new nt(this);return t.initialize(e)?t:null},s.createInputAssembler=function(e){var t=new je(this);return t.initialize(e)?t:null},s.createRenderPass=function(e){var t=new st(this);return t.initialize(e)?t:null},s.createFramebuffer=function(e){var t=new Ze(this);return t.initialize(e)?t:null},s.createDescriptorSetLayout=function(e){var t=new Qe(this);return t.initialize(e)?t:null},s.createPipelineLayout=function(e){var t=new Je(this);return t.initialize(e)?t:null},s.createPipelineState=function(e){var t=new et(this);return t.initialize(e)?t:null},s.createQueue=function(e){var t=new rt(this);return t.initialize(e)?t:null},s.createGlobalBarrier=function(e){var t=new ae(this);return t.initialize(e)?t:null},s.createTextureBarrier=function(e){var t=new ne(this);return t.initialize(e)?t:null},s.copyBuffersToTexture=function(e,t,r){We(this,e,t.gpuTexture,r)},s.copyTexImagesToTexture=function(e,t,r){!function(e,t,r,s){var a=e.gl,n=e.stateCache.glTexUnits[e.stateCache.texUnit];n.glTexture!==r.glTexture&&(a.bindTexture(r.glTarget,r.glTexture),n.glTexture=r.glTexture);var i=0,u=0;switch(r.glTarget){case a.TEXTURE_2D:for(var l=0;l<s.length;l++){var _=s[l];a.texSubImage2D(a.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,r.glFormat,r.glType,t[i++])}break;case a.TEXTURE_CUBE_MAP:for(var c=0;c<s.length;c++){var o=s[c],f=o.texSubres.baseArrayLayer+o.texSubres.layerCount;for(u=o.texSubres.baseArrayLayer;u<f;++u)a.texSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+u,o.texSubres.mipLevel,o.texOffset.x,o.texOffset.y,r.glFormat,r.glType,t[i++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&g.GEN_MIPMAP&&a.generateMipmap(r.glTarget)}(this,e,t.gpuTexture,r)},s.copyFramebufferToBuffer=function(e,t,r){var s=this._webGL2RC,a=e.gpuFramebuffer,n=a.gpuColorTextures[0].format,i=pe(n,s),u=Te(n,s),l=ie(R[n]),_=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==a.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,a.glFramebuffer),this.stateCache.glFramebuffer=a.glFramebuffer);for(var c,o=new l(t),f=Q(r);!(c=f()).done;){var h=c.value,d=h.texExtent.width,g=h.texExtent.height;s.readPixels(h.texOffset.x,h.texOffset.y,d,g,i,u,o)}this.stateCache.glFramebuffer!==_&&(s.bindFramebuffer(s.FRAMEBUFFER,_),this.stateCache.glFramebuffer=_)},s.blitFramebuffer=function(e,t,r,s,a){!function(e,t,r,s,a,n){var i=e.gl;e.stateCache.glReadFramebuffer!==t.glFramebuffer&&(i.bindFramebuffer(i.READ_FRAMEBUFFER,t.glFramebuffer),e.stateCache.glReadFramebuffer=t.glFramebuffer);var u=r.glFramebuffer!==e.stateCache.glFramebuffer;u&&i.bindFramebuffer(i.DRAW_FRAMEBUFFER,r.glFramebuffer);var l=0;t.gpuColorTextures.length>0&&(l|=i.COLOR_BUFFER_BIT),t.gpuDepthStencilTexture&&(l|=i.DEPTH_BUFFER_BIT,R[t.gpuDepthStencilTexture.format].hasStencil&&(l|=i.STENCIL_BUFFER_BIT));var _=n===T.LINEAR||n===T.ANISOTROPIC?i.LINEAR:i.NEAREST;i.blitFramebuffer(s.x,s.y,s.x+s.width,s.y+s.height,a.x,a.y,a.x+a.width,a.y+a.height,l,_),u&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}(this,e.gpuFramebuffer,t.gpuFramebuffer,r,s,a)},s.getExtension=function(e){for(var t=["","WEBKIT_","MOZ_"],r=0;r<t.length;++r){var s=this.gl.getExtension(t[r]+e);if(s)return s}return null},s.initStates=function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)},s._onWebGLContextLost=function(e){ue(11e3),le(e)},a(r,[{key:"gl",get:function(){return this._webGL2RC}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"OES_texture_float_linear",get:function(){return this._OES_texture_float_linear}},{key:"EXT_color_buffer_float",get:function(){return this._EXT_color_buffer_float}},{key:"EXT_disjoint_timer_query_webgl2",get:function(){return this._EXT_disjoint_timer_query_webgl2}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_etc",get:function(){return this._WEBGL_compressed_texture_etc}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}},{key:"WEBGL_texture_storage_multisample",get:function(){return this._WEBGL_texture_storage_multisample}},{key:"WEBGL_debug_shaders",get:function(){return this._WEBGL_debug_shaders}},{key:"WEBGL_lose_context",get:function(){return this._WEBGL_lose_context}}]),r}(oe));fe.WebGL2Device=_t}}}));
