System.register(["./fog-01fb8507.js"],(function(e){"use strict";var t,i,n,r,s,a,o,h,u,l,c,_,d,f,p,g,v,S,m,E,w,T,y,O,A,I,b,R,D,F,N,C,P,B,L,M,x,H,U,z,G,V,W,k,Q,Y,q,X,j,K,Z,J,$,ee,te,ie,ne,re,se,ae,oe,he,ue,le,ce,_e,de,fe,pe,ge,ve,Se,me,Ee,we,Te,ye,Oe,Ae,Ie,be,Re,De,Fe,Ne,Ce,Pe,Be,Le,Me,xe,He,Ue,ze,Ge,Ve,We,ke,Qe,Ye,qe,Xe,je,Ke,Ze,Je,$e,et,tt,it,nt,rt,st,at,ot,ht,ut,lt,ct,_t,dt,ft,pt,gt,vt,St,mt,Et,wt,Tt,yt,Ot,At,It,bt,Rt,Dt,Ft,Nt,Ct,Pt,Bt,Lt,Mt,xt,Ht,Ut,zt,Gt,Vt,Wt,kt;return{setters:[function(e){t=e.cY,i=e.d3,n=e.ab,r=e.cl,s=e.ck,a=e.eR,o=e.bV,h=e.ct,u=e.v,l=e.eS,c=e.l,_=e.eT,d=e.eU,f=e.dh,p=e.ew,g=e.di,v=e.an,S=e.d8,m=e.eV,E=e.cF,w=e.cE,T=e.eW,y=e.dG,O=e.ej,A=e.d$,I=e.eX,b=e.cW,R=e.ev,D=e.d_,F=e.c,N=e.eh,C=e.ei,P=e.d,B=e.eY,L=e.eu,M=e.ex,x=e.eE,H=e.eF,U=e.eJ,z=e.eA,G=e.eZ,V=e.e_,W=e.P,k=e.e$,Q=e.f0,Y=e.bv,q=e.bx,X=e.c_,j=e.ap,K=e.z,Z=e.G,J=e.f1,$=e.f2,ee=e.f3,te=e.da,ie=e.f4,ne=e.bL,re=e.bJ,se=e.eN,ae=e.t,oe=e.e7,he=e.cx,ue=e.cw,le=e.es,ce=e.bR,_e=e.f5,de=e.cD,fe=e.cC,pe=e.f6,ge=e.bu,ve=e.L,Se=e.N,me=e.aS,Ee=e.f7,we=e.bQ,Te=e.aR,ye=e.f8,Oe=e.F,Ae=e.e1,Ie=e.af,be=e.aU,Re=e.bl,De=e.dz,Fe=e.H,Ne=e.I,Ce=e.$,Pe=e.Z,Be=e.a0,Le=e.x,Me=e.e8,xe=e.dX,He=e.eB,Ue=e.el,ze=e.R,Ge=e.C,Ve=e.cb,We=e.ca,ke=e.bW,Qe=e.f9,Ye=e.bX,qe=e.fa,Xe=e.aG,je=e.aI,Ke=e.fb,Ze=e.fc,Je=e.aq,$e=e.fd,et=e.c9,tt=e.c8,it=e.bK,nt=e.dr,rt=e.eo,st=e.cf,at=e.ce,ot=e.bY,ht=e.fe,ut=e.aJ,lt=e.aK,ct=e.aM,_t=e.au,dt=e.aP,ft=e.ff,pt=e.f,gt=e.fg,vt=e.fh,St=e.fi,mt=e.fj,Et=e.fk,wt=e.fl,Tt=e.fm,yt=e.fn,Ot=e.fo,At=e.a,It=e.cU,bt=e.eM,Rt=e.ed,Dt=e.ef,Ft=e.fp,Nt=e.ee,Ct=e.fq,Pt=e.fr,Bt=e.b0,Lt=e.eg,Mt=e.fs,xt=e.e,Ht=e.w,Ut=e.ft,zt=e.d6,Gt=e.fu,Vt=e.fv,Wt=e.fw,kt=e.dH}],execute:function(){var Qt,Yt,qt,Xt,jt;e({C:void 0,L:void 0,a:void 0,b:void 0,c:void 0,d:void 0,f:si}),function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(Qt||(Qt=e("C",{}))),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(Yt||(Yt=e("a",{}))),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(qt||(qt=e("b",{}))),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(Xt||(Xt=e("c",{}))),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(jt||(jt=e("d",{})));var Kt,Zt=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],Jt=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],$t=[100,200,400,800],ei=new t,ti=new t,ii=new i,ni=e("S",n.STENCIL<<1),ri=[];function si(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var i=t*t,n=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),r=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),s=2*n-8*r+4,a=3*n/s,o=2*r/s,h=1/o*a,u=1/o*(1-a-o);e.x=3.2404542*h-1.5371385+-.4985314*u,e.y=-.969266*h+1.8760108+.041556*u,e.z=.0556434*h-.2040259+1.0572252*u}e("e",function(){function e(e){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Qt.VERTICAL,this._fov=g(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new v(.2,.2,.2,1),this._viewport=new S(0,0,1,1),this._curTransform=u.IDENTITY,this._isProjDirty=!0,this._matView=new i,this._matViewInv=null,this._matProj=new i,this._matProjInv=new i,this._matViewProj=new i,this._matViewProjInv=new i,this._frustum=new m,this._forward=new t,this._position=new t,this._priority=0,this._aperture=qt.F16_0,this._apertureValue=void 0,this._shutter=jt.D125,this._shutterValue=0,this._iso=Xt.ISO100,this._isoValue=0,this._ec=0,this._poolHandle=o,this._frustumHandle=o,this._window=null,this._device=e,this._apertureValue=Zt[this._aperture],this._shutterValue=Jt[this._shutter],this._isoValue=$t[this._iso],this._aspect=this.screenScale=1,!ri.length){var n=e.capabilities.clipSpaceSignY;ri[u.IDENTITY]=new i(1,0,0,0,0,n),ri[u.ROTATE_90]=new i(0,1,0,0,-n,0),ri[u.ROTATE_180]=new i(-1,0,0,0,0,-n),ri[u.ROTATE_270]=new i(0,-1,0,0,n,0)}}var E=e.prototype;return E.initialize=function(e){this._name=e.name,this._node=e.node,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1;var t=this._poolHandle=r.alloc();r.set(t,s.WIDTH,1),r.set(t,s.HEIGHT,1),r.set(t,s.CLEAR_FLAGS,n.NONE),r.set(t,s.CLEAR_DEPTH,1),r.set(t,s.NODE,this._node.handle),r.set(t,s.VISIBILITY,a),this._scene&&r.set(t,s.SCENE,this._scene.handle),this.updateExposure(),this.changeTargetWindow(e.window),console.log("Created Camera: "+this._name+" "+r.get(t,s.WIDTH)+"x"+r.get(t,s.HEIGHT))},E.destroy=function(){this._window&&this._window.detachCamera(this),this._name=null,this._poolHandle&&(r.free(this._poolHandle),this._poolHandle=o,this._frustumHandle&&(h.free(this._frustumHandle),this._frustumHandle=o))},E.attachToScene=function(e){this._scene=e,this._enabled=!0,r.set(this._poolHandle,s.SCENE,e.handle)},E.detachFromScene=function(){this._scene=null,this._enabled=!1,r.set(this._poolHandle,s.SCENE,0)},E.resize=function(e,t){var i=this._poolHandle;r.set(i,s.WIDTH,e),r.set(i,s.HEIGHT,t),this._aspect=e*this._viewport.width/(t*this._viewport.height),this._isProjDirty=!0},E.setFixedSize=function(e,t){var i=this._poolHandle;r.set(i,s.WIDTH,e),r.set(i,s.HEIGHT,t),this._aspect=e*this._viewport.width/(t*this._viewport.height),this.isWindowSize=!1},E.update=function(e){if(void 0===e&&(e=!1),this._node){var t=!1;(this._node.hasChangedFlags||e)&&(i.invert(this._matView,this._node.worldMatrix),r.setMat4(this._poolHandle,s.MAT_VIEW,this._matView),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),r.setVec3(this._poolHandle,s.POSITION,this._position),r.setVec3(this._poolHandle,s.FORWARD,this._forward),t=!0);var n=this._device.surfaceTransform;if(this._isProjDirty||this._curTransform!==n){var a;this._curTransform=n;var o=this._device.capabilities.clipSpaceSignY;if((null===(a=this.window)||void 0===a?void 0:a.hasOffScreenAttachments)&&(n=u.IDENTITY),this._proj===Yt.PERSPECTIVE)i.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Qt.VERTICAL,this._device.capabilities.clipSpaceMinZ,o,n);else{var h=this._orthoHeight*this._aspect,c=this._orthoHeight;i.ortho(this._matProj,-h,h,-c,c,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,o,n)}i.invert(this._matProjInv,this._matProj),r.setMat4(this._poolHandle,s.MAT_PROJ,this._matProj),r.setMat4(this._poolHandle,s.MAT_PROJ_INV,this._matProjInv),t=!0,this._isProjDirty=!1}t&&(i.multiply(this._matViewProj,this._matProj,this._matView),i.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv),r.setMat4(this._poolHandle,s.MAT_VIEW_PROJ,this._matViewProj),r.setMat4(this._poolHandle,s.MAT_VIEW_PROJ_INV,this._matViewProjInv),l(this._frustumHandle,this._frustum))}},E.changeTargetWindow=function(e){void 0===e&&(e=null),this._window&&this._window.detachCamera(this);var t=e||c.director.root.mainWindow;t&&(t.attachCamera(this),this.resize(t.width,t.height),this._window=t,r.set(this._poolHandle,s.WINDOW,t.handle))},E.detachCamera=function(){this._window&&this._window.detachCamera(this)},E.screenPointToRay=function(e,i,n){if(!this._node)return null;var a=this._poolHandle,o=r.get(a,s.WIDTH),h=r.get(a,s.HEIGHT),u=this._viewport.x*o,l=this._viewport.y*h,c=this._viewport.width*o,f=this._viewport.height*h,p=this._proj===Yt.PERSPECTIVE,g=this._device.capabilities.clipSpaceSignY,v=_[this._curTransform];t.set(ei,(i-u)/c*2-1,(n-l)/f*2-1,p?1:-1);var S=ei.x,m=ei.y;return ei.x=S*v[0]+m*v[2]*g,ei.y=S*v[1]+m*v[3]*g,t.transformMat4(p?ei:e.o,ei,this._matViewProjInv),p?(this._node.getWorldPosition(ti),d.fromPoints(e,ti,ei)):t.transformQuat(e.d,t.FORWARD,this._node.worldRotation),e},E.screenToWorld=function(e,i){var n=this._poolHandle,a=r.get(n,s.WIDTH),o=r.get(n,s.HEIGHT),h=this._viewport.x*a,u=this._viewport.y*o,l=this._viewport.width*a,c=this._viewport.height*o,d=this._device.capabilities.clipSpaceSignY,p=_[this._curTransform];if(this._proj===Yt.PERSPECTIVE){t.set(e,(i.x-h)/l*2-1,(i.y-u)/c*2-1,1);var g=e.x,v=e.y;e.x=g*p[0]+v*p[2]*d,e.y=g*p[1]+v*p[3]*d,t.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(ei),t.lerp(e,ei,e,f(this._nearClip/this._farClip,1,i.z))}else{t.set(e,(i.x-h)/l*2-1,(i.y-u)/c*2-1,2*i.z-1);var S=e.x,m=e.y;e.x=S*p[0]+m*p[2]*d,e.y=S*p[1]+m*p[3]*d,t.transformMat4(e,e,this._matViewProjInv)}return e},E.worldToScreen=function(e,i){var n=this._poolHandle,a=r.get(n,s.WIDTH),o=r.get(n,s.HEIGHT),h=this._viewport.x*a,u=this._viewport.y*o,l=this._viewport.width*a,c=this._viewport.height*o,d=this._device.capabilities.clipSpaceSignY,f=_[this._curTransform];t.transformMat4(e,i,this._matViewProj);var p=e.x,g=e.y;return e.x=p*f[0]+g*f[2]*d,e.y=p*f[1]+g*f[3]*d,e.x=h+.5*(e.x+1)*l,e.y=u+.5*(e.y+1)*c,e.z=.5*e.z+.5,e},E.worldMatrixToScreen=function(e,n,r,s){i.multiply(e,this._matViewProj,n),i.multiply(e,ri[this._curTransform],e);var a=r/2,o=s/2;return i.identity(ii),i.transform(ii,ii,t.set(ei,a,o,0)),i.scale(ii,ii,t.set(ei,a,o,1)),i.multiply(e,ii,e),e},E.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);r.set(this._poolHandle,s.EXPOSURE,.833333/Math.pow(2,e))},p(e,[{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w,r.setVec4(this._poolHandle,s.CLEAR_COLOR,e)}},{key:"viewport",get:function(){return this._viewport},set:function(e){var t=e.x,i=e.width,n=e.height,a=this._device.capabilities.clipSpaceSignY<0?1-e.y-n:e.y;switch(this._device.surfaceTransform){case u.ROTATE_90:this._viewport.x=1-a-n,this._viewport.y=t,this._viewport.width=n,this._viewport.height=i;break;case u.ROTATE_180:this._viewport.x=1-t-i,this._viewport.y=1-a-n,this._viewport.width=i,this._viewport.height=n;break;case u.ROTATE_270:this._viewport.x=a,this._viewport.y=1-t-i,this._viewport.width=n,this._viewport.height=i;break;case u.IDENTITY:this._viewport.x=t,this._viewport.y=a,this._viewport.width=i,this._viewport.height=n}r.setVec4(this._poolHandle,s.VIEW_PORT,this._viewport),this.resize(this.width,this.height)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return r.get(this._poolHandle,s.WIDTH)}},{key:"height",get:function(){return r.get(this._poolHandle,s.HEIGHT)}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView},set:function(e){this._matView=e,r.setMat4(this._poolHandle,s.MAT_VIEW,this._matView)}},{key:"matViewInv",get:function(){return this._matViewInv||this._node.worldMatrix},set:function(e){this._matViewInv=e}},{key:"matProj",get:function(){return this._matProj},set:function(e){this._matProj=e,r.setMat4(this._poolHandle,s.MAT_PROJ,this._matProj)}},{key:"matProjInv",get:function(){return this._matProjInv},set:function(e){this._matProjInv=e,r.setMat4(this._poolHandle,s.MAT_PROJ_INV,this._matProjInv)}},{key:"matViewProj",get:function(){return this._matViewProj},set:function(e){this._matViewProj=e,r.setMat4(this._poolHandle,s.MAT_VIEW_PROJ,this._matViewProj)}},{key:"matViewProjInv",get:function(){return this._matViewProjInv},set:function(e){this._matViewProjInv=e,r.setMat4(this._poolHandle,s.MAT_VIEW_PROJ_INV,this._matViewProjInv)}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e,l(this._frustumHandle,e)}},{key:"window",get:function(){return this._window},set:function(e){this._window=e,e&&r.set(this._poolHandle,s.WINDOW,e.handle)}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e,r.setVec3(this._poolHandle,s.FORWARD,this._forward)}},{key:"position",get:function(){return this._position},set:function(e){this._position=e,r.setVec3(this._poolHandle,s.POSITION,this._position)}},{key:"visibility",get:function(){return r.get(this._poolHandle,s.VISIBILITY)},set:function(e){r.set(this._poolHandle,s.VISIBILITY,e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=Zt[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=Jt[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=$t[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(e){this._ec=e}},{key:"exposure",get:function(){return r.get(this._poolHandle,s.EXPOSURE)}},{key:"clearFlag",get:function(){return r.get(this._poolHandle,s.CLEAR_FLAGS)},set:function(e){r.set(this._poolHandle,s.CLEAR_FLAGS,e)}},{key:"clearDepth",get:function(){return r.get(this._poolHandle,s.CLEAR_DEPTH)},set:function(e){r.set(this._poolHandle,s.CLEAR_DEPTH,e)}},{key:"clearStencil",get:function(){return r.get(this._poolHandle,s.CLEAR_STENCIL)},set:function(e){r.set(this._poolHandle,s.CLEAR_STENCIL,e)}},{key:"handle",get:function(){return this._poolHandle}}]),e}()),function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(Kt||(Kt=e("L",{}))),e("n",(function(e){return 4*Math.PI*Math.PI*e*e})),e("g",function(){function e(){this._baked=!1,this._color=new t(1,1,1),this._colorTemp=6550,this._colorTempRGB=new t(1,1,1),this._scene=null,this._node=null,this._name=null,this._handle=o}var i=e.prototype;return i.initialize=function(){this._handle=E.alloc(),E.setVec3(this._handle,w.COLOR,this._color),E.setVec3(this._handle,w.COLOR_TEMPERATURE_RGB,this._colorTempRGB),E.set(this._handle,w.TYPE,Kt.UNKNOWN)},i.attachToScene=function(e){this._scene=e},i.detachFromScene=function(){this._scene=null},i.destroy=function(){this._name=null,this._node=null,this._handle&&(E.free(this._handle),this._handle=o)},i.update=function(){},p(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e),E.setVec3(this._handle,w.COLOR,e)}},{key:"useColorTemperature",get:function(){return 1===E.get(this._handle,w.USE_COLOR_TEMPERATURE)},set:function(e){E.set(this._handle,w.USE_COLOR_TEMPERATURE,e?1:0)}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,si(this._colorTempRGB,this._colorTemp),E.setVec3(this._handle,w.COLOR_TEMPERATURE_RGB,this._colorTempRGB)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=T.ROTATION,E.set(this._handle,w.NODE,this._node.handle))}},{key:"type",get:function(){return E.get(this._handle,w.TYPE)}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"handle",get:function(){return this._handle}}]),e}()),y(O,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]);var ai=function(){function e(){this.support=void 0,this._isStarted=!1,this._accelMode="normal",this._eventTarget=new A,this._didAccelerateFunc=void 0,this.support=!0,this._didAccelerateFunc=this._didAccelerate.bind(this)}var t=e.prototype;return t._registerEvent=function(){I.onAccelerometerChange(this._didAccelerateFunc)},t._unregisterEvent=function(){I.offAccelerometerChange(this._didAccelerateFunc)},t._didAccelerate=function(e){var t={type:O.DEVICEMOTION,x:e.x,y:e.y,z:e.z,timestamp:performance.now()};this._eventTarget.emit(O.DEVICEMOTION,t)},t.start=function(){var e=this;this._registerEvent(),I.startAccelerometer({interval:this._accelMode,success:function(){e._isStarted=!0}})},t.stop=function(){var e=this;I.stopAccelerometer({success:function(){e._isStarted=!1},fail:function(){console.error("failed to stop accelerometer")}}),this._unregisterEvent()},t.setInterval=function(e){this._accelMode=e>=200?"normal":e>=60?"ui":"game",this._isStarted&&(this.stop(),this.start())},t.onChange=function(e){this._eventTarget.on(O.DEVICEMOTION,e)},e}(),oi=function(){function e(){this.support=void 0,this.support=!0}var t=e.prototype;return t.show=function(){throw new Error("Method not implemented.")},t.hide=function(){throw new Error("Method not implemented.")},t.onChange=function(){throw new Error("Method not implemented.")},t.onComplete=function(){throw new Error("Method not implemented.")},t.offChange=function(){throw new Error("Method not implemented.")},t.offComplete=function(){throw new Error("Method not implemented.")},e}(),hi=function(){function e(){this.support=void 0,this._eventTarget=new A,this.support=!1}var t=e.prototype;return t.onDown=function(e){this._eventTarget.on(O.KEY_DOWN,e)},t.onUp=function(e){this._eventTarget.on(O.KEY_UP,e)},e}(),ui=function(){function e(){this.support=void 0,this._eventTarget=new A,this.support=!1}var t=e.prototype;return t.onDown=function(e){this._eventTarget.on(O.MOUSE_DOWN,e)},t.onMove=function(e){this._eventTarget.on(O.MOUSE_MOVE,e)},t.onUp=function(e){this._eventTarget.on(O.MOUSE_UP,e)},t.onWheel=function(e){this._eventTarget.on(O.MOUSE_WHEEL,e)},e}(),li=function(){function e(){this.support=void 0,this._eventTarget=new A,this.support=!0,this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){I.onTouchStart(this._createCallback(O.TOUCH_START)),I.onTouchMove(this._createCallback(O.TOUCH_MOVE)),I.onTouchEnd(this._createCallback(O.TOUCH_END)),I.onTouchCancel(this._createCallback(O.TOUCH_CANCEL))},t._createCallback=function(e){var t=this;return function(i){for(var n=I.getSystemInfoSync(),r=[],s=i.changedTouches.length,a=0;a<s;++a){var o=i.changedTouches[a],h=t._getLocation(o),u={identifier:o.identifier,x:h.x,y:n.windowHeight-h.y,force:o.force};r.push(u)}var l={type:e,changedTouches:r,timestamp:performance.now()};t._eventTarget.emit(e,l)}},t._getLocation=function(e){return new b(e.clientX,e.clientY)},t.onStart=function(e){this._eventTarget.on(O.TOUCH_START,e)},t.onMove=function(e){this._eventTarget.on(O.TOUCH_MOVE,e)},t.onEnd=function(e){this._eventTarget.on(O.TOUCH_END,e)},t.onCancel=function(e){this._eventTarget.on(O.TOUCH_CANCEL,e)},e}(),ci=new(function(){function e(){this._touch=new li,this._mouse=new ui,this._keyboard=new hi,this._accelerometer=new ai,this._inputBox=new oi,this._inputEventList=[],this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){},t._pushEvent=function(e){this._inputEventList.push(e)},t.pollEvent=function(){return this._inputEventList.shift()},e}()),_i=new b,di=e("E",function(e){function t(i,n,r){var s;return(s=e.call(this,D.MOUSE,n)||this).movementX=0,s.movementY=0,s.eventType=void 0,s._button=t.BUTTON_MISSING,s._x=0,s._y=0,s._prevX=0,s._prevY=0,s._scrollX=0,s._scrollY=0,s.eventType=i,r&&(s._prevX=r.x,s._prevY=r.y),s}R(t,e);var i=t.prototype;return i.setScrollData=function(e,t){this._scrollX=e,this._scrollY=t},i.getScrollX=function(){return this._scrollX},i.getScrollY=function(){return this._scrollY},i.setLocation=function(e,t){this._x=e,this._y=t},i.getLocation=function(e){return e||(e=new b),b.set(e,this._x,this._y),e},i.getLocationInView=function(e){return e||(e=new b),b.set(e,this._x,c.view._designResolutionSize.height-this._y),e},i.getUILocation=function(e){return e||(e=new b),b.set(e,this._x,this._y),c.view._convertPointWithScale(e),e},i.getPreviousLocation=function(e){return e||(e=new b),b.set(e,this._prevX,this._prevY),e},i.getUIPreviousLocation=function(e){return e||(e=new b),b.set(e,this._prevX,this._prevY),c.view._convertPointWithScale(e),e},i.getDelta=function(e){return e||(e=new b),b.set(e,this._x-this._prevX,this._y-this._prevY),e},i.getDeltaX=function(){return this._x-this._prevX},i.getDeltaY=function(){return this._y-this._prevY},i.getUIDelta=function(e){return e||(e=new b),b.set(e,(this._x-this._prevX)/c.view.getScaleX(),(this._y-this._prevY)/c.view.getScaleY()),e},i.getUIDeltaX=function(){return(this._x-this._prevX)/c.view.getScaleX()},i.getUIDeltaY=function(){return(this._y-this._prevY)/c.view.getScaleY()},i.setButton=function(e){this._button=e},i.getButton=function(){return this._button},i.getLocationX=function(){return this._x},i.getLocationY=function(){return this._y},i.getUILocationX=function(){var e=c.view.getViewportRect();return(this._x-e.x)/c.view.getScaleX()},i.getUILocationY=function(){var e=c.view.getViewportRect();return(this._y-e.y)/c.view.getScaleY()},t}(D));di.BUTTON_MISSING=-1,di.BUTTON_LEFT=0,di.BUTTON_RIGHT=2,di.BUTTON_MIDDLE=1,di.BUTTON_4=3,di.BUTTON_5=4,di.BUTTON_6=5,di.BUTTON_7=6,di.BUTTON_8=7;var fi=e("k",function(e){function t(t,i,n,r){var s;return(s=e.call(this,D.TOUCH,i)||this).touch=null,s.simulate=!1,s._eventCode=void 0,s._touches=void 0,s._allTouches=void 0,s._eventCode=n||"",s._touches=t||[],s._allTouches=r||[],s}R(t,e);var i=t.prototype;return i.getEventCode=function(){return this._eventCode},i.getTouches=function(){return this._touches},i.getAllTouches=function(){return this._allTouches},i.setLocation=function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)},i.getLocation=function(e){return this.touch?this.touch.getLocation(e):new b},i.getUILocation=function(e){return this.touch?this.touch.getUILocation(e):new b},i.getLocationInView=function(e){return this.touch?this.touch.getLocationInView(e):new b},i.getPreviousLocation=function(e){return this.touch?this.touch.getPreviousLocation(e):new b},i.getStartLocation=function(e){return this.touch?this.touch.getStartLocation(e):new b},i.getUIStartLocation=function(e){return this.touch?this.touch.getUIStartLocation(e):new b},i.getID=function(){return this.touch?this.touch.getID():null},i.getDelta=function(e){return this.touch?this.touch.getDelta(e):new b},i.getUIDelta=function(e){return this.touch?this.touch.getUIDelta(e):new b},i.getDeltaX=function(){return this.touch?this.touch.getDelta(_i).x:0},i.getDeltaY=function(){return this.touch?this.touch.getDelta(_i).y:0},i.getLocationX=function(){return this.touch?this.touch.getLocationX():0},i.getLocationY=function(){return this.touch?this.touch.getLocationY():0},t}(D));fi.MAX_TOUCHES=5;var pi=e("l",function(e){function t(t,i){var n;return(n=e.call(this,D.ACCELERATION,i)||this).acc=void 0,n.acc=t,n}return R(t,e),t}(D)),gi=e("m",function(e){function t(t,i,n){var r;return(r=e.call(this,D.KEYBOARD,n)||this).keyCode=void 0,r.rawEvent=void 0,r.isPressed=void 0,"number"==typeof t?r.keyCode=t:(r.keyCode=t.keyCode,r.rawEvent=t),r.isPressed=i,r}return R(t,e),t}(D));D.EventMouse=di,D.EventTouch=fi,D.EventAcceleration=pi,D.EventKeyboard=gi;var vi=new b,Si=e("T",function(){function e(e,t,i){void 0===i&&(i=0),this._point=new b,this._prevPoint=new b,this._lastModified=0,this._id=0,this._startPoint=new b,this._startPointCaptured=!1,this.setTouchInfo(i,e,t)}var t=e.prototype;return t.getLocation=function(e){return e||(e=new b),e.set(this._point.x,this._point.y),e},t.getLocationX=function(){return this._point.x},t.getLocationY=function(){return this._point.y},t.getUILocation=function(e){return e||(e=new b),e.set(this._point.x,this._point.y),c.view._convertPointWithScale(e),e},t.getUILocationX=function(){var e=c.view.getViewportRect();return(this._point.x-e.x)/c.view.getScaleX()},t.getUILocationY=function(){var e=c.view.getViewportRect();return(this._point.y-e.y)/c.view.getScaleY()},t.getPreviousLocation=function(e){return e||(e=new b),e.set(this._prevPoint.x,this._prevPoint.y),e},t.getUIPreviousLocation=function(e){return e||(e=new b),e.set(this._prevPoint.x,this._prevPoint.y),c.view._convertPointWithScale(e),e},t.getStartLocation=function(e){return e||(e=new b),e.set(this._startPoint.x,this._startPoint.y),e},t.getUIStartLocation=function(e){return e||(e=new b),e.set(this._startPoint.x,this._startPoint.y),c.view._convertPointWithScale(e),e},t.getDelta=function(e){return e||(e=new b),e.set(this._point),e.subtract(this._prevPoint),e},t.getUIDelta=function(e){return e||(e=new b),vi.set(this._point),vi.subtract(this._prevPoint),e.set(c.view.getScaleX(),c.view.getScaleY()),b.divide(e,vi,e),e},t.getLocationInView=function(e){return e||(e=new b),e.set(this._point.x,c.view._designResolutionSize.height-this._point.y),e},t.getPreviousLocationInView=function(e){return e||(e=new b),e.set(this._prevPoint.x,c.view._designResolutionSize.height-this._prevPoint.y),e},t.getStartLocationInView=function(e){return e||(e=new b),e.set(this._startPoint.x,c.view._designResolutionSize.height-this._startPoint.y),e},t.getID=function(){return this._id},t.setTouchInfo=function(e,t,i){void 0===e&&(e=0),this._prevPoint=this._point,this._point=new b(t||0,i||0),this._id=e,this._startPointCaptured||(this._startPoint=new b(this._point),this._startPointCaptured=!0)},t.setPoint=function(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=c.director.getCurrentTime()},t.setPrevPoint=function(e,t){this._prevPoint="object"==typeof e?new b(e.x,e.y):new b(e||0,t||0),this._lastModified=c.director.getCurrentTime()},p(e,[{key:"lastModified",get:function(){return this._lastModified}}]),e}());c.Touch=Si;var mi=function(e,t,i,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=i,this.timestamp=n},Ei=N.TOUCH_TIMEOUT,wi=new b,Ti=new b,yi=new(function(){function e(){this._isRegisterEvent=!1,this._preTouchPoint=new b,this._prevMousePoint=new b,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._glView=null}var t=e.prototype;return t.handleTouchesBegin=function(e){for(var t=[],i=this._touchesIntegerDict,n=0;n<e.length;++n){var r=e[n],s=r.getID();if(null!==s&&void 0===i[s]){var a=this._getUnUsedIndex();if(-1===a){F(2300,a);continue}r.getLocation(wi);var o=new Si(wi.x,wi.y,s);this._touches[a]=o,r.getPreviousLocation(wi),o.setPrevPoint(wi),i[s]=a,t.push(o)}}if(t.length>0){var h=new fi(t,!1,O.TOUCH_START,N.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);C.dispatchEvent(h)}},t.handleTouchesMove=function(e){for(var t=[],i=this._touches,n=0;n<e.length;++n){var r=e[n],s=r.getID();if(null!==s){var a=this._touchesIntegerDict[s];void 0!==a&&i[a]&&(r.getLocation(wi),i[a].setPoint(wi),r.getPreviousLocation(wi),i[a].setPrevPoint(wi),t.push(i[a]))}}if(t.length>0){var o=new fi(t,!1,O.TOUCH_MOVE,N.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);C.dispatchEvent(o)}},t.handleTouchesEnd=function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var i=new fi(t,!1,O.TOUCH_END,N.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);C.dispatchEvent(i)}this._preTouchPool.length=0},t.handleTouchesCancel=function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var i=new fi(t,!1,O.TOUCH_CANCEL,N.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);C.dispatchEvent(i)}this._preTouchPool.length=0},t.getSetOfTouchesEndOrCancel=function(e){for(var t=[],i=this._touches,n=this._touchesIntegerDict,r=0;r<e.length;++r){var s=e[r],a=s.getID();if(null!==a){var o=n[a];void 0!==o&&i[o]&&(s.getLocation(wi),i[o].setPoint(wi),s.getPreviousLocation(wi),i[o].setPrevPoint(wi),t.push(i[o]),this._removeUsedIndexBit(o),delete n[a])}}return t},t._getPreTouch=function(e){for(var t=null,i=this._preTouchPool,n=e.getID(),r=i.length-1;r>=0;r--)if(i[r].getID()===n){t=i[r];break}return t||(t=e),t},t._setPreTouch=function(e){for(var t=!1,i=this._preTouchPool,n=e.getID(),r=i.length-1;r>=0;r--)if(i[r].getID()===n){i[r]=e,t=!0;break}t||(i.length<=50?i.push(e):(i[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))},t._getViewPixelRatio=function(){return this._glView?this._glView._devicePixelRatio:1},t._getTouch=function(e){var t=this._preTouchPoint,i=this._getViewPixelRatio(),n=e.x*i,r=e.y*i,s=new Si(n,r,0);return s.setPrevPoint(t.x,t.y),t.x=n,t.y=r,s},t._getMouseEvent=function(e){var t=this._prevMousePoint,i=new di(e.type,!1,t),n=this._getViewPixelRatio();return t.x=e.x*n,t.y=e.y*n,c.GAME_VIEW&&(t.x/=c.gameView.canvas.width/c.game.canvas.width,t.y/=c.gameView.canvas.height/c.game.canvas.height),i.setLocation(t.x,t.y),i.setButton(e.button),e.movementX&&(i.movementX=e.movementX),e.movementY&&(i.movementY=e.movementY),i},t._getTouchList=function(e){for(var t=[],i=this._preTouchPoint,n=e.changedTouches.length,r=this._getViewPixelRatio(),s=0;s<n;s++){var a=e.changedTouches[s],o=a.x*r,h=a.y*r,u=new Si(o,h,a.identifier);if(this._getPreTouch(u).getLocation(Ti),u.setPrevPoint(Ti.x,Ti.y),this._setPreTouch(u),i.x=o,i.y=h,t.push(u),!N.ENABLE_MULTI_TOUCH)break}return t},t._getUnUsedIndex=function(){for(var e=this._indexBitsUsed,t=c.director.getCurrentTime(),i=0;i<this._maxTouches;i++){if(!(1&e))return this._indexBitsUsed|=1<<i,i;var n=this._touches[i];if(t-n.lastModified>Ei){this._removeUsedIndexBit(i);var r=n.getID();return null!==r&&delete this._touchesIntegerDict[r],i}e>>=1}return-1},t._removeUsedIndexBit=function(e){if(!(e<0||e>=this._maxTouches)){var t=1<<e;t=~t,this._indexBitsUsed&=t}},t._getUsefulTouches=function(){var e=[],t=this._touchesIntegerDict;for(var i in t){var n=t[parseInt(i)];if(null!=n){var r=this._touches[n];e.push(r)}}return e},t.setAccelerometerEnabled=function(e){e?ci._accelerometer.start():ci._accelerometer.stop()},t.setAccelerometerInterval=function(e){ci._accelerometer.setInterval(e)},t.registerSystemEvent=function(){this._isRegisterEvent||(this._glView=c.view,ci._mouse.support&&this._registerMouseEvents(),ci._touch.support&&this._registerTouchEvents(),ci._keyboard.support&&this._registerKeyboardEvent(),ci._accelerometer.support&&this._registerAccelerometerEvent(),this._isRegisterEvent=!0)},t._registerMouseEvents=function(){var e=this;ci._mouse.onDown((function(t){var i=e._getMouseEvent(t),n=e._getTouch(t);e.handleTouchesBegin([n]),C.dispatchEvent(i)})),ci._mouse.onMove((function(t){var i=e._getMouseEvent(t),n=e._getTouch(t);e.handleTouchesMove([n]),C.dispatchEvent(i)})),ci._mouse.onUp((function(t){var i=e._getMouseEvent(t),n=e._getTouch(t);e.handleTouchesEnd([n]),C.dispatchEvent(i)})),ci._mouse.onWheel((function(t){var i=e._getMouseEvent(t);i.setScrollData(t.deltaX,t.deltaY),C.dispatchEvent(i)}))},t._registerTouchEvents=function(){var e=this;ci._touch.onStart((function(t){var i=e._getTouchList(t);e.handleTouchesBegin(i)})),ci._touch.onMove((function(t){var i=e._getTouchList(t);e.handleTouchesMove(i)})),ci._touch.onEnd((function(t){var i=e._getTouchList(t);e.handleTouchesEnd(i)})),ci._touch.onCancel((function(t){var i=e._getTouchList(t);e.handleTouchesCancel(i)}))},t._registerKeyboardEvent=function(){ci._keyboard.onDown((function(e){C.dispatchEvent(new gi(e.code,!0))})),ci._keyboard.onUp((function(e){C.dispatchEvent(new gi(e.code,!1))}))},t._registerAccelerometerEvent=function(){ci._accelerometer.onChange((function(e){var t=e.x,i=e.y,n=e.z,r=e.timestamp;C.dispatchEvent(new pi(new mi(t,i,n,r)))}))},e}());c.internal.inputManager=yi;var Oi=null,Ai=null,Ii=null,bi=null,Ri=e("i",function(e){function t(){return e.call(this)||this}R(t,e);var i=t.prototype;return i.setAccelerometerEnabled=function(e){e&&window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(e){F(3520,e),yi.setAccelerometerEnabled("granted"===e)})).catch((function(e){P(3521,e.message),yi.setAccelerometerEnabled(!1)})):yi.setAccelerometerEnabled(e)},i.setAccelerometerInterval=function(e){yi.setAccelerometerInterval(e)},i.on=function(t,i,n,r){return e.prototype.on.call(this,t,i,n,r),t!==O.KEY_DOWN&&t!==O.KEY_UP||Oi||(Oi=B.create({event:B.KEYBOARD,onKeyPressed:function(e,t){t.type=O.KEY_DOWN,Ui.emit(t.type,t)},onKeyReleased:function(e,t){t.type=O.KEY_UP,Ui.emit(t.type,t)}}),C.addListener(Oi,256)),t===O.DEVICEMOTION&&(Ai||(Ai=B.create({event:B.ACCELERATION,callback:function(e,t){t.type=O.DEVICEMOTION,c.systemEvent.emit(t.type,t)}}),C.addListener(Ai,256))),t!==O.TOUCH_START&&t!==O.TOUCH_MOVE&&t!==O.TOUCH_END&&t!==O.TOUCH_CANCEL||Ii||(Ii=B.create({event:B.TOUCH_ONE_BY_ONE,onTouchBegan:function(e,t){return t.type=O.TOUCH_START,c.systemEvent.emit(t.type,e,t),!0},onTouchMoved:function(e,t){t.type=O.TOUCH_MOVE,c.systemEvent.emit(t.type,e,t)},onTouchEnded:function(e,t){t.type=O.TOUCH_END,c.systemEvent.emit(t.type,e,t)},onTouchCancelled:function(e,t){t.type=O.TOUCH_CANCEL,c.systemEvent.emit(t.type,e,t)}}),C.addListener(Ii,256)),t!==O.MOUSE_DOWN&&t!==O.MOUSE_MOVE&&t!==O.MOUSE_UP&&t!==O.MOUSE_WHEEL||bi||(bi=B.create({event:B.MOUSE,onMouseDown:function(e){e.type=O.MOUSE_DOWN,c.systemEvent.emit(e.type,e)},onMouseMove:function(e){e.type=O.MOUSE_MOVE,c.systemEvent.emit(e.type,e)},onMouseUp:function(e){e.type=O.MOUSE_UP,c.systemEvent.emit(e.type,e)},onMouseScroll:function(e){e.type=O.MOUSE_WHEEL,c.systemEvent.emit(e.type,e)}}),C.addListener(bi,256)),i},i.off=function(t,i,n){if(e.prototype.off.call(this,t,i,n),Oi&&(t===O.KEY_DOWN||t===O.KEY_UP)){var r=this.hasEventListener(O.KEY_DOWN),s=this.hasEventListener(O.KEY_UP);r||s||(C.removeListener(Oi),Oi=null)}if(Ai&&t===O.DEVICEMOTION&&(C.removeListener(Ai),Ai=null),Ii&&(t===O.TOUCH_START||t===O.TOUCH_MOVE||t===O.TOUCH_END||t===O.TOUCH_CANCEL)){var a=this.hasEventListener(O.TOUCH_START),o=this.hasEventListener(O.TOUCH_MOVE),h=this.hasEventListener(O.TOUCH_END),u=this.hasEventListener(O.TOUCH_CANCEL);a||o||h||u||(C.removeListener(Ii),Ii=null)}if(bi&&(t===O.MOUSE_DOWN||t===O.MOUSE_MOVE||t===O.MOUSE_UP||t===O.MOUSE_WHEEL)){var l=this.hasEventListener(O.MOUSE_DOWN),c=this.hasEventListener(O.MOUSE_MOVE),_=this.hasEventListener(O.MOUSE_UP),d=this.hasEventListener(O.MOUSE_WHEEL);l||c||_||d||(C.removeListener(bi),bi=null)}},t}(A));Ri.EventType=O,c.SystemEvent=Ri;var Di,Fi,Ni,Ci,Pi,Bi,Li,Mi,xi,Hi,Ui=e("j",new Ri);c.systemEvent=Ui;var zi,Gi,Vi,Wi,ki,Qi,Yi,qi,Xi,ji,Ki,Zi,Ji,$i=e("r",(Di=L("RenderStage"),Fi=U(),Ni=U(),Ci=U(),Di((Hi=function(){function e(){x(this,"_name",Li,this),x(this,"_priority",Mi,this),x(this,"_tag",xi,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},p(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}}]),e}(),Li=M((Bi=Hi).prototype,"_name",[Fi,H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Mi=M(Bi.prototype,"_priority",[Ni,H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xi=M(Bi.prototype,"_tag",[Ci,H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Pi=Bi))||Pi));c.RenderStage=$i;var en=e("q",(zi=L("RenderFlow"),Gi=U(),Vi=U(),Wi=U(),ki=U(),Qi=z([$i]),zi((Ji=function(){function e(){x(this,"_name",Xi,this),x(this,"_priority",ji,this),x(this,"_tag",Ki,this),x(this,"_stages",Zi,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},p(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),Xi=M((qi=Ji).prototype,"_name",[Gi,H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ji=M(qi.prototype,"_priority",[Vi,H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ki=M(qi.prototype,"_tag",[Wi,H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zi=M(qi.prototype,"_stages",[ki,Qi,H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Yi=qi))||Yi));c.RenderFlow=en;var tn=new t,nn=new t,rn=new t,sn=new i,an=new G,on=!1,hn=[],un=V.create(0,0,0,1),ln=new W((function(){return{model:null,depth:0}}),128),cn=new W((function(){return{model:null,depth:0}}),128);function _n(e,i){var n=0;e.node&&(t.subtract(tn,e.node.worldPosition,i.position),n=t.dot(tn,i.forward));var r=ln.alloc();return r.model=e,r.depth=n,r}function dn(e,i){var n=0;e.node&&(t.subtract(tn,e.node.worldPosition,i.position),n=t.dot(tn,i.forward));var r=cn.alloc();return r.model=e,r.depth=n,r}function fn(e,n,r,s){var a=e.pipelineSceneData.shadows;t.negate(nn,r);var o=a.sphere.radius*q.COEFFICIENT_OF_EXPANSION;return t.multiplyScalar(rn,nn,o),t.add(rn,rn,a.sphere.center),s.set(rn),i.fromRT(sn,n,rn),sn}function pn(e,n,r){var s=n.direction,a=e.normal,o=e.distance+.001,h=1/t.dot(a,s),u=s.x*h,l=s.y*h,c=s.z*h,_=a.x,d=a.y,f=a.z,p=e.matLight;p.m00=1-_*u,p.m01=-_*l,p.m02=-_*c,p.m03=0,p.m04=-d*u,p.m05=1-d*l,p.m06=-d*c,p.m07=0,p.m08=-f*u,p.m09=-f*l,p.m10=1-f*c,p.m11=0,p.m12=u*o,p.m13=l*o,p.m14=c*o,p.m15=1,i.toArray(r,p,Q.MAT_LIGHT_PLANE_PROJ_OFFSET)}function gn(e,i){var n=i.scene,r=n.mainLight,s=e.pipelineSceneData,a=s.shadows,o=s.skybox,h=s.renderObjects;ln.freeArray(h),h.length=0;var u=null;on=!1,a.enabled&&(e.pipelineUBO.updateShadowUBORange(Q.SHADOW_COLOR_OFFSET,a.shadowColor),a.type===Y.ShadowMap&&(u=e.pipelineSceneData.shadowObjects,cn.freeArray(u),u.length=0)),r&&a.type===Y.Planar&&function(e,i){var n=e.pipelineSceneData.shadows,r=i.direction,s=n.normal,a=n.distance+.001,o=1/t.dot(s,r),h=r.x*o,u=r.y*o,l=r.z*o,c=s.x,_=s.y,d=s.z,f=n.matLight;f.m00=1-c*h,f.m01=-c*u,f.m02=-c*l,f.m03=0,f.m04=-_*h,f.m05=1-_*u,f.m06=-_*l,f.m07=0,f.m08=-d*h,f.m09=-d*u,f.m10=1-d*l,f.m11=0,f.m12=h*a,f.m13=u*a,f.m14=l*a,f.m15=1,e.pipelineUBO.updateShadowUBORange(Q.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(e,r),o.enabled&&o.model&&i.clearFlag&ni&&h.push(_n(o.model,i));for(var l=n.models,c=i.visibility,_=0;_<l.length;_++){var d=l[_];if(d.enabled&&(d.node&&(c&d.node.layer)===d.node.layer||c&d.visFlags)){if(null!=u&&d.castShadow&&d.worldBounds&&(on||(an.copy(d.worldBounds),on=!0),G.merge(an,an,d.worldBounds),u.push(dn(d,i))),d.worldBounds&&!k.aabbFrustum(d.worldBounds,i.frustum))continue;h.push(_n(d,i))}}an&&G.toBoundingSphere(a.sphere,an)}var vn=new i,Sn=new i,mn=new t,En=new X,wn=function(){function e(){this._globalUBO=new Float32Array(J.COUNT),this._cameraUBO=new Float32Array($.COUNT),this._shadowUBO=new Float32Array(Q.COUNT)}e.updateGlobalUBOView=function(e,t){var i=e.device,n=c.director.root,r=t,s=Math.floor(i.width),a=Math.floor(i.height);r[J.TIME_OFFSET]=n.cumulativeTime,r[J.TIME_OFFSET+1]=n.frameTime,r[J.TIME_OFFSET+2]=c.director.getTotalFrames(),r[J.SCREEN_SIZE_OFFSET]=i.width,r[J.SCREEN_SIZE_OFFSET+1]=i.height,r[J.SCREEN_SIZE_OFFSET+2]=1/i.width,r[J.SCREEN_SIZE_OFFSET+3]=1/i.height,r[J.NATIVE_SIZE_OFFSET]=s,r[J.NATIVE_SIZE_OFFSET+1]=a,r[J.NATIVE_SIZE_OFFSET+2]=1/r[J.NATIVE_SIZE_OFFSET],r[J.NATIVE_SIZE_OFFSET+3]=1/r[J.NATIVE_SIZE_OFFSET+1]},e.updateCameraUBOView=function(e,n,r){var s=e.device,a=(r.scene?r.scene:c.director.getScene().renderScene).mainLight,o=e.pipelineSceneData,h=o.ambient,u=o.fog,l=Math.floor(s.width),_=Math.floor(s.height),d=n,f=r.exposure,p=o.isHDR,g=o.shadingScale,v=o.fpScale;if(d[$.SCREEN_SCALE_OFFSET]=r.width/l*g,d[$.SCREEN_SCALE_OFFSET+1]=r.height/_*g,d[$.SCREEN_SCALE_OFFSET+2]=1/d[$.SCREEN_SCALE_OFFSET],d[$.SCREEN_SCALE_OFFSET+3]=1/d[$.SCREEN_SCALE_OFFSET+1],d[$.EXPOSURE_OFFSET]=f,d[$.EXPOSURE_OFFSET+1]=1/f,d[$.EXPOSURE_OFFSET+2]=p?1:0,d[$.EXPOSURE_OFFSET+3]=v/f,a){if(t.toArray(d,a.direction,$.MAIN_LIT_DIR_OFFSET),t.toArray(d,a.color,$.MAIN_LIT_COLOR_OFFSET),a.useColorTemperature){var S=a.colorTemperatureRGB;d[$.MAIN_LIT_COLOR_OFFSET]*=S.x,d[$.MAIN_LIT_COLOR_OFFSET+1]*=S.y,d[$.MAIN_LIT_COLOR_OFFSET+2]*=S.z}d[$.MAIN_LIT_COLOR_OFFSET+3]=p?a.illuminance*v:a.illuminance*f}else t.toArray(d,t.UNIT_Z,$.MAIN_LIT_DIR_OFFSET),X.toArray(d,X.ZERO,$.MAIN_LIT_COLOR_OFFSET);var m=h.colorArray;m[3]=p?h.skyIllum*v:h.skyIllum*f,d.set(m,$.AMBIENT_SKY_OFFSET),d.set(h.albedoArray,$.AMBIENT_GROUND_OFFSET),i.toArray(d,r.matView,$.MAT_VIEW_OFFSET),i.toArray(d,r.node.worldMatrix,$.MAT_VIEW_INV_OFFSET),t.toArray(d,r.position,$.CAMERA_POS_OFFSET),i.toArray(d,r.matProj,$.MAT_PROJ_OFFSET),i.toArray(d,r.matProjInv,$.MAT_PROJ_INV_OFFSET),i.toArray(d,r.matViewProj,$.MAT_VIEW_PROJ_OFFSET),i.toArray(d,r.matViewProjInv,$.MAT_VIEW_PROJ_INV_OFFSET),d[$.CAMERA_POS_OFFSET+3]=this.getCombineSignY(),d.set(u.colorArray,$.GLOBAL_FOG_COLOR_OFFSET),d[$.GLOBAL_FOG_BASE_OFFSET]=u.fogStart,d[$.GLOBAL_FOG_BASE_OFFSET+1]=u.fogEnd,d[$.GLOBAL_FOG_BASE_OFFSET+2]=u.fogDensity,d[$.GLOBAL_FOG_ADD_OFFSET]=u.fogTop,d[$.GLOBAL_FOG_ADD_OFFSET+1]=u.fogRange,d[$.GLOBAL_FOG_ADD_OFFSET+2]=u.fogAtten},e.updateShadowUBOView=function(e,n,r){var s=e.device,a=r.scene.mainLight,o=e.pipelineSceneData.shadows,h=n;if(o.enabled){if(a&&o.type===Y.ShadowMap){var u,l=0,c=0,_=0;if(o.autoAdapt){u=fn(e,a.node.getWorldRotation(),a.direction,mn);var d=o.sphere.radius;l=d*o.aspect,c=d;var f=t.distance(o.sphere.center,mn);_=Math.min(f*q.COEFFICIENT_OF_EXPANSION,q.MAX_FAR)}else u=a.node.getWorldMatrix(),l=o.orthoSize*o.aspect,c=o.orthoSize,_=o.far;i.toArray(h,u,Q.MAT_LIGHT_VIEW_OFFSET),i.invert(vn,u),i.ortho(Sn,-l,l,-c,c,o.near,_,s.capabilities.clipSpaceMinZ,s.capabilities.clipSpaceSignY),i.multiply(Sn,Sn,vn),i.toArray(h,Sn,Q.MAT_LIGHT_VIEW_PROJ_OFFSET);var p=ie(s),g=o.linear&&p?1:0;h[Q.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+0]=o.near,h[Q.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+1]=_,h[Q.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+2]=g,h[Q.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+3]=o.selfShadow?1:0,h[Q.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=o.size.x,h[Q.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=o.size.y,h[Q.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=o.pcf,h[Q.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=o.bias;var v=o.packing?1:p?0:1;h[Q.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,h[Q.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=v,h[Q.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=o.normalBias,h[Q.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else a&&o.type===Y.Planar&&pn(o,a,h);te.toArray(h,o.shadowColor,Q.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,n,r){var s,a=e.device,o=e.pipelineSceneData.shadows,h=n,u=ie(a),l=o.linear&&u?1:0,c=o.packing?1:u?0:1,_=0,d=0,f=0;switch(r.type){case Kt.DIRECTIONAL:if(r.update(),o.autoAdapt){var p=r.node;p&&(s=fn(e,p.getWorldRotation(),r.direction,mn));var g=o.sphere.radius;_=g*o.aspect,d=g;var v=t.distance(o.sphere.center,mn);f=Math.min(v*q.COEFFICIENT_OF_EXPANSION,q.MAX_FAR)}else s=r.node.getWorldMatrix(),_=o.orthoSize*o.aspect,d=o.orthoSize,f=o.far;i.toArray(h,s,Q.MAT_LIGHT_VIEW_OFFSET),i.invert(vn,s),En.set(o.near,f,l,o.selfShadow?1:0),X.toArray(h,En,Q.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET),En.set(0,c,o.normalBias,0),X.toArray(h,En,Q.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),i.ortho(Sn,-_,_,-d,d,o.near,f,a.capabilities.clipSpaceMinZ,a.capabilities.clipSpaceSignY);break;case Kt.SPOT:i.toArray(h,r.node.getWorldMatrix(),Q.MAT_LIGHT_VIEW_OFFSET),i.invert(vn,r.node.getWorldMatrix()),En.set(.01,r.range,l,o.selfShadow?1:0),X.toArray(h,En,Q.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET),En.set(1,c,o.normalBias,0),X.toArray(h,En,Q.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),i.perspective(Sn,r.spotAngle,r.aspect,.001,r.range)}i.multiply(Sn,Sn,vn),i.toArray(h,Sn,Q.MAT_LIGHT_VIEW_PROJ_OFFSET),En.set(o.size.x,o.size.y,o.pcf,o.bias),X.toArray(h,En,Q.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),te.toArray(h,o.shadowColor,Q.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var n=e.prototype;return n._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},n.activate=function(e,t){this._device=e,this._pipeline=t;var i=this._pipeline.descriptorSet;this._initCombineSignY();var n=e.createBuffer(new j(K.UNIFORM|K.TRANSFER_DST,Z.HOST|Z.DEVICE,J.SIZE,J.SIZE));i.bindBuffer(J.BINDING,n);var r=e.createBuffer(new j(K.UNIFORM|K.TRANSFER_DST,Z.HOST|Z.DEVICE,$.SIZE,$.SIZE));i.bindBuffer($.BINDING,r);var s=e.createBuffer(new j(K.UNIFORM|K.TRANSFER_DST,Z.HOST|Z.DEVICE,Q.SIZE,Q.SIZE));i.bindBuffer(Q.BINDING,s)},n.updateGlobalUBO=function(){var t=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,n=this._pipeline.commandBuffers;i.update(),e.updateGlobalUBOView(this._pipeline,this._globalUBO),n[0].updateBuffer(i.getBuffer(J.BINDING),this._globalUBO),t.bindBuffer(J.BINDING,i.getBuffer(J.BINDING)),t.update()},n.updateCameraUBO=function(t){var i=this._pipeline.globalDSManager,n=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),r[0].updateBuffer(n.getBuffer($.BINDING),this._cameraUBO),i.bindBuffer($.BINDING,n.getBuffer($.BINDING)),i.update()},n.updateShadowUBO=function(t){var i=this._pipeline.pipelineSceneData;if(i.shadows.enabled){var n=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,s=i.shadowFrameBufferMap,a=t.scene.mainLight;n.update(),a&&s.has(a)&&n.bindTexture(ee,s.get(a).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,t),r[0].updateBuffer(n.getBuffer(Q.BINDING),this._shadowUBO)}},n.updateShadowUBOLight=function(t){var i=this._pipeline.descriptorSet;e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,t),i.getBuffer(Q.BINDING).update(this._shadowUBO)},n.updateShadowUBORange=function(e,t){t instanceof i?i.toArray(this._shadowUBO,t,e):t instanceof te&&te.toArray(this._shadowUBO,t,e)},n.destroy=function(){},e}();wn._combineSignY=0;var Tn=e("P",function(e){function t(t,i){var n;(n=e.call(this,t.root)||this)._parent=void 0,n._owner=void 0,n._dontNotify=!1,n._parent=t,n._owner=i,n._doInit(n._parent,!0);for(var r=0;r<n._shaderInfo.blocks.length;r++){var s=n._shaderInfo.blocks[r],a=n._blocks[s.binding],o=n._parent.blocks[s.binding];a.set(o)}n._rootBufferDirty=!0;for(var h=n._parent,u=0;u<n._shaderInfo.samplerTextures.length;u++)for(var l=n._shaderInfo.samplerTextures[u],c=0;c<l.count;c++){var _=h._descriptorSet.getSampler(l.binding,c),d=h._descriptorSet.getTexture(l.binding,c);n._descriptorSet.bindSampler(l.binding,_,c),n._descriptorSet.bindTexture(l.binding,d,c)}return e.prototype.tryCompile.call(se(n)),n}R(t,e);var i=t.prototype;return i.overridePipelineStates=function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),ne.fillPipelineInfo(this,e),ne.fillPipelineInfo(this,t),this._onStateChange()},i.tryCompile=function(t){if(t&&!re(this._defines,t))return!1;var i=e.prototype.tryCompile.call(this);return this._onStateChange(),i},i.beginChangeStatesSilently=function(){this._dontNotify=!0},i.endChangeStatesSilently=function(){this._dontNotify=!1},i._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this.batchingScheme=0},i._onStateChange=function(){this.hash=ne.getPassHash(this,this._hShaderDefault),this._owner.onPassStateChange(this._dontNotify)},p(t,[{key:"parent",get:function(){return this._parent}}]),t}(ne)),yn=e("M",function(e){function t(t){var i;return(i=e.call(this)||this)._passes=[],i._parent=void 0,i._owner=void 0,i._subModelIdx=0,i._parent=t.parent,i._owner=t.owner||null,i._subModelIdx=t.subModelIdx||0,i.copy(i._parent),i}R(t,e);var i=t.prototype;return i.recompileShaders=function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var i,n=ae(this._passes);!(i=n()).done;)i.value.tryCompile(e);else this._passes[t].tryCompile(e)},i.overridePipelineStates=function(e,t){if(this._passes&&this.effectAsset){var i=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var n=0;n<this._passes.length;n++){var r=this._passes[n],s=this._states[n]||(this._states[n]={});for(var a in e)s[a]=e[a];r.overridePipelineStates(i[r.passIndex],s)}else{var o=this._states[t]||(this._states[t]={});for(var h in e)o[h]=e[h];this._passes[t].overridePipelineStates(i[t],o)}}},i.destroy=function(){return this._doDestroy(),!0},i.onPassStateChange=function(e){this._hash=oe.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},i._createPasses=function(){var e=[],t=this._parent.passes;if(!t)return e;for(var i=0;i<t.length;++i)e.push(new Tn(t[i],this));return e},p(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),t}(oe)),On=null,An=null,In=e("h",function(){function e(){this._envmap=null,this._globalDSManager=null,this._model=null,this._default=null,this._handle=o,this._handle=he.alloc()}var t=e.prototype;return t.initialize=function(e){he.set(this._handle,ue.ENABLE,e.enabled?1:0),he.set(this._handle,ue.USE_IBL,e.useIBL?1:0),he.set(this._handle,ue.IS_RGBE,e.isRGBE?1:0),this._envmap=e.envmap},t.activate=function(){var e=c.director.root.pipeline,t=e.pipelineSceneData.ambient;if(this._globalDSManager=e.globalDSManager,this._default=le.get("default-cube-texture"),this._model||(this._model=c.director.root.createModel(c.renderer.scene.Model),this._model._initLocalDescriptors=function(){}),he.set(this._handle,ue.MODEL,this._model.handle),this._envmap||(this._envmap=this._default),t.albedoArray[3]=this._envmap.mipmapLevel,An)An.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE});else{var i=new oe;i.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:this.isRGBE}}),An=new yn({parent:i})}this.enabled&&(On||(On=c.utils.createMesh(c.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,On.renderingSubMeshes[0],An)),this._updateGlobalBinding(),this._updatePipeline()},t._updatePipeline=function(){var e=this.useIBL?this.isRGBE?2:1:0,t=c.director.root,i=t.pipeline;i.macros.CC_USE_IBL!==e&&(i.macros.CC_USE_IBL=e,t.onGlobalPipelineStateChanged())},t._updateGlobalBinding=function(){var e=this.envmap.getGFXTexture(),t=ce.getSampler(c.director._device,this.envmap.getSamplerHash());this._globalDSManager.bindSampler(_e,t),this._globalDSManager.bindTexture(_e,e),this._globalDSManager.update()},t.destroy=function(){this._handle&&(he.free(this._handle),this._handle=o)},p(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return he.get(this._handle,ue.ENABLE)},set:function(e){he.set(this._handle,ue.ENABLE,e?1:0),e?this.activate():this._updatePipeline()}},{key:"useIBL",get:function(){return he.get(this._handle,ue.USE_IBL)},set:function(e){he.set(this._handle,ue.USE_IBL,e?1:0),this._updatePipeline()}},{key:"isRGBE",get:function(){return he.get(this._handle,ue.IS_RGBE)},set:function(e){e&&(An&&An.recompileShaders({USE_RGBE_CUBEMAP:e}),this._model&&this._model.setSubModelMaterial(0,An)),he.set(this._handle,ue.IS_RGBE,e?1:0),this._updatePipeline()}},{key:"envmap",get:function(){return this._envmap},set:function(e){this._envmap=e||this._default,this._envmap&&(c.director.root.pipeline.pipelineSceneData.ambient.albedoArray[3]=this._envmap.mipmapLevel,this._updateGlobalBinding())}},{key:"handle",get:function(){return this._handle}}]),e}());c.Skybox=In;var bn,Rn,Dn,Fn,Nn,Cn,Pn,Bn,Ln,Mn,xn,Hn=function(){function e(){this.fog=new pe,this.ambient=new ge,this.skybox=new In,this.shadows=new q,this.renderObjects=[],this.shadowObjects=[],this.shadowFrameBufferMap=new Map,this._handle=de.alloc(),de.set(this._handle,fe.AMBIENT,this.ambient.handle),de.set(this._handle,fe.SKYBOX,this.skybox.handle),de.set(this._handle,fe.FOG,this.fog.handle),de.set(this._handle,fe.SHADOW,this.shadows.handle),de.set(this._handle,fe.IS_HDR,0),de.set(this._handle,fe.SHADING_SCALE,1),de.set(this._handle,fe.FP_SCALE,1/1024)}var t=e.prototype;return t.initDeferredPassInfo=function(){var e=le.get("builtin-deferred-material");if(e){var t=e.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}var i=le.get("builtin-post-process-material");if(i){var n=i.passes[0];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}if(e){var r=e.passes[0];de.set(this._handle,fe.DEFERRED_LIGHT_PASS,r.handle),de.set(this._handle,fe.DEFERRED_LIGHT_PASS_SHADER,r.getShaderVariant())}if(i){var s=i.passes[0];de.set(this._handle,fe.DEFERRED_POST_PASS,s.handle),de.set(this._handle,fe.DEFERRED_POST_PASS_SHADER,s.getShaderVariant())}},t.activate=function(e,t){return this._device=e,this._pipeline=t,this.initDeferredPassInfo(),!0},t.destroy=function(){this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this._handle&&de.free(this._handle)},p(e,[{key:"handle",get:function(){return this._handle}},{key:"isHDR",get:function(){return de.get(this._handle,fe.IS_HDR)},set:function(e){de.set(this._handle,fe.IS_HDR,e?1:0)}},{key:"shadingScale",get:function(){return de.get(this._handle,fe.SHADING_SCALE)},set:function(e){de.set(this._handle,fe.SHADING_SCALE,e)}},{key:"fpScale",get:function(){return de.get(this._handle,fe.FP_SCALE)},set:function(e){de.set(this._handle,fe.FP_SCALE,e)}},{key:"deferredLightPassHandle",get:function(){return de.get(this._handle,fe.DEFERRED_LIGHT_PASS)}},{key:"deferredLightPassShaderHandle",get:function(){return de.get(this._handle,fe.DEFERRED_LIGHT_PASS_SHADER)}},{key:"deferredPostPassHandle",get:function(){return de.get(this._handle,fe.DEFERRED_POST_PASS)}},{key:"deferredPostPassShaderHandle",get:function(){return de.get(this._handle,fe.DEFERRED_POST_PASS_SHADER)}}]),e}(),Un=[ve.LINEAR,ve.LINEAR,ve.NONE,Se.CLAMP,Se.CLAMP,Se.CLAMP],zn=[ve.POINT,ve.POINT,ve.NONE,Se.CLAMP,Se.CLAMP,Se.CLAMP],Gn=function(){function e(e){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=e.device;var t=we(Un);this._linearSampler=ce.getSampler(this._device,t);var i=we(zn);this._pointSampler=ce.getSampler(this._device,i);var n=new Te(ye.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(n),this._globalDescriptorSet=this._device.createDescriptorSet(new me(this._descriptorSetLayout))}var t=e.prototype;return t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindBuffer(e,t),n=i.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindSampler(e,t),n=i.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindTexture(e,t),n=i.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var i=this._globalDescriptorSet,n=t.createDescriptorSet(new me(this._descriptorSetLayout));this._descriptorSetMap.set(e,n);for(var r=Ee.UBO_GLOBAL;r<Ee.COUNT;r++)n.bindBuffer(r,i.getBuffer(r)),n.bindSampler(r,i.getSampler(r)),n.bindTexture(r,i.getTexture(r));var s=t.createBuffer(new j(K.UNIFORM|K.TRANSFER_DST,Z.HOST|Z.DEVICE,Q.SIZE,Q.SIZE));n.bindBuffer(Q.BINDING,s),n.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy(),this._linearSampler.destroy(),this._pointSampler.destroy()},p(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),e}(),Vn=e("p",(bn=L("cc.RenderPipeline"),Rn=U(),Dn=U(),Fn=z([en]),bn((Ln=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return t=e.call.apply(e,[this].concat(n))||this,x(t,"_tag",Pn,se(t)),x(t,"_flows",Bn,se(t)),t._commandBuffers=[],t._pipelineUBO=new wn,t._pipelineSceneData=new Hn,t._macros={},t._constantMacros="",t}R(t,e);var i=t.prototype;return i.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},i.generateRenderArea=function(e){var t=new Ie,i=e.viewport,n=this.pipelineSceneData,r=e.window.hasOnScreenAttachments&&this.device.surfaceTransform%2?e.height:e.width,s=e.window.hasOnScreenAttachments&&this.device.surfaceTransform%2?e.width:e.height;return t.x=i.x*r,t.y=i.y*s,t.width=i.width*r*n.shadingScale,t.height=i.height*s*n.shadingScale,t},i.activate=function(){this._device=c.director.root.device,this._globalDSManager=new Gn(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._pipelineSceneData.activate(this._device,this);for(var e=0;e<this._flows.length;e++)this._flows[e].activate(this);return this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),!0},i.render=function(e){for(var t=0;t<this.flows.length;t++)for(var i=0;i<e.length;i++){var n=e[i];this.flows[t].render(n)}},i.destroy=function(){for(var t=0;t<this._flows.length;t++)this._flows[t].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),this._globalDSManager.destroy();for(var i=0;i<this._commandBuffers.length;i++)this._commandBuffers[i].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),this._pipelineSceneData.destroy(),e.prototype.destroy.call(this)},i.resize=function(){},i._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.hasFeature(Oe.TEXTURE_FLOAT)?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",this._constantMacros=e},p(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}}]),t}(Ae),Pn=M((Cn=Ln).prototype,"_tag",[Rn,H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bn=M(Cn.prototype,"_flows",[Dn,Fn,H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Nn=Cn))||Nn));c.RenderPipeline=Vn,function(e){e[e.FORWARD=10]="FORWARD",e[e.UI=20]="UI"}(Mn||(Mn={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(xn||(xn={}));var Wn,kn,Qn,Yn,qn,Xn,jn,Kn,Zn,Jn,$n,er,tr,ir,nr,rr,sr,ar,or,hr,ur,lr,cr,_r,dr,fr,pr,gr,vr,Sr,mr,Er,wr,Tr,yr,Or,Ar,Ir,br,Rr,Dr,Fr,Nr,Cr,Pr,Br,Lr,Mr,xr,Hr,Ur,zr,Gr,Vr,Wr,kr,Qr,Yr,qr,Xr,jr,Kr,Zr,Jr,$r,es,ts,is,ns,rs,ss,as,os,hs,us,ls,cs,_s,ds,fs,ps=e("J",function(){function e(){}return e.getOrCreatePipelineState=function(e,t,i,n,r){var s=t.hash^n.hash^r.attributesHash^i.id,a=this._PSOHashMap.get(s);if(!a){var o=new be(r.attributes),h=new Re(i,t.pipelineLayout,n,o,t.rasterizerState,t.depthStencilState,t.blendState,t.primitive,t.dynamicStates);a=e.createPipelineState(h),this._PSOHashMap.set(s,a)}return a},e}());ps._PSOHashMap=new Map,De(Fe),De(Ne),De(Ce),De(Pe),De(Be),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(fs||(fs={})),De(fs),Wn=L("RenderTextureDesc"),kn=z(Fe),Qn=z(Ne),Yn=z(Le),Wn((Xn=M((qn=function(){x(this,"name",Xn,this),x(this,"type",jn,this),x(this,"usage",Kn,this),x(this,"format",Zn,this),x(this,"width",Jn,this),x(this,"height",$n,this)}).prototype,"name",[H,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),jn=M(qn.prototype,"type",[kn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fe.TEX2D}}),Kn=M(qn.prototype,"usage",[Qn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ne.COLOR_ATTACHMENT}}),Zn=M(qn.prototype,"format",[Yn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Le.UNKNOWN}}),Jn=M(qn.prototype,"width",[H,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),$n=M(qn.prototype,"height",[H,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),qn));var gs,vs=(er=L("RenderTextureConfig"),tr=z(Me),er((rr=M((nr=function(){x(this,"name",rr,this),x(this,"texture",sr,this)}).prototype,"name",[H,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),sr=M(nr.prototype,"texture",[tr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ir=nr))||ir),Ss=(ar=L("MaterialConfig"),or=z(oe),ar((lr=M((ur=function(){x(this,"name",lr,this),x(this,"material",cr,this)}).prototype,"name",[H,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),cr=M(ur.prototype,"material",[or],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hr=ur))||hr),ms=(_r=L("FrameBufferDesc"),dr=z([xe]),fr=z(Me),_r((gr=M((pr=function(){x(this,"name",gr,this),x(this,"renderPass",vr,this),x(this,"colorTextures",Sr,this),x(this,"depthStencilTexture",mr,this),x(this,"texture",Er,this)}).prototype,"name",[H,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),vr=M(pr.prototype,"renderPass",[H,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Sr=M(pr.prototype,"colorTextures",[dr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mr=M(pr.prototype,"depthStencilTexture",[H,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Er=M(pr.prototype,"texture",[fr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pr)),wr=L("ColorDesc"),Tr=z(Le),yr=z(Pe),Or=z(Ce),Ar=z([Be]),Ir=z([Be]),wr((Dr=M((Rr=function(){x(this,"format",Dr,this),x(this,"loadOp",Fr,this),x(this,"storeOp",Nr,this),x(this,"sampleCount",Cr,this),x(this,"beginAccesses",Pr,this),x(this,"endAccesses",Br,this)}).prototype,"format",[Tr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Le.UNKNOWN}}),Fr=M(Rr.prototype,"loadOp",[yr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pe.CLEAR}}),Nr=M(Rr.prototype,"storeOp",[Or],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ce.STORE}}),Cr=M(Rr.prototype,"sampleCount",[H,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Pr=M(Rr.prototype,"beginAccesses",[Ar],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Br=M(Rr.prototype,"endAccesses",[Ir],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Be.PRESENT]}}),br=Rr))||br),Es=(Lr=L("DepthStencilDesc"),Mr=z(Le),xr=z(Pe),Hr=z(Ce),Ur=z(Pe),zr=z(Ce),Gr=z([Be]),Vr=z([Be]),Lr((Qr=M((kr=function(){x(this,"format",Qr,this),x(this,"depthLoadOp",Yr,this),x(this,"depthStoreOp",qr,this),x(this,"stencilLoadOp",Xr,this),x(this,"stencilStoreOp",jr,this),x(this,"sampleCount",Kr,this),x(this,"beginAccesses",Zr,this),x(this,"endAccesses",Jr,this)}).prototype,"format",[Mr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Le.UNKNOWN}}),Yr=M(kr.prototype,"depthLoadOp",[xr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pe.CLEAR}}),qr=M(kr.prototype,"depthStoreOp",[Hr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ce.STORE}}),Xr=M(kr.prototype,"stencilLoadOp",[Ur],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pe.CLEAR}}),jr=M(kr.prototype,"stencilStoreOp",[zr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ce.STORE}}),Kr=M(kr.prototype,"sampleCount",[H,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Zr=M(kr.prototype,"beginAccesses",[Gr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jr=M(kr.prototype,"endAccesses",[Vr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Be.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),Wr=kr))||Wr);$r=L("RenderPassDesc"),es=z([ms]),ts=z(Es),$r((ns=M((is=function(){x(this,"index",ns,this),x(this,"colorAttachments",rs,this),x(this,"depthStencilAttachment",ss,this)}).prototype,"index",[H,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),rs=M(is.prototype,"colorAttachments",[es],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ss=M(is.prototype,"depthStencilAttachment",[ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Es}}),is)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(gs||(gs={})),De(gs);var ws=(as=L("RenderQueueDesc"),os=z(gs),hs=z([xe]),as((cs=M((ls=function(){x(this,"isTransparent",cs,this),x(this,"sortMode",_s,this),x(this,"stages",ds,this)}).prototype,"isTransparent",[H,He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_s=M(ls.prototype,"sortMode",[os],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gs.FRONT_TO_BACK}}),ds=M(ls.prototype,"stages",[hs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),us=ls))||us);function Ts(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function ys(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var Os=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new ze((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new Ge(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,i){var n=e.model.subModels[t],r=n.passes[i];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var s=0|r.priority<<16|n.priority<<8|i,a=this._passPool.add();return a.hash=s,a.depth=e.depth||0,a.shaderId=Ve.get(n.handle,We.SHADER_0+i),a.subModel=n,a.passIdx=i,this.queue.push(a),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,i){for(var n=0;n<this.queue.length;++n){var r=this.queue.array[n],s=r.subModel,a=r.passIdx,o=s.inputAssembler,h=s.handle,u=s.passes[a],l=ke.get(Ve.get(h,We.SHADER_0+a)),c=ps.getOrCreatePipelineState(e,u,l,t,o);i.bindPipelineState(c),i.bindDescriptorSet(Qe.MATERIAL,u.descriptorSet),i.bindDescriptorSet(Qe.LOCAL,s.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},e}();function As(e){for(var t=0,i=0;i<e.stages.length;i++)t|=Ue(e.stages[i]);var n=Ts;switch(e.sortMode){case gs.BACK_TO_FRONT:n=ys;break;case gs.FRONT_TO_BACK:n=Ts}return new Os({isTransparent:e.isTransparent,phases:t,sortFunc:n})}function Is(e){e.clear()}function bs(e){e.sort()}function Rs(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var Ds=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),i=t.next();!i.done;){for(var n=0;n<i.value.batches.length;++n){var r=i.value.batches[n];if(r.mergeCount){for(var s=0;s<r.vbs.length;++s)r.vbs[s].update(r.vbDatas[s]);e.updateBuffer(r.vbIdx,r.vbIdxData.buffer),e.updateBuffer(r.ubo,r.uboData)}}i=t.next()}},t.recordCommandBuffer=function(e,t,i){for(var n=this.queue.values(),r=n.next();!r.done;){for(var s=!1,a=0;a<r.value.batches.length;++a){var o=r.value.batches[a];if(o.mergeCount){if(!s){var h=ke.get(o.hShader),u=ps.getOrCreatePipelineState(e,o.pass,h,t,o.ia);i.bindPipelineState(u),i.bindDescriptorSet(Qe.MATERIAL,o.pass.descriptorSet),s=!0}i.bindDescriptorSet(Qe.LOCAL,o.descriptorSet,r.value.dynamicOffsets),i.bindInputAssembler(o.ia),i.draw(o.ia)}}r=n.next()}},e}(),Fs=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),i=t.next();!i.done;)i.value.hasPendingModels&&i.value.uploadBuffers(e),i=t.next()},t.recordCommandBuffer=function(e,t,i){for(var n=this.queue.values(),r=n.next();!r.done;){var s=r.value,a=s.instances,o=s.pass;if(s.hasPendingModels){i.bindDescriptorSet(Qe.MATERIAL,o.descriptorSet);for(var h=null,u=0;u<a.length;++u){var l=a[u];if(l.count){var c=ke.get(l.hShader),_=ps.getOrCreatePipelineState(e,o,c,t,l.ia);h!==_&&(i.bindPipelineState(_),h=_),i.bindDescriptorSet(Qe.LOCAL,Ye.get(l.hDescriptorSet),r.value.dynamicOffsets),i.bindInputAssembler(l.ia),i.draw(l.ia)}}}r=n.next()}},e}(),Ns=function(){function e(e){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=e.device}e.get=function(t,i){void 0===i&&(i=0);var n=e._buffers;n.has(t)||n.set(t,{});var r=n.get(t);return r[i]||(r[i]=new e(t))};var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],i=0;i<t.vbs.length;++i)t.vbs[i].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0},t.merge=function(e,t,n){var r=e.subMesh.flatBuffers;if(0!==r.length){for(var s=0,a=0,o=r[0].count,h=e.passes[t],u=Ve.get(e.handle,We.SHADER_0+t),l=e.descriptorSet,c=!1,_=0;_<this.batches.length;++_){var d=this.batches[_];if(d.vbs.length===r.length&&d.mergeCount<qe.BATCHING_COUNT){c=!0;for(var f=0;f<d.vbs.length;++f)if(d.vbs[f].stride!==r[f].stride){c=!1;break}if(c){for(var p=0;p<d.vbs.length;++p){var g=r[p],v=d.vbs[p],S=d.vbDatas[p];(s=(o+d.vbCount)*g.stride)>v.size&&(v.resize(s),d.vbDatas[p]=new Uint8Array(s),d.vbDatas[p].set(S)),d.vbDatas[p].set(g.buffer,d.vbCount*g.stride)}var m=d.vbIdxData;(a=4*(o+d.vbCount))>d.vbIdx.size&&(d.vbIdx.resize(a),d.vbIdxData=new Float32Array(a/Float32Array.BYTES_PER_ELEMENT),d.vbIdxData.set(m),m=d.vbIdxData);var E=d.vbCount,w=E+o,T=d.mergeCount;if(m[E]!==T||m[w-1]!==T)for(var y=E;y<w;y++)m[y]=T+.1;return i.toArray(d.uboData,n.transform.worldMatrix,qe.MAT_WORLDS_OFFSET+16*d.mergeCount),d.mergeCount||(l.bindBuffer(qe.BINDING,d.ubo),l.update(),d.pass=h,d.hShader=u,d.descriptorSet=l),++d.mergeCount,d.vbCount+=o,void(d.ia.vertexCount+=o)}}}for(var O=[],A=[],I=[],b=0;b<r.length;++b){var R=r[b],D=this._device.createBuffer(new j(K.VERTEX|K.TRANSFER_DST,Z.HOST|Z.DEVICE,R.count*R.stride,R.stride));D.update(R.buffer.buffer),O.push(D),A.push(new Uint8Array(D.size)),I.push(D)}var F=this._device.createBuffer(new j(K.VERTEX|K.TRANSFER_DST,Z.HOST|Z.DEVICE,4*o,4)),N=new Float32Array(o);N.fill(0),F.update(N),I.push(F);for(var C=e.inputAssembler.attributes,P=new Array(C.length+1),B=0;B<C.length;++B)P[B]=C[B];P[C.length]=new Xe("a_dyn_batch_id",Le.R32F,!1,r.length);var L=new je(P,I),M=this._device.createInputAssembler(L),x=this._device.createBuffer(new j(K.UNIFORM|K.TRANSFER_DST,Z.HOST|Z.DEVICE,qe.SIZE,qe.SIZE));l.bindBuffer(qe.BINDING,x),l.update();var H=new Float32Array(qe.COUNT);i.toArray(H,n.transform.worldMatrix,qe.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:O,vbDatas:A,vbIdx:F,vbIdxData:N,vbCount:o,ia:M,ubo:x,uboData:H,pass:h,hShader:u,descriptorSet:l})}},t.clear=function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}},e}();Ns._buffers=new Map;var Cs=e("I",function(){function e(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}e.get=function(t,i){void 0===i&&(i=0);var n=e._buffers;n.has(t)||n.set(t,{});var r=n.get(t);return r[i]||(r[i]=new e(t))};var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0},t.merge=function(e,t,i,n){void 0===n&&(n=null);var r=t.buffer.length;if(r){var s=e.inputAssembler,a=e.descriptorSet.getTexture(Ke),o=n;o||(o=Ve.get(e.handle,We.SHADER_0+i));for(var h=Ve.get(e.handle,We.DESCRIPTOR_SET),u=0;u<this.instances.length;++u){var l=this.instances[u];if(!(l.ia.indexBuffer!==s.indexBuffer||l.count>=1024)&&l.lightingMap===a){if(l.stride!==r)return;if(l.count>=l.capacity){l.capacity<<=1;var c=l.stride*l.capacity,_=l.data;l.data=new Uint8Array(c),l.data.set(_),l.vb.resize(c)}return l.hShader!==o&&(l.hShader=o),l.hDescriptorSet!==h&&(l.hDescriptorSet=h),l.data.set(t.buffer,l.stride*l.count++),void(this.hasPendingModels=!0)}}for(var d=this._device.createBuffer(new j(K.VERTEX|K.TRANSFER_DST,Z.HOST|Z.DEVICE,32*r,r)),f=new Uint8Array(32*r),p=s.vertexBuffers.slice(),g=s.attributes.slice(),v=s.indexBuffer,S=0;S<t.attributes.length;S++){var m=t.attributes[S],E=new Xe(m.name,m.format,m.isNormalized,p.length,!0);g.push(E)}f.set(t.buffer),p.push(d);var w=new je(g,p,v),T=this._device.createInputAssembler(w);this.instances.push({count:1,capacity:32,vb:d,data:f,ia:T,stride:r,hShader:o,hDescriptorSet:h,lightingMap:a}),this.hasPendingModels=!0}},t.uploadBuffers=function(e){for(var t=0;t<this.instances.length;++t){var i=this.instances[t];i.count&&(i.ia.instanceCount=i.count,e.updateBuffer(i.vb,i.data))}},t.clear=function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1},e}());Cs._buffers=new Map;var Ps=new W((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),Bs=new Float32Array(4),Ls=V.create(0,0,0,1),Ms=[],xs=[],Hs=new i,Us=new i;function zs(e,t){return!(!t.worldBounds||k.aabbWithAABB(t.worldBounds,e.aabb))}function Gs(e,t){return!(!t.worldBounds||k.aabbWithAABB(t.worldBounds,e.aabb)&&k.aabbFrustum(t.worldBounds,e.frustum))}var Vs=Ue("forward-add"),Ws=[];function ks(e,t){t.length=0;for(var i=!1,n=0;n<e.length;n++){for(var r=e[n].passes,s=-1,a=0;a<r.length;a++)if(r[a].phase===Vs){s=a,i=!0;break}t.push(s)}return i}var Qs,Ys,qs,Xs,js,Ks,Zs,Js,$s,ea,ta,ia=function(){function e(e){this._pipeline=void 0,this._device=void 0,this._validLights=[],this._lightPasses=[],this._shadowUBO=new Float32Array(Q.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device,this._instancedQueue=new Fs,this._batchedQueue=new Ds;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(Ze.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new j(K.UNIFORM|K.TRANSFER_DST,Z.HOST|Z.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new Je(this._lightBuffer,0,Ze.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var n=e.prototype;return n.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear(),this._validLights.length=0;for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}Ps.freeArray(this._lightPasses),this._lightPasses.length=0},n.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,i=0;i<t.length;i++){var n=t[i],r=e.get(n);r&&(r.getBuffer(Q.BINDING).destroy(),r.getSampler(ee).destroy(),r.getSampler($e).destroy(),r.getTexture(ee).destroy(),r.getTexture($e).destroy(),r.destroy()),e.delete(n)}},n.gatherLightPasses=function(e,t){var i=this._validLights;if(this.clear(),this._gatherValidLights(e,i),i.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var n=this._pipeline.pipelineSceneData.renderObjects,r=0;r<n.length;r++){var s=n[r].model,a=s.subModels;if(ks(a,Ws)&&(xs.length=0,this._lightCulling(s,i),xs.length))for(var o=0;o<a.length;o++){var h=Ws[o];if(!(h<0)){var u=a[o],l=u.passes[h];u.descriptorSet.bindBuffer(Ze.BINDING,this._firstLightBufferView),u.descriptorSet.update(),this._addRenderQueue(l,u,s,h,i)}}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},n.recordCommandBuffer=function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(var n=this._pipeline.globalDSManager,r=0;r<this._lightPasses.length;r++){var s=this._lightPasses[r],a=s.subModel,o=s.passIdx,h=s.dynamicOffsets,u=s.lights,l=ke.get(Ve.get(a.handle,We.SHADER_0+o)),c=a.passes[o],_=a.inputAssembler,d=ps.getOrCreatePipelineState(e,c,l,t,_),f=Ye.get(et.get(c.handle,tt.DESCRIPTOR_SET)),p=a.descriptorSet;i.bindPipelineState(d),i.bindDescriptorSet(Qe.MATERIAL,f),i.bindInputAssembler(_);for(var g=0;g<h.length;++g){var v=u[g],S=n.getOrCreateDescriptorSet(v);Ms[0]=h[g],i.bindDescriptorSet(Qe.GLOBAL,S),i.bindDescriptorSet(Qe.LOCAL,p,Ms),i.draw(_)}}},n._gatherValidLights=function(e,t){for(var i=e.scene.sphereLights,n=0;n<i.length;n++){var r=i[n];r.baked||(V.set(Ls,r.position.x,r.position.y,r.position.z,r.range),k.sphereFrustum(Ls,e.frustum)&&t.push(r))}for(var s=e.scene.spotLights,a=0;a<s.length;a++){var o=s[a];o.baked||(V.set(Ls,o.position.x,o.position.y,o.position.z,o.range),k.sphereFrustum(Ls,e.frustum)&&t.push(o))}},n._lightCulling=function(e,t){for(var i=0;i<t.length;i++){var n=t[i],r=!1;switch(n.type){case Kt.SPHERE:r=zs(n,e);break;case Kt.SPOT:r=Gs(n,e)}r||xs.push(i)}},n._addRenderQueue=function(e,t,i,n){var r=e.batchingScheme;if(r===it.INSTANCING)for(var s=0;s<xs.length;s++){var a=xs[s],o=Cs.get(e,a);o.merge(t,i.instancedAttributes,n),o.dynamicOffsets[0]=this._lightBufferStride*a,this._instancedQueue.queue.add(o)}else if(r===it.VB_MERGING)for(var h=0;h<xs.length;h++){var u=xs[h],l=Ns.get(e,u);l.merge(t,n,i),l.dynamicOffsets[0]=this._lightBufferStride*u,this._batchedQueue.queue.add(l)}else{var c=Ps.alloc();c.subModel=t,c.passIdx=n;for(var _=0;_<xs.length;_++){var d=xs[_];c.lights.push(d),c.dynamicOffsets.push(this._lightBufferStride*d)}this._lightPasses.push(c)}},n._updateLightDescriptorSet=function(e,t){for(var n=this._pipeline.device,r=this._pipeline.pipelineSceneData,s=r.shadows,a=r.shadowFrameBufferMap,o=e.scene.mainLight,h=ie(n),u=s.linear&&h?1:0,l=s.packing?1:h?0:1,c=this._pipeline.globalDSManager,_=0;_<this._validLights.length;_++){var d=this._validLights[_],f=c.getOrCreateDescriptorSet(_);if(f){switch(d.type){case Kt.SPHERE:o&&pn(s,o,this._shadowUBO),this._shadowUBO[Q.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=s.size.x,this._shadowUBO[Q.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=s.size.y,this._shadowUBO[Q.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=s.pcf,this._shadowUBO[Q.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=s.bias,this._shadowUBO[Q.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[Q.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=l,this._shadowUBO[Q.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=s.normalBias,this._shadowUBO[Q.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,te.toArray(this._shadowUBO,s.shadowColor,Q.SHADOW_COLOR_OFFSET);break;case Kt.SPOT:if(o&&pn(s,o,this._shadowUBO),i.toArray(this._shadowUBO,d.node.getWorldMatrix(),Q.MAT_LIGHT_VIEW_OFFSET),i.invert(Hs,d.node.getWorldMatrix()),i.perspective(Us,d.spotAngle,d.aspect,.001,d.range),i.multiply(Us,Us,Hs),i.toArray(this._shadowUBO,Us,Q.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[Q.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+0]=.01,this._shadowUBO[Q.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+1]=d.range,this._shadowUBO[Q.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+2]=u,this._shadowUBO[Q.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+3]=s.selfShadow?1:0,this._shadowUBO[Q.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=s.size.x,this._shadowUBO[Q.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=s.size.y,this._shadowUBO[Q.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=s.pcf,this._shadowUBO[Q.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=s.bias,this._shadowUBO[Q.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[Q.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=l,this._shadowUBO[Q.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=s.normalBias,this._shadowUBO[Q.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,te.toArray(this._shadowUBO,s.shadowColor,Q.SHADOW_COLOR_OFFSET),a.has(d)){var p,g=null===(p=a.get(d))||void 0===p?void 0:p.colorTextures[0];g&&f.bindTexture($e,g)}}f.update(),t.updateBuffer(f.getBuffer(Q.BINDING),this._shadowUBO)}}},n._updateUBOs=function(e,i){var n=e.exposure,r=this._pipeline.pipelineSceneData,s=r.isHDR,a=r.fpScale;this._validLights.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=nt(this._validLights.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new Je(this._lightBuffer,0,Ze.SIZE)));for(var o=0,h=0;o<this._validLights.length;o++,h+=this._lightBufferElementCount){var u=this._validLights[o];switch(u.type){case Kt.SPHERE:if(t.toArray(Bs,u.position),Bs[3]=0,this._lightBufferData.set(Bs,h+Ze.LIGHT_POS_OFFSET),Bs[0]=u.size,Bs[1]=u.range,Bs[2]=0,this._lightBufferData.set(Bs,h+Ze.LIGHT_SIZE_RANGE_ANGLE_OFFSET),t.toArray(Bs,u.color),u.useColorTemperature){var l=u.colorTemperatureRGB;Bs[0]*=l.x,Bs[1]*=l.y,Bs[2]*=l.z}Bs[3]=s?u.luminance*a*this._lightMeterScale:u.luminance*n*this._lightMeterScale,this._lightBufferData.set(Bs,h+Ze.LIGHT_COLOR_OFFSET);break;case Kt.SPOT:if(t.toArray(Bs,u.position),Bs[3]=1,this._lightBufferData.set(Bs,h+Ze.LIGHT_POS_OFFSET),Bs[0]=u.size,Bs[1]=u.range,Bs[2]=u.spotAngle,this._lightBufferData.set(Bs,h+Ze.LIGHT_SIZE_RANGE_ANGLE_OFFSET),t.toArray(Bs,u.direction),this._lightBufferData.set(Bs,h+Ze.LIGHT_DIR_OFFSET),t.toArray(Bs,u.color),u.useColorTemperature){var c=u.colorTemperatureRGB;Bs[0]*=c.x,Bs[1]*=c.y,Bs[2]*=c.z}Bs[3]=s?u.luminance*a*this._lightMeterScale:u.luminance*n*this._lightMeterScale,this._lightBufferData.set(Bs,h+Ze.LIGHT_COLOR_OFFSET)}}i.updateBuffer(this._lightBuffer,this._lightBufferData)},e}(),na=new G,ra=function(){function e(e){this._pendingModels=[],this._instancedQueue=new Fs,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.gatherShadowPasses=function(e,t){var i=this._pipeline.pipelineSceneData,n=this._pipeline.pipelineUBO,r=i.shadows;if(this._instancedQueue.clear(),this._pendingModels.length=0,r.enabled&&r.type===Y.Planar){n.updateShadowUBO(e);var s=e.scene,a=e.frustum,o=0!=(e.visibility&rt.BitMask.DEFAULT);if(s.mainLight&&o){var h=i.renderObjects,u=Cs.get(r.instancingMaterial.passes[0]);this._instancedQueue.queue.add(u);for(var l=0;l<h.length;l++){var c=h[l].model;if(c.enabled&&c.node&&c.castShadow&&(!c.worldBounds||(G.transform(na,c.worldBounds,r.matLight),k.aabbFrustum(na,a))))if(c.isInstancingEnabled)for(var _=c.subModels,d=0;d<_.length;d++){var f=_[d];u.merge(f,c.instancedAttributes,0,f.planarInstanceShaderHandle)}else this._pendingModels.push(c)}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,i){var n=this._pipeline.pipelineSceneData.shadows;if(n.enabled&&n.type===Y.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,i),this._pendingModels.length)){var r=n.material.passes[0],s=Ye.get(et.get(r.handle,tt.DESCRIPTOR_SET));i.bindDescriptorSet(Qe.MATERIAL,s);for(var a=this._pendingModels.length,o=0;o<a;o++)for(var h=this._pendingModels[o],u=0;u<h.subModels.length;u++){var l=h.subModels[u],c=ke.get(l.planarShaderHandle),_=l.inputAssembler,d=ps.getOrCreatePipelineState(e,r,c,t,_);i.bindPipelineState(d),i.bindDescriptorSet(Qe.LOCAL,l.descriptorSet),i.bindInputAssembler(_),i.draw(_)}}},e}(),sa=function(){function e(){this._phaseID=Ue("default")}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var i=this._pipeline,n=i.device,r=i.commandBuffers[0],s=e.scene.batches,a=0;a<s.length;a++){var o=s[a],h=!1;if(e.visibility&o.visFlags&&(h=!0),h)for(var u=o.handle,l=st.get(u,at.PASS_COUNT),c=0;c<l;c++){var _=o.passes[c];if(_.phase===this._phaseID){var d=st.get(u,at.SHADER_0+c),f=ke.get(d),p=ot.get(o.hInputAssembler),g=Ye.get(o.hDescriptorSet),v=ps.getOrCreatePipelineState(n,_,f,t,p);r.bindPipelineState(v),r.bindDescriptorSet(Qe.MATERIAL,_.descriptorSet),r.bindDescriptorSet(Qe.LOCAL,g),r.bindInputAssembler(p),r.draw(p)}}}},e}(),aa=[new v(0,0,0,1)],oa=e("u",(Qs=L("ForwardStage"),Ys=z([ws]),qs=U(),Qs((Js=Zs=function(e){function t(){var t;return t=e.call(this)||this,x(t,"renderQueues",Ks,se(t)),t._renderQueues=[],t._renderArea=new Ie,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=Ue("default"),t._clearFlag=4294967295,t._batchedQueue=new Ds,t._instancedQueue=new Fs,t._uiPhase=new sa,t}R(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i);for(var n=0;n<this.renderQueues.length;n++)this._renderQueues[n]=As(this.renderQueues[n]);this._additiveLightQueue=new ia(this._pipeline),this._planarQueue=new ra(this._pipeline),this._uiPhase.activate(t)},i.destroy=function(){},i.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,i=t.device;this._renderQueues.forEach(Is);for(var r=t.pipelineSceneData.renderObjects,s=0,a=0,o=0,h=0;h<r.length;++h){var u=r[h],l=u.model.subModels;for(s=0;s<l.length;++s){var c=l[s],_=c.passes;for(a=0;a<_.length;++a){var d=_[a];if(d.phase===this._phaseID){var f=d.batchingScheme;if(f===it.INSTANCING){var p=Cs.get(d);p.merge(c,u.model.instancedAttributes,a),this._instancedQueue.queue.add(p)}else if(f===it.VB_MERGING){var g=Ns.get(d);g.merge(c,a,u.model),this._batchedQueue.queue.add(g)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(u,s,a)}}}}this._renderQueues.forEach(bs);var v=t.commandBuffers[0];this._instancedQueue.uploadBuffers(v),this._batchedQueue.uploadBuffers(v),this._additiveLightQueue.gatherLightPasses(e,v),this._planarQueue.gatherShadowPasses(e,v);var S=t.pipelineSceneData;if(this._renderArea=t.generateRenderArea(e),e.clearFlag&n.COLOR)if(S.isHDR){Rs(aa[0],e.clearColor);var m=S.fpScale/e.exposure;aa[0].x*=m,aa[0].y*=m,aa[0].z*=m}else aa[0].x=e.clearColor.x,aa[0].y=e.clearColor.y,aa[0].z=e.clearColor.z;aa[0].w=e.clearColor.w;var E=e.window.framebuffer,w=E.colorTextures[0]?E.renderPass:t.getRenderPass(e.clearFlag&this._clearFlag);v.beginRenderPass(w,E,this._renderArea,aa,e.clearDepth,e.clearStencil),v.bindDescriptorSet(Qe.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(i,w,v),this._instancedQueue.recordCommandBuffer(i,w,v),this._batchedQueue.recordCommandBuffer(i,w,v),this._additiveLightQueue.recordCommandBuffer(i,w,v),this._planarQueue.recordCommandBuffer(i,w,v),this._renderQueues[1].recordCommandBuffer(i,w,v),this._uiPhase.render(e,w),v.endRenderPass()},t}($i),Zs.initInfo={name:"ForwardStage",priority:Mn.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:gs.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:gs.BACK_TO_FRONT,stages:["default","planarShadow"]}]},Ks=M((js=Js).prototype,"renderQueues",[Ys,H,qs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xs=js))||Xs)),ha=e("t",L("ForwardFlow")((ta=ea=function(e){function t(){return e.apply(this,arguments)||this}R(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new oa;i.initialize(oa.initInfo),this._stages.push(i)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(t){e.prototype.render.call(this,t)},i.destroy=function(){e.prototype.destroy.call(this)},t}(en),ea.initInfo={name:ht,priority:xn.FORWARD,stages:[]},$s=ta))||$s),ua=Ue("shadow-caster"),la=[];function ca(e,t){t.length=0;for(var i=!1,n=0;n<e.length;n++){for(var r=e[n].passes,s=-1,a=0;a<r.length;a++)if(r[a].phase===ua){s=a,i=!0;break}t.push(s)}return i}var _a,da,fa,pa,ga,va,Sa,ma,Ea,wa,Ta,ya,Oa,Aa,Ia,ba,Ra,Da,Fa,Na,Ca,Pa,Ba,La,Ma,xa,Ha=function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._instancedQueue=new Fs,this._batchedQueue=new Ds}var t=e.prototype;return t.gatherLightPasses=function(e,t){this.clear();var i=this._pipeline.pipelineSceneData.shadows,n=this._pipeline.pipelineSceneData.shadowObjects;if(e&&i.enabled&&i.type===Y.ShadowMap){this._pipeline.pipelineUBO.updateShadowUBOLight(e);for(var r=0;r<n.length;r++){var s=n[r].model;if(ca(s.subModels,la))switch(e.type){case Kt.DIRECTIONAL:this.add(s,t,la);break;case Kt.SPOT:if(s.worldBounds&&(!k.aabbWithAABB(s.worldBounds,e.aabb)||!k.aabbFrustum(s.worldBounds,e.frustum)))continue;this.add(s,t,la)}}}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},t.add=function(e,t,i){for(var n=e.subModels,r=0;r<n.length;r++){var s=n[r],a=i[r],o=s.passes[a];if(o.batchingScheme===it.INSTANCING){var h=Cs.get(o);h.merge(s,e.instancedAttributes,a),this._instancedQueue.queue.add(h)}else if(o.batchingScheme===it.VB_MERGING){var u=Ns.get(o);u.merge(s,a,e),this._batchedQueue.queue.add(u)}else{var l=ke.get(Ve.get(s.handle,We.SHADER_0+a));this._subModelsArray.push(s),this._shaderArray.push(l),this._passArray.push(o)}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)},t.recordCommandBuffer=function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(var n=0;n<this._subModelsArray.length;++n){var r=this._subModelsArray[n],s=this._shaderArray[n],a=this._passArray[n],o=r.inputAssembler,h=ps.getOrCreatePipelineState(e,a,s,t,o),u=a.descriptorSet;i.bindPipelineState(h),i.bindDescriptorSet(Qe.MATERIAL,u),i.bindDescriptorSet(Qe.LOCAL,r.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},e}(),Ua=[new v(1,1,1,1)],za=e("H",L("ShadowStage")((fa=da=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this)._shadowFrameBuffer=null,t._renderArea=new Ie,t._light=null,t}R(t,e);var i=t.prototype;return i.setUsage=function(e,t){this._light=e,this._shadowFrameBuffer=t},i.destroy=function(){this._additiveShadowQueue.clear()},i.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer){Ua[0].w=e.clearColor.w;var t=this._pipeline.commandBuffers[0],i=this._shadowFrameBuffer.renderPass;t.beginRenderPass(i,this._shadowFrameBuffer,this._renderArea,Ua,e.clearDepth,e.clearStencil),t.endRenderPass()}},i.render=function(e){var t=this._pipeline,i=t.pipelineSceneData,n=i.shadows,r=i.shadingScale,s=t.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._additiveShadowQueue.gatherLightPasses(this._light,s);var a=e.viewport,o=n.size;this._renderArea.x=a.x*o.x,this._renderArea.y=a.y*o.y,this._renderArea.width=a.width*o.x*r,this._renderArea.height=a.height*o.y*r;var h=t.device,u=this._shadowFrameBuffer.renderPass;s.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,Ua,e.clearDepth,e.clearStencil),s.bindDescriptorSet(Qe.GLOBAL,t.descriptorSet),this._additiveShadowQueue.recordCommandBuffer(h,u,s),s.endRenderPass()}},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._additiveShadowQueue=new Ha(t)},t}($i),da.initInfo={name:"ShadowStage",priority:Mn.FORWARD,tag:0},_a=fa))||_a),Ga=e("B",L("ShadowFlow")((va=ga=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this)._shadowRenderPass=null,t}R(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new za;i.initialize(za.initInfo),this._stages.push(i)}return!0},i.render=function(e){var t=this._pipeline,i=t.pipelineSceneData.shadows,n=t.pipelineSceneData.shadowFrameBufferMap,r=t.pipelineSceneData.shadowObjects;if(i.enabled&&i.type===Y.ShadowMap){var s=function(e,t){hn.length=0;var i=e.scene;hn.push(i.mainLight);for(var n=i.spotLights,r=0;r<n.length;r++){var s=n[r];V.set(un,s.position.x,s.position.y,s.position.z,s.range),k.sphereFrustum(un,e.frustum)&&t>hn.length&&hn.push(s)}return hn}(e,i.maxReceived);if(0!==r.length){for(var a=0;a<s.length;a++){var o=s[a];n.has(o)||this._initShadowFrameBuffer(t,o);var h=n.get(o);i.shadowMapDirty&&this.resizeShadowMap(o,i);for(var u=0;u<this._stages.length;u++){var l=this._stages[u];l.setUsage(o,h),l.render(e)}}t.pipelineUBO.updateShadowUBO(e)}else this.clearShadowMap(s,e)}},i.destroy=function(){e.prototype.destroy.call(this);for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,i=Array.from(t.values()),n=0;n<i.length;n++){var r=i[n];if(r){for(var s=r.colorTextures,a=0;a<s.length;a++){var o=s[n];o&&o.destroy()}s.length=0;var h=r.depthStencilTexture;h&&h.destroy(),r.destroy()}}t.clear(),this._shadowRenderPass&&this._shadowRenderPass.destroy()},i._initShadowFrameBuffer=function(e,t){var i=e.device,n=e.pipelineSceneData.shadows,r=n.size,s=e.pipelineSceneData.shadowFrameBufferMap,a=ie(i)?n.packing?Le.RGBA8:Le.RGBA16F:Le.RGBA8;if(!this._shadowRenderPass){var o=new ut;o.format=a,o.loadOp=Pe.CLEAR,o.storeOp=Ce.STORE,o.sampleCount=1;var h=new lt;h.format=i.depthStencilFormat,h.depthLoadOp=Pe.CLEAR,h.depthStoreOp=Ce.DISCARD,h.stencilLoadOp=Pe.CLEAR,h.stencilStoreOp=Ce.DISCARD,h.sampleCount=1;var u=new ct([o],h);this._shadowRenderPass=i.createRenderPass(u)}var l=[];l.push(i.createTexture(new _t(Fe.TEX2D,Ne.COLOR_ATTACHMENT|Ne.SAMPLED,a,r.x,r.y)));var c=i.createTexture(new _t(Fe.TEX2D,Ne.DEPTH_STENCIL_ATTACHMENT,i.depthStencilFormat,r.x,r.y)),_=i.createFramebuffer(new dt(this._shadowRenderPass,l,c));s.set(t,_)},i.clearShadowMap=function(e,t){for(var i=this._pipeline.pipelineSceneData,n=0;n<e.length;n++){var r=e[n],s=i.shadowFrameBufferMap.get(r);if(i.shadowFrameBufferMap.has(r))for(var a=0;a<this._stages.length;a++){var o=this._stages[a];o.setUsage(r,s),o.clearFramebuffer(t)}}},i.resizeShadowMap=function(e,t){var i=t.size.x,n=t.size.y,r=this._pipeline,s=r.device,a=r.pipelineSceneData.shadowFrameBufferMap,o=ie(s)?t.packing?Le.RGBA8:Le.RGBA16F:Le.RGBA8;if(a.has(e)){var h=a.get(e);if(!h)return;var u=[];u.push(r.device.createTexture(new _t(Fe.TEX2D,Ne.COLOR_ATTACHMENT|Ne.SAMPLED,o,i,n)));var l=h.depthStencilTexture;l&&l.resize(i,n);var c=h.renderPass;h.destroy(),h.initialize(new dt(c,u,l))}t.shadowMapDirty=!1},t}(en),ga.initInfo={name:ft,priority:xn.SHADOW,tag:fs.SCENE,stages:[]},pa=va))||pa),Va=[ve.POINT,ve.POINT,ve.NONE,Se.CLAMP,Se.CLAMP,Se.CLAMP];e("F",(Sa=L("ForwardPipeline"),ma=z([vs]),Ea=U(),wa=z([Ss]),Ta=U(),Sa((ba=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return t=e.call.apply(e,[this].concat(n))||this,x(t,"renderTextures",Aa,se(t)),x(t,"materials",Ia,se(t)),t._renderPasses=new Map,t}R(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var i=new Ga;i.initialize(Ga.initInfo),this._flows.push(i);var n=new ha;n.initialize(ha.initInfo),this._flows.push(n)}return!0},i.activate=function(){return!(!e.prototype.activate.call(this)||!this._activeRenderer()&&(pt(2402),1))},i.render=function(e){this._commandBuffers[0].begin(),this._pipelineUBO.updateGlobalUBO();for(var t=0;t<e.length;t++){var i=e[t];if(i.scene){gn(this,i),this._pipelineUBO.updateCameraUBO(i);for(var n=0;n<this._flows.length;n++)this._flows[n].render(i)}}this._commandBuffers[0].end(),this._device.flushCommands(this._commandBuffers),this._device.queue.submit(this._commandBuffers)},i.getRenderPass=function(e){var t=this._renderPasses.get(e);if(t)return t;var i=this.device,r=new ut,s=new lt;r.format=i.colorFormat,s.format=i.depthStencilFormat,s.stencilStoreOp=Ce.DISCARD,s.depthStoreOp=Ce.DISCARD,e&n.COLOR||(e&ni?r.loadOp=Pe.DISCARD:(r.loadOp=Pe.LOAD,r.beginAccesses=[Be.PRESENT])),(e&n.DEPTH_STENCIL)!==n.DEPTH_STENCIL&&(e&n.DEPTH||(s.depthLoadOp=Pe.LOAD),e&n.STENCIL||(s.stencilLoadOp=Pe.LOAD),s.beginAccesses=[Be.DEPTH_STENCIL_ATTACHMENT_WRITE]);var a=new ct([r],s);return t=i.createRenderPass(a),this._renderPasses.set(e,t),t},i._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=we(Va),i=ce.getSampler(e,t);return this._descriptorSet.bindSampler(ee,i),this._descriptorSet.bindTexture(ee,le.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler($e,i),this._descriptorSet.bindTexture($e,le.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},i.destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(J.BINDING).destroy(),this._descriptorSet.getBuffer(Q.BINDING).destroy(),this._descriptorSet.getBuffer($.BINDING).destroy(),this._descriptorSet.getSampler(ee).destroy(),this._descriptorSet.getSampler($e).destroy(),this._descriptorSet.getTexture(ee).destroy(),this._descriptorSet.getTexture($e).destroy())},i.destroy=function(){this.destroyUBOs();for(var t=this._renderPasses.values(),i=t.next();!i.done;)i.value.destroy(),i=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},t}(Vn),Aa=M((Oa=ba).prototype,"renderTextures",[ma,H,Ea],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ia=M(Oa.prototype,"materials",[wa,H,Ta],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ya=Oa))||ya)),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT",e[e.POSTPROCESS=19]="POSTPROCESS",e[e.UI=20]="UI"}(Ra||(Ra={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.GBUFFER=1]="GBUFFER",e[e.LIGHTING=5]="LIGHTING",e[e.UI=10]="UI"}(Da||(Da={}));var Wa,ka,Qa,Ya,qa,Xa,ja,Ka,Za,Ja,$a,eo,to,io,no,ro,so,ao,oo,ho,uo,lo,co,_o,fo,po,go,vo,So,mo,Eo,wo,To,yo,Oo,Ao=[new v(0,0,0,0),new v(0,0,0,0),new v(0,0,0,0),new v(0,0,0,0)],Io=e("x",(Fa=L("GbufferStage"),Na=z([ws]),Ca=U(),Fa((xa=Ma=function(e){function t(){var t;return t=e.call(this)||this,x(t,"renderQueues",La,se(t)),t._renderQueues=[],t._renderArea=new Ie,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=Ue("deferred"),t._batchedQueue=new Ds,t._instancedQueue=new Fs,t}R(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i);for(var n=0;n<this.renderQueues.length;n++)this._renderQueues[n]=As(this.renderQueues[n])},i.destroy=function(){},i.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,i=t.device;this._renderQueues.forEach(Is);var r=t.pipelineSceneData.renderObjects;if(0!==r.length){for(var s=0,a=0,o=0,h=0;h<r.length;++h){var u=r[h],l=u.model.subModels;for(s=0;s<l.length;++s){var c=l[s],_=c.passes;for(a=0;a<_.length;++a){var d=_[a];if(d.phase===this._phaseID){var f=d.batchingScheme;if(f===it.INSTANCING){var p=Cs.get(d);p.merge(c,u.model.instancedAttributes,a),this._instancedQueue.queue.add(p)}else if(f===it.VB_MERGING){var g=Ns.get(d);g.merge(c,a,u.model),this._batchedQueue.queue.add(g)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(u,s,a)}}}}this._renderQueues.forEach(bs);var v=t.commandBuffers[0];if(this._instancedQueue.uploadBuffers(v),this._batchedQueue.uploadBuffers(v),this._renderArea=t.generateRenderArea(e),t.updateQuadVertexData(this._renderArea),e.clearFlag&n.COLOR)if(t.pipelineSceneData.isHDR){Rs(Ao[0],e.clearColor);var S=t.pipelineSceneData.fpScale/e.exposure;Ao[0].x*=S,Ao[0].y*=S,Ao[0].z*=S}else Ao[0].x=e.clearColor.x,Ao[0].y=e.clearColor.y,Ao[0].z=e.clearColor.z;Ao[0].w=e.clearColor.w;var m=t.getDeferredRenderData(e).gbufferFrameBuffer,E=m.renderPass;v.beginRenderPass(E,m,this._renderArea,Ao,e.clearDepth,e.clearStencil),v.bindDescriptorSet(Qe.GLOBAL,t.descriptorSet);for(var w=0;w<this.renderQueues.length;w++)this._renderQueues[w].recordCommandBuffer(i,E,v);this._instancedQueue.recordCommandBuffer(i,E,v),this._batchedQueue.recordCommandBuffer(i,E,v),v.endRenderPass()}},t}($i),Ma.initInfo={name:"GbufferStage",priority:Ra.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:gs.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:gs.BACK_TO_FRONT,stages:["default"]}]},La=M((Ba=xa).prototype,"renderQueues",[Na,H,Ca],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pa=Ba))||Pa)),bo=e("w",L("GbufferFlow")((Qa=ka=function(e){function t(){return e.apply(this,arguments)||this}R(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new Io;i.initialize(Io.initInfo),this._stages.push(i)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(t){e.prototype.render.call(this,t)},i.destroy=function(){e.prototype.destroy.call(this)},t}(en),ka.initInfo={name:gt,priority:Da.GBUFFER,stages:[]},Wa=Qa))||Wa),Ro=[new v(0,0,0,1)],Do=e("z",(Ya=L("LightingStage"),qa=z(oe),Xa=U(),ja=z([ws]),Ka=U(),Ya((io=to=function(e){function i(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this)._deferredLitsBufs=null,t._maxDeferredLights=vt.LIGHTS_PER_PASS,t._lightMeterScale=1e4,t._descriptorSet=null,t._renderArea=new Ie,x(t,"_deferredMaterial",$a,se(t)),x(t,"renderQueues",eo,se(t)),t._phaseID=Ue("default"),t._defPhaseID=Ue("deferred"),t._renderQueues=[],t}R(i,e);var r=i.prototype;return r.initialize=function(t){return e.prototype.initialize.call(this,t),!0},r.gatherLights=function(e){for(var i=this._pipeline,n=i.commandBuffers[0],r=e.scene.sphereLights,s=e.scene.spotLights,a=V.create(0,0,0,1),o=new Float32Array(4),h=e.exposure,u=0,l=X.length,c=l*this._maxDeferredLights,_=0;_<r.length&&u<this._maxDeferredLights;_++,++u){var d=r[_];if(V.set(a,d.position.x,d.position.y,d.position.z,d.range),k.sphereFrustum(a,e.frustum)){if(t.toArray(o,d.position),o[3]=0,this._lightBufferData.set(o,u*l),t.toArray(o,d.color),d.useColorTemperature){var f=d.colorTemperatureRGB;o[0]*=f.x,o[1]*=f.y,o[2]*=f.z}i.pipelineSceneData.isHDR?o[3]=d.luminance*i.pipelineSceneData.fpScale*this._lightMeterScale:o[3]=d.luminance*h*this._lightMeterScale,this._lightBufferData.set(o,u*l+1*c),o[0]=d.size,o[1]=d.range,o[2]=0,this._lightBufferData.set(o,u*l+2*c)}}for(var p=0;p<s.length&&u<this._maxDeferredLights;p++,++u){var g=s[p];if(V.set(a,g.position.x,g.position.y,g.position.z,g.range),k.sphereFrustum(a,e.frustum)){if(t.toArray(o,g.position),o[3]=1,this._lightBufferData.set(o,u*l+0*c),t.toArray(o,g.color),g.useColorTemperature){var v=g.colorTemperatureRGB;o[0]*=v.x,o[1]*=v.y,o[2]*=v.z}i.pipelineSceneData.isHDR?o[3]=g.luminance*i.pipelineSceneData.fpScale*this._lightMeterScale:o[3]=g.luminance*h*this._lightMeterScale,this._lightBufferData.set(o,u*l+1*c),o[0]=g.size,o[1]=g.range,o[2]=g.spotAngle,this._lightBufferData.set(o,u*l+2*c),t.toArray(o,g.direction),this._lightBufferData.set(o,u*l+3*c)}}var S=3*c+3;this._lightBufferData.set([u],S),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},r.activate=function(t,i){e.prototype.activate.call(this,t,i);for(var n=t.device,r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=As(this.renderQueues[r]);var s=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;s=Math.ceil(s/n.capabilities.uboOffsetAlignment)*n.capabilities.uboOffsetAlignment,this._deferredLitsBufs=n.createBuffer(new j(K.UNIFORM|K.TRANSFER_DST,Z.HOST|Z.DEVICE,s,n.capabilities.uboOffsetAlignment));var a=n.createBuffer(new Je(this._deferredLitsBufs,0,s));this._lightBufferData=new Float32Array(s/Float32Array.BYTES_PER_ELEMENT);var o=new Te(St.bindings);this._descriptorSetLayout=n.createDescriptorSetLayout(o),this._descriptorSet=n.createDescriptorSet(new me(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(Ze.BINDING,a),this._planarQueue=new ra(this._pipeline)},r.destroy=function(){this._deferredLitsBufs.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},r.render=function(e){var t=this._pipeline,i=t.device,r=t.commandBuffers[0],s=t.pipelineSceneData.renderObjects;if(0!==s.length){if(this.gatherLights(e),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(e,r),r.bindDescriptorSet(Qe.LOCAL,this._descriptorSet,[0]),this._renderArea=t.generateRenderArea(e),e.clearFlag&n.COLOR)if(t.pipelineSceneData.isHDR){Rs(Ro[0],e.clearColor);var a=t.pipelineSceneData.fpScale/e.exposure;Ro[0].x*=a,Ro[0].y*=a,Ro[0].z*=a}else Ro[0].x=e.clearColor.x,Ro[0].y=e.clearColor.y,Ro[0].z=e.clearColor.z;Ro[0].w=0;var o,h,u=t.getDeferredRenderData(e).lightingFrameBuffer,l=u.renderPass;r.beginRenderPass(l,u,this._renderArea,Ro,e.clearDepth,e.clearStencil),r.bindDescriptorSet(Qe.GLOBAL,t.descriptorSet);var c=le.get("builtin-deferred-material");c?(o=c.passes[0],h=ke.get(o.getShaderVariant())):(o=this._deferredMaterial.passes[1],h=ke.get(this._deferredMaterial.passes[1].getShaderVariant()));var _=t.quadIAOffscreen,d=null;null!=o&&null!=h&&null!=_&&(d=ps.getOrCreatePipelineState(i,o,h,l,_)),null!=d&&(r.bindPipelineState(d),r.bindInputAssembler(_),r.draw(_)),this._renderQueues.forEach(Is);for(var f=0,p=0,g=0,v=0;v<s.length;++v){var S=s[v],m=S.model.subModels;for(f=0;f<m.length;++f){var E=m[f].passes;for(p=0;p<E.length;++p){var w=E[p];if(w.phase===this._phaseID||w.phase===this._defPhaseID)for(g=0;g<this._renderQueues.length;g++)this._renderQueues[g].insertRenderPass(S,f,p)}}}this._renderQueues.forEach(bs);for(var T=0;T<this._renderQueues.length;T++)this._renderQueues[T].recordCommandBuffer(i,l,r);this._planarQueue.recordCommandBuffer(i,l,r),r.endRenderPass()}},p(i,[{key:"material",set:function(e){this._deferredMaterial!==e&&(this._deferredMaterial=e)}}]),i}($i),to.initInfo={name:"LightingStage",priority:Ra.LIGHTING,tag:0},$a=M((Ja=io).prototype,"_deferredMaterial",[qa,H,Xa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eo=M(Ja.prototype,"renderQueues",[ja,H,Ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Za=Ja))||Za)),Fo=e("y",L("LightingFlow")((so=ro=function(e){function t(){return e.apply(this,arguments)||this}R(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new Do;i.initialize(Do.initInfo),this._stages.push(i)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(t){e.prototype.render.call(this,t)},i.destroy=function(){e.prototype.destroy.call(this)},t}(en),ro.initInfo={name:mt,priority:Da.LIGHTING,stages:[]},no=so))||no),No=[ve.POINT,ve.POINT,ve.NONE,Se.CLAMP,Se.CLAMP,Se.CLAMP],Co=we(No),Po=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},Bo=function(){this.gbufferFrameBuffer=null,this.gbufferRenderTargets=[],this.lightingFrameBuffer=null,this.lightingRenderTargets=[],this.depthTex=null},Lo=(e("D",(ao=L("DeferredPipeline"),oo=z([vs]),ho=U(),uo=z([Ss]),lo=U(),ao((go=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this)._quadIB=null,t._quadVBOnscreen=null,t._quadVBOffscreen=null,t._quadIAOnscreen=null,t._quadIAOffscreen=null,t._deferredRenderData=null,t._gbufferRenderPass=null,t._lightingRenderPass=null,t._width=0,t._height=0,t._lastUsedRenderArea=new Ie,x(t,"renderTextures",fo,se(t)),x(t,"materials",po,se(t)),t._renderPasses=new Map,t}R(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var i=new Ga;i.initialize(Ga.initInfo),this._flows.push(i);var n=new bo;n.initialize(bo.initInfo),this._flows.push(n);var r=new Fo;r.initialize(Fo.initInfo),this._flows.push(r)}return!0},i.activate=function(){return this._macros.CC_PIPELINE_TYPE=1,!(!e.prototype.activate.call(this)||!this._activeRenderer()&&(pt(2402),1))},i.render=function(e){if(0!==e.length){this._commandBuffers[0].begin(),this._pipelineUBO.updateGlobalUBO();for(var t=0;t<e.length;t++){var i=e[t];if(i.scene){gn(this,i),this._pipelineUBO.updateCameraUBO(i);for(var n=0;n<this._flows.length;n++)this._flows[n].render(i)}}this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},i.getRenderPass=function(e){var t=this._renderPasses.get(e);if(t)return t;var i=this.device,r=new ut,s=new lt;r.format=i.colorFormat,s.format=i.depthStencilFormat,s.stencilStoreOp=Ce.DISCARD,s.depthStoreOp=Ce.DISCARD,e&n.COLOR||(e&ni?r.loadOp=Pe.DISCARD:(r.loadOp=Pe.LOAD,r.beginAccesses=[Be.PRESENT])),(e&n.DEPTH_STENCIL)!==n.DEPTH_STENCIL&&(e&n.DEPTH||(s.depthLoadOp=Pe.LOAD),e&n.STENCIL||(s.stencilLoadOp=Pe.LOAD),s.beginAccesses=[Be.DEPTH_STENCIL_ATTACHMENT_WRITE]);var a=new ct([r],s);return t=i.createRenderPass(a),this._renderPasses.set(e,t),t},i.getDeferredRenderData=function(){return this._deferredRenderData||this._generateDeferredRenderData(),this._deferredRenderData},i._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=ce.getSampler(e,Co);this._descriptorSet.bindSampler(ee,t),this._descriptorSet.bindTexture(ee,le.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler($e,t),this._descriptorSet.bindTexture($e,le.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new Po;if(!(i=this.createQuadInputAssembler(u.IDENTITY)).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var n=this.createQuadInputAssembler(e.surfaceTransform);if(!n.quadIB||!n.quadVB||!n.quadIA)return!1;if(this._quadVBOnscreen=n.quadVB,this._quadIAOnscreen=n.quadIA,!this._gbufferRenderPass){var r=new ut;r.format=Le.RGBA16F,r.loadOp=Pe.CLEAR,r.storeOp=Ce.STORE;var s=new ut;s.format=Le.RGBA16F,s.loadOp=Pe.CLEAR,s.storeOp=Ce.STORE;var a=new ut;a.format=Le.RGBA16F,a.loadOp=Pe.CLEAR,a.storeOp=Ce.STORE;var o=new ut;o.format=Le.RGBA16F,o.loadOp=Pe.CLEAR,o.storeOp=Ce.STORE;var h=new lt;h.format=e.depthStencilFormat,h.depthLoadOp=Pe.CLEAR,h.depthStoreOp=Ce.STORE,h.stencilLoadOp=Pe.CLEAR,h.stencilStoreOp=Ce.STORE;var l=new ct([r,s,a,o],h);this._gbufferRenderPass=e.createRenderPass(l)}if(!this._lightingRenderPass){var c=new ut;c.format=Le.RGBA16F,c.loadOp=Pe.CLEAR,c.storeOp=Ce.STORE,c.endAccesses=[Be.COLOR_ATTACHMENT_WRITE];var _=new lt;_.format=e.depthStencilFormat,_.depthLoadOp=Pe.LOAD,_.depthStoreOp=Ce.DISCARD,_.stencilLoadOp=Pe.LOAD,_.stencilStoreOp=Ce.DISCARD,_.beginAccesses=[Be.DEPTH_STENCIL_ATTACHMENT_WRITE],_.endAccesses=[Be.DEPTH_STENCIL_ATTACHMENT_WRITE];var d=new ct([c],_);this._lightingRenderPass=e.createRenderPass(d)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),e.surfaceTransform===u.IDENTITY||e.surfaceTransform===u.ROTATE_180?(this._width=e.width,this._height=e.height):(this._width=e.height,this._height=e.width),!0},i.destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(J.BINDING).destroy(),this._descriptorSet.getBuffer(Q.BINDING).destroy(),this._descriptorSet.getBuffer($.BINDING).destroy(),this._descriptorSet.getSampler(ee).destroy(),this._descriptorSet.getSampler($e).destroy(),this._descriptorSet.getTexture(ee).destroy(),this._descriptorSet.getTexture($e).destroy())},i.destroyDeferredData=function(){var e=this._deferredRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.lightingFrameBuffer&&e.lightingFrameBuffer.destroy(),e.depthTex&&e.depthTex.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var i=0;i<e.lightingRenderTargets.length;i++)e.lightingRenderTargets[i].destroy();e.lightingRenderTargets.length=0}this._deferredRenderData=null},i.destroy=function(){this.destroyUBOs(),this.destroyQuadInputAssembler(),this.destroyDeferredData();for(var t=this._renderPasses.values(),i=t.next();!i.done;)i.value.destroy(),i=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},i.resize=function(e,t){this._width===e&&this._height===t||(this._width=e,this._height=t,this.destroyDeferredData(),this._generateDeferredRenderData())},i.createQuadInputAssembler=function(){var e=new Po,t=4*Float32Array.BYTES_PER_ELEMENT,i=4*t,n=this._device.createBuffer(new j(K.VERTEX|K.TRANSFER_DST,Z.HOST|Z.DEVICE,i,t));if(!n)return e;var r=Uint8Array.BYTES_PER_ELEMENT,s=6*r,a=this._device.createBuffer(new j(K.INDEX|K.TRANSFER_DST,Z.HOST|Z.DEVICE,s,r));if(!a)return e;var o=new Uint8Array(6);o[0]=0,o[1]=1,o[2]=2,o[3]=1,o[4]=3,o[5]=2,a.update(o);var h=new Array(2);h[0]=new Xe("a_position",Le.RG32F),h[1]=new Xe("a_texCoord",Le.RG32F);var u=this._device.createInputAssembler(new je(h,[n],a));return e.quadIB=a,e.quadVB=n,e.quadIA=u,e},i.updateQuadVertexData=function(e){if(this._lastUsedRenderArea!==e){this._lastUsedRenderArea=e;var t=this.genQuadVertexData(u.IDENTITY,e);this._quadVBOffscreen.update(t);var i=this.genQuadVertexData(this.device.surfaceTransform,e);this._quadVBOnscreen.update(i)}},i.genQuadVertexData=function(e,t){var i=new Float32Array(16),n=t.x/this.device.width,r=(t.x+t.width)/this.device.width,s=t.y/this.device.height,a=(t.y+t.height)/this.device.height;if(this.device.capabilities.screenSpaceSignY>0){var o=a;a=s,s=o}var h=0;switch(e){case u.IDENTITY:h=0,i[h++]=-1,i[h++]=-1,i[h++]=n,i[h++]=a,i[h++]=1,i[h++]=-1,i[h++]=r,i[h++]=a,i[h++]=-1,i[h++]=1,i[h++]=n,i[h++]=s,i[h++]=1,i[h++]=1,i[h++]=r,i[h++]=s;break;case u.ROTATE_90:h=0,i[h++]=-1,i[h++]=-1,i[h++]=r,i[h++]=a,i[h++]=1,i[h++]=-1,i[h++]=r,i[h++]=s,i[h++]=-1,i[h++]=1,i[h++]=n,i[h++]=a,i[h++]=1,i[h++]=1,i[h++]=n,i[h++]=s;break;case u.ROTATE_180:h=0,i[h++]=-1,i[h++]=-1,i[h++]=n,i[h++]=s,i[h++]=1,i[h++]=-1,i[h++]=r,i[h++]=s,i[h++]=-1,i[h++]=1,i[h++]=n,i[h++]=a,i[h++]=1,i[h++]=1,i[h++]=r,i[h++]=a;break;case u.ROTATE_270:h=0,i[h++]=-1,i[h++]=-1,i[h++]=n,i[h++]=s,i[h++]=1,i[h++]=-1,i[h++]=n,i[h++]=a,i[h++]=-1,i[h++]=1,i[h++]=r,i[h++]=s,i[h++]=1,i[h++]=1,i[h++]=r,i[h++]=a}return i},i.destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},i._generateDeferredRenderData=function(){var e=this.device,t=this._deferredRenderData=new Bo;t.gbufferRenderTargets.push(e.createTexture(new _t(Fe.TEX2D,Ne.COLOR_ATTACHMENT|Ne.SAMPLED,Le.RGBA16F,this._width,this._height))),t.gbufferRenderTargets.push(e.createTexture(new _t(Fe.TEX2D,Ne.COLOR_ATTACHMENT|Ne.SAMPLED,Le.RGBA16F,this._width,this._height))),t.gbufferRenderTargets.push(e.createTexture(new _t(Fe.TEX2D,Ne.COLOR_ATTACHMENT|Ne.SAMPLED,Le.RGBA16F,this._width,this._height))),t.gbufferRenderTargets.push(e.createTexture(new _t(Fe.TEX2D,Ne.COLOR_ATTACHMENT|Ne.SAMPLED,Le.RGBA16F,this._width,this._height))),t.depthTex=e.createTexture(new _t(Fe.TEX2D,Ne.DEPTH_STENCIL_ATTACHMENT,e.depthStencilFormat,this._width,this._height)),t.gbufferFrameBuffer=e.createFramebuffer(new dt(this._gbufferRenderPass,t.gbufferRenderTargets,t.depthTex)),t.lightingRenderTargets.push(e.createTexture(new _t(Fe.TEX2D,Ne.COLOR_ATTACHMENT|Ne.SAMPLED,Le.RGBA16F,this._width,this._height))),t.lightingFrameBuffer=e.createFramebuffer(new dt(this._lightingRenderPass,t.lightingRenderTargets,t.depthTex)),this._descriptorSet.bindTexture(Et,t.gbufferFrameBuffer.colorTextures[0]),this._descriptorSet.bindTexture(wt,t.gbufferFrameBuffer.colorTextures[1]),this._descriptorSet.bindTexture(Tt,t.gbufferFrameBuffer.colorTextures[2]),this._descriptorSet.bindTexture(yt,t.gbufferFrameBuffer.colorTextures[3]),this._descriptorSet.bindTexture(Ot,t.lightingFrameBuffer.colorTextures[0]);var i=ce.getSampler(e,Co);this._descriptorSet.bindSampler(Et,i),this._descriptorSet.bindSampler(wt,i),this._descriptorSet.bindSampler(Tt,i),this._descriptorSet.bindSampler(yt,i),this._descriptorSet.bindSampler(Ot,i)},p(t,[{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}}]),t}(Vn),fo=M((_o=go).prototype,"renderTextures",[oo,H,ho],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),po=M(_o.prototype,"materials",[uo,H,lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),co=_o))||co)),[new v(0,0,0,1)]),Mo=(e("A",(vo=L("PostprocessStage"),So=z(oe),mo=U(),vo((Oo=yo=function(e){function t(){var t;return t=e.call(this)||this,x(t,"_postprocessMaterial",To,se(t)),t._renderArea=new Ie,t._uiPhase=void 0,t._uiPhase=new sa,t}R(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._uiPhase.activate(t)},i.destroy=function(){},i.render=function(e){var t=this._pipeline,i=t.device,r=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var s=e.viewport;this._renderArea.x=s.x*e.width,this._renderArea.y=s.y*e.height,this._renderArea.width=s.width*e.width*t.pipelineSceneData.shadingScale,this._renderArea.height=s.height*e.height*t.pipelineSceneData.shadingScale;var a,o,h=e.window.framebuffer,u=h.colorTextures[0]?h.renderPass:t.getRenderPass(e.clearFlag);e.clearFlag&n.COLOR&&(Lo[0].x=e.clearColor.x,Lo[0].y=e.clearColor.y,Lo[0].z=e.clearColor.z),Lo[0].w=e.clearColor.w,r.beginRenderPass(u,h,this._renderArea,Lo,e.clearDepth,e.clearStencil),r.bindDescriptorSet(Qe.GLOBAL,t.descriptorSet);var l=le.get("builtin-post-process-material");l?(a=l.passes[0],o=ke.get(a.getShaderVariant())):(a=this._postprocessMaterial.passes[0],o=ke.get(this._postprocessMaterial.passes[0].getShaderVariant()));var c=e.window.hasOffScreenAttachments?t.quadIAOffscreen:t.quadIAOnscreen,_=null;null!=a&&null!=o&&null!=c&&(_=ps.getOrCreatePipelineState(i,a,o,u,c));var d=t.pipelineSceneData.renderObjects;null!=_&&d.length>0&&(r.bindPipelineState(_),r.bindInputAssembler(c),r.draw(c)),this._uiPhase.render(e,u),r.endRenderPass()},p(t,[{key:"material",set:function(e){this._postprocessMaterial!==e&&(this._postprocessMaterial=e)}}]),t}($i),yo.initInfo={name:"PostprocessStage",priority:Ra.POSTPROCESS,tag:0},To=M((wo=Oo).prototype,"_postprocessMaterial",[So,H,mo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Eo=wo))||Eo)),e("G",function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t.config={},t.onStart=null,t.collisionMatrix=[],t.groupList=[],t._persistRootNodes={},t._paused=!0,t._configLoaded=!1,t._isCloning=!1,t._inited=!1,t._engineInited=!1,t._rendererInitialized=!1,t._gfxDevice=null,t._intervalId=null,t}R(t,e);var i=t.prototype;return i.setFrameRate=function(e){var t=this.config;"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),t.frameRate=e,this._paused=!0,this._setAnimFrame(),this._runMainLoop()},i.getFrameRate=function(){return this.config.frameRate||0},i.step=function(){c.director.mainLoop()},i.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},i.resume=function(){this._paused&&this._runMainLoop()},i.isPaused=function(){return this._paused},i.restart=function(){var e=this;return new Promise((function(e){return c.director.once(c.Director.EVENT_AFTER_DRAW,(function(){return e()}))})).then((function(){for(var i in e._persistRootNodes)e.removePersistRootNode(e._persistRootNodes[i]);return c.director.getScene().destroy(),c.Object._deferredDestroy(),c.director.reset(),e.pause(),e._setRenderPipelineNShowSplash().then((function(){e.resume(),e._safeEmit(t.EVENT_RESTART)}))}))},i.end=function(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),window.close()},i.on=function(e,i,n,r){return(this._engineInited&&e===t.EVENT_ENGINE_INITED||this._inited&&e===t.EVENT_GAME_INITED||this._rendererInitialized&&e===t.EVENT_RENDERER_INITED)&&i.call(n),this.eventTargetOn(e,i,n,r)},i.once=function(e,i,n){return this._engineInited&&e===t.EVENT_ENGINE_INITED?i.call(n):this.eventTargetOnce(e,i,n)},i.init=function(e){var t=this;return this._initConfig(e),this.config.assetOptions&&c.assetManager.init(this.config.assetOptions),this._initEngine().then((function(){return t._initEvents(),c.director.root.dataPoolManager&&c.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._engineInited}))},i.run=function(e,t){var i,n=this;return"function"!=typeof e&&e?(i=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,Promise.resolve(i).then((function(){return xo.config.registerSystemEvent&&yi.registerSystemEvent(),n._setRenderPipelineNShowSplash()}))},i.addPersistRootNode=function(e){if(c.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=c.director._scene;if(c.isValid(i))if(e.parent){if(!(e.parent instanceof c.Scene))return void P(3801);if(e.parent!==i)return void P(3802);e._originalSceneId=i.uuid}else e.parent=i;this._persistRootNodes[t]=e,e._persistNode=!0,c.assetManager._releaseManager._addPersistNodeRef(e)}}else P(3800)},i.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",c.assetManager._releaseManager._removePersistNodeRef(e))},i.isPersistRootNode=function(e){return!!e._persistNode},i._initEngine=function(){var e=this;return this._initDevice(),Promise.resolve(c.director._init()).then((function(){At("Cocos Creator v"+It),e.emit(t.EVENT_ENGINE_INITED),e._engineInited=!0,c.internal.dynamicAtlasManager.enabled=!N.CLEANUP_IMAGE_CACHE}))},i._setAnimFrame=function(){this._lastTime=performance.now();var e=this.config.frameRate;this._frameTime=1e3/e,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0);var t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=t?this._stTimeWithRAF:this._stTime,window.cAF=this._ctTime):(window.rAF=t||this._stTime,window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime)},i._stTimeWithRAF=function(e){var t=performance.now(),i=Math.max(0,t-xo._lastTime),n=Math.max(0,xo._frameTime-i),r=window.setTimeout((function(){window.requestAnimationFrame(e)}),n);return xo._lastTime=t+n,r},i._stTime=function(e){var t=performance.now(),i=Math.max(0,t-xo._lastTime),n=Math.max(0,xo._frameTime-i),r=window.setTimeout(e,n);return xo._lastTime=t+n,r},i._ctTime=function(e){window.clearTimeout(e)},i._runMainLoop=function(){var e=this;if(this._inited&&!bt){var t,i=this.config,n=c.director,r=i.frameRate;if(Rt(!!i.showFPS),n.startAnimation(),30===r){var s=!0;t=function(i){e._intervalId=window.rAF(t),(s=!s)||n.mainLoop(i)}}else t=function(i){e._intervalId=window.rAF(t),n.mainLoop(i)};this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._intervalId=window.rAF(t),this._paused=!1}},i._initConfig=function(e){"number"!=typeof e.debugMode&&(e.debugMode=Dt.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>2||t<0)&&(e.renderMode=0),"boolean"!=typeof e.registerSystemEvent&&(e.registerSystemEvent=!0),e.showFPS=!!e.showFPS,this.collisionMatrix=e.collisionMatrix||[],this.groupList=e.groupList||[],Ft(e.debugMode),this.config=e,this._configLoaded=!0,this._setAnimFrame()},i._determineRenderType=function(){var e=this.config,i=parseInt(e.renderMode,10);this.renderType=t.RENDER_TYPE_CANVAS;var n=!1;if(0===i?c.sys.capabilities.opengl?(this.renderType=t.RENDER_TYPE_WEBGL,n=!0):c.sys.capabilities.canvas&&(this.renderType=t.RENDER_TYPE_CANVAS,n=!0):1===i&&c.sys.capabilities.canvas?(this.renderType=t.RENDER_TYPE_CANVAS,n=!0):2===i&&c.sys.capabilities.opengl&&(this.renderType=t.RENDER_TYPE_WEBGL,n=!0),!n)throw new Error(Nt(3820,i))},i._initDevice=function(){if(!this._rendererInitialized){if(this.canvas=this.config.adapter.canvas,this.frame=this.config.adapter.frame,this.container=this.config.adapter.container,this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var e=[],i=!!window.WebGL2RenderingContext,n=window.navigator.userAgent.toLowerCase();(-1!==n.indexOf("safari")&&-1===n.indexOf("chrome")||Ct.browserType===Pt.UC)&&(i=!1),i&&c.WebGL2Device&&e.push(c.WebGL2Device),c.WebGLDevice&&e.push(c.WebGLDevice);for(var r=new Bt(this.canvas,N.ENABLE_WEBGL_ANTIALIAS,!1,window.devicePixelRatio,Lt.windowPixelResolution.width,Lt.windowPixelResolution.height,Mt),s=0;s<e.length&&(this._gfxDevice=new e[s],!this._gfxDevice.initialize(r));s++);}if(!this._gfxDevice)return xt("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=function(){return!1}}},i._initEvents=function(){Ct.onShow(this._onShow.bind(this)),Ct.onHide(this._onHide.bind(this))},i._onHide=function(){this.emit(t.EVENT_HIDE),this.pause()},i._onShow=function(){this.emit(t.EVENT_SHOW),this.resume()},i._setRenderPipelineNShowSplash=function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(e._showSplashScreen()).then((function(){e._inited=!0,e._setAnimFrame(),e._runMainLoop(),e._safeEmit(t.EVENT_GAME_INITED),e.onStart&&e.onStart()}))}))},i._setupRenderPipeline=function(){var e=this,t=this.config.renderPipeline;return t?new Promise((function(e,i){c.assetManager.loadAny(t,(function(t,n){return!t&&n instanceof Vn?e(n):i(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(i){Ht(i),Ht("Failed load render pipeline: "+t+", engine failed to initialize, will fallback to default pipeline"),e._setRenderPipeline()})):this._setRenderPipeline()},i._showSplashScreen=function(){if(c.internal.SplashScreen){var e=c.internal.SplashScreen.instance;return e.main(c.director.root),new Promise((function(t){e.setOnFinish((function(){return t()})),e.loadFinish=!0}))}return null},i._setRenderPipeline=function(e){c.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)},i._safeEmit=function(e){this.emit(e)},p(t,[{key:"inited",get:function(){return this._inited}},{key:"frameTime",get:function(){return this._frameTime}}]),t}(A)));Mo.EVENT_HIDE="game_on_hide",Mo.EVENT_SHOW="game_on_show",Mo.EVENT_LOW_MEMORY="game_on_low_memory",Mo.EVENT_GAME_INITED="game_inited",Mo.EVENT_ENGINE_INITED="engine_inited",Mo.EVENT_RENDERER_INITED="renderer_inited",Mo.EVENT_RESTART="game_on_restart",Mo.RENDER_TYPE_CANVAS=0,Mo.RENDER_TYPE_WEBGL=1,Mo.RENDER_TYPE_OPENGL=2,c.Game=Mo;var xo=e("o",c.game=new Mo),Ho=e("K",{topLeft:c.v2(0,0),topRight:c.v2(0,0),top:c.v2(0,0),bottomLeft:c.v2(0,0),bottomRight:c.v2(0,0),bottom:c.v2(0,0),center:c.v2(0,0),left:c.v2(0,0),right:c.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,i=this.height=e.height,n=e.x,r=e.y,s=r+i,a=n+t;this.topLeft.x=n,this.topLeft.y=s,this.topRight.x=a,this.topRight.y=s,this.top.x=n+t/2,this.top.y=s,this.bottomLeft.x=n,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=n+t/2,this.bottom.y=r,this.center.x=n+t/2,this.center.y=r+i/2,this.left.x=n,this.left.y=r+i/2,this.right.x=a,this.right.y=r+i/2}});c.visibleRect=Ho;var Uo=new(function(){function e(){this.html=void 0,this.meta={width:"device-width"},this.adaptationType=c.sys.browserType}var t=e.prototype;return t.init=function(){},t.availWidth=function(e){return c.sys.isMobile||!e||e===this.html?window.innerWidth:e.clientWidth},t.availHeight=function(e){return c.sys.isMobile||!e||e===this.html?window.innerHeight:e.clientHeight},e}());switch(Ct.os===Ut.IOS&&(Uo.adaptationType=Pt.SAFARI),Uo.adaptationType){case Pt.SAFARI:Uo.meta["minimal-ui"]="true",Uo.availWidth=function(e){return e.clientWidth},Uo.availHeight=function(e){return e.clientHeight};break;case Pt.SOUGOU:case Pt.UC:Uo.availWidth=function(e){return e.clientWidth},Uo.availHeight=function(e){return e.clientHeight}}var zo=e("V",function(e){function t(){var t;(t=e.call(this)||this)._resizeWithBrowserSize=void 0,t._designResolutionSize=void 0,t._originalDesignResolutionSize=void 0,t._frameSize=void 0,t._scaleX=void 0,t._scaleY=void 0,t._viewportRect=void 0,t._visibleRect=void 0,t._autoFullScreen=void 0,t._devicePixelRatio=void 0,t._maxPixelRatio=void 0,t._retinaEnabled=void 0,t._resizeCallback=void 0,t._resizing=void 0,t._orientationChanging=void 0,t._isRotated=void 0,t._orientation=void 0,t._isAdjustViewport=void 0,t._resolutionPolicy=void 0,t._rpExactFit=void 0,t._rpShowAll=void 0,t._rpNoBorder=void 0,t._rpFixedHeight=void 0,t._rpFixedWidth=void 0;var i=Go,n=Vo;return t._frameSize=new zt(0,0),t._designResolutionSize=new zt(0,0),t._originalDesignResolutionSize=new zt(0,0),t._scaleX=1,t._scaleY=1,t._viewportRect=new S(0,0,0,0),t._visibleRect=new S(0,0,0,0),t._autoFullScreen=!1,t._devicePixelRatio=1,t._maxPixelRatio=2,t._retinaEnabled=!1,t._resizeCallback=null,t._resizing=!1,t._resizeWithBrowserSize=!1,t._orientationChanging=!0,t._isRotated=!1,t._orientation=c.macro.ORIENTATION_AUTO,t._isAdjustViewport=!0,t._rpExactFit=new Wo(i.EQUAL_TO_FRAME,n.EXACT_FIT),t._rpShowAll=new Wo(i.EQUAL_TO_FRAME,n.SHOW_ALL),t._rpNoBorder=new Wo(i.EQUAL_TO_FRAME,n.NO_BORDER),t._rpFixedHeight=new Wo(i.EQUAL_TO_FRAME,n.FIXED_HEIGHT),t._rpFixedWidth=new Wo(i.EQUAL_TO_FRAME,n.FIXED_WIDTH),t._resolutionPolicy=t._rpShowAll,c.game.once(c.Game.EVENT_ENGINE_INITED,t.init,se(t)),t}R(t,e);var i=t.prototype;return i.init=function(){Uo.init(),this._initFrameSize();var e=c.game.canvas.width,t=c.game.canvas.height;this._designResolutionSize.width=e,this._designResolutionSize.height=t,this._originalDesignResolutionSize.width=e,this._originalDesignResolutionSize.height=t,this._viewportRect.width=e,this._viewportRect.height=t,this._visibleRect.width=e,this._visibleRect.height=t,c.winSize.width=this._visibleRect.width,c.winSize.height=this._visibleRect.height,c.visibleRect&&c.visibleRect.init(this._visibleRect)},i.resizeWithBrowserSize=function(e){e?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,Ct.onViewResize(this._resizeEvent),Ct.onOrientationChange(this._orientationChange)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,Ct.offViewResize(this._resizeEvent),Ct.offOrientationChange(this._orientationChange))},i.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},i.setOrientation=function(e){(e&=c.macro.ORIENTATION_AUTO)&&this._orientation!==e&&(this._orientation=e)},i.adjustViewportMeta=function(e){this._isAdjustViewport=e},i.enableRetina=function(e){this._retinaEnabled=!!e},i.isRetinaEnabled=function(){return this._retinaEnabled},i.enableAutoFullScreen=function(e){e&&e!==this._autoFullScreen&&c.sys.isMobile&&Ct.browserType!==Pt.WECHAT?(this._autoFullScreen=!0,c.screen.autoFullScreen(c.game.frame)):this._autoFullScreen=!1},i.isAutoFullScreenEnabled=function(){return this._autoFullScreen},i.setCanvasSize=function(e,t){var i=c.game.canvas,n=c.game.container;this._devicePixelRatio=window.devicePixelRatio,i.width=Lt.windowPixelResolution.width,i.height=Lt.windowPixelResolution.height,i.style.width=e+"px",i.style.height=t+"px",n.style.width=e+"px",n.style.height=t+"px",this._resizeEvent()},i.getCanvasSize=function(){return new zt(c.game.canvas.width,c.game.canvas.height)},i.getFrameSize=function(){return new zt(this._frameSize.width,this._frameSize.height)},i.setFrameSize=function(e,t){this._frameSize.width=e,this._frameSize.height=t,c.game.frame.style.width=e+"px",c.game.frame.style.height=t+"px",this._resizeEvent()},i.getVisibleSize=function(){return new zt(this._visibleRect.width,this._visibleRect.height)},i.getVisibleSizeInPixel=function(){return new zt(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},i.getVisibleOrigin=function(){return new b(this._visibleRect.x,this._visibleRect.y)},i.getVisibleOriginInPixel=function(){return new b(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},i.getResolutionPolicy=function(){return this._resolutionPolicy},i.setResolutionPolicy=function(e){if(e instanceof Wo)this._resolutionPolicy=e;else{var t=Wo;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},i.setDesignResolutionSize=function(e,t,i){if(e>0&&t>0){this.setResolutionPolicy(i);var n=this._resolutionPolicy;if(n&&n.preApply(this),c.sys.isMobile&&this._adjustViewportMeta(),this._orientationChanging=!0,this._resizing||this._initFrameSize(),n){this._originalDesignResolutionSize.width=this._designResolutionSize.width=e,this._originalDesignResolutionSize.height=this._designResolutionSize.height=t;var r=n.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var s=this._viewportRect,a=this._visibleRect,o=r.viewport;s.x=o.x,s.y=o.y,s.width=o.width,s.height=o.height,a.x=0,a.y=0,a.width=o.width/this._scaleX,a.height=o.height/this._scaleY}n.postApply(this),c.winSize.width=this._visibleRect.width,c.winSize.height=this._visibleRect.height,Ho&&Ho.init(this._visibleRect),this.emit("design-resolution-changed")}else F(2201)}else pt(2200)},i.getDesignResolutionSize=function(){return new zt(this._designResolutionSize.width,this._designResolutionSize.height)},i.setRealPixelResolution=function(e,t,i){this.setDesignResolutionSize(e,t,i)},i.getViewportRect=function(){return this._viewportRect},i.getScaleX=function(){return this._scaleX},i.getScaleY=function(){return this._scaleY},i.getDevicePixelRatio=function(){return this._devicePixelRatio},i.convertToLocationInView=function(e,t,i,n){var r=n||new b,s=this._devicePixelRatio*(e-i.left),a=this._devicePixelRatio*(i.top+i.height-t);return this._isRotated?(r.x=c.game.canvas.width-a,r.y=s):(r.x=s,r.y=a),c.GAME_VIEW&&(r.x/=c.gameView.canvas.width/c.game.canvas.width,r.y/=c.gameView.canvas.height/c.game.canvas.height),r},i._convertPointWithScale=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},i._resizeEvent=function(){var e=c.view,t=e._frameSize.width,i=e._frameSize.height,n=e._isRotated;if(c.sys.isMobile){var r=c.game.container.style,s=r.margin;r.margin="0",r.display="none",e._initFrameSize(),r.margin=s,r.display="block"}else e._initFrameSize();if(e._orientationChanging||e._isRotated!==n||e._frameSize.width!==t||e._frameSize.height!==i){var a=e._originalDesignResolutionSize.width,o=e._originalDesignResolutionSize.height;e._resizing=!0,a>0&&e.setDesignResolutionSize(a,o,e._resolutionPolicy),e._resizing=!1,e.emit("canvas-resize"),e._resizeCallback&&e._resizeCallback.call()}},i._orientationChange=function(){c.view._orientationChanging=!0,c.view._resizeEvent()},i._initFrameSize=function(){var e=this._frameSize,t=Uo.availWidth(c.game.frame),i=Uo.availHeight(c.game.frame),n=t>=i;!c.sys.isMobile||n&&this._orientation&c.macro.ORIENTATION_LANDSCAPE||!n&&this._orientation&c.macro.ORIENTATION_PORTRAIT?(e.width=t,e.height=i,c.game.container.style["-webkit-transform"]="rotate(0deg)",c.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(e.width=i,e.height=t,c.game.container.style["-webkit-transform"]="rotate(90deg)",c.game.container.style.transform="rotate(90deg)",c.game.container.style["-webkit-transform-origin"]="0px 0px 0px",c.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,c.game.canvas.style["-webkit-transform"]="translateZ(0px)",c.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout((function(){c.view._orientationChanging=!1}),1e3)},i._adjustSizeKeepCanvasSize=function(){var e=this._originalDesignResolutionSize.width,t=this._originalDesignResolutionSize.height;e>0&&this.setDesignResolutionSize(e,t,this._resolutionPolicy)},i._setViewportMeta=function(e,t){var i=document.getElementById("cocosMetaElement");i&&t&&document.head.removeChild(i);var n,r,s,a=document.getElementsByName("viewport"),o=a?a[0]:null;for(r in n=o?o.content:"",(i=i||document.createElement("meta")).id="cocosMetaElement",i.name="viewport",i.content="",e)-1===n.indexOf(r)?n+=","+r+"="+e[r]:t&&(s=new RegExp(r+"s*=s*[^,]+"),n=n.replace(s,r+"="+e[r]));/^,/.test(n)&&(n=n.substr(1)),i.content=n,o&&(o.content=n),document.head.appendChild(i)},i._adjustViewportMeta=function(){!this._isAdjustViewport||Gt||Vt||Wt||(this._setViewportMeta(Uo.meta,!1),this._isAdjustViewport=!1)},i._convertMouseToLocation=function(e,t){e.x=this._devicePixelRatio*(e.x-t.left),e.y=this._devicePixelRatio*(t.top+t.height-e.y),c.GAME_VIEW&&(e.x/=c.gameView.canvas.width/c.game.canvas.width,e.y/=c.gameView.canvas.height/c.game.canvas.height)},i._convertTouchWidthScale=function(e){var t=this._viewportRect,i=this._scaleX,n=this._scaleY;e._point.x=(e._point.x-t.x)/i,e._point.y=(e._point.y-t.y)/n,e._prevPoint.x=(e._prevPoint.x-t.x)/i,e._prevPoint.y=(e._prevPoint.y-t.y)/n},i._convertTouchesWithScale=function(e){for(var t,i,n=this._viewportRect,r=this._scaleX,s=this._scaleY,a=0;a<e.length;a++){var o=e[a];t=o._point,i=o._prevPoint,t.x=(t.x-n.x)/r,t.y=(t.y-n.y)/s,i.x=(i.x-n.x)/r,i.y=(i.y-n.y)/s}},t}(A));zo.instance=void 0;var Go=function(){function e(){this.name="ContainerStrategy"}var t=e.prototype;return t.preApply=function(){},t.apply=function(){},t.postApply=function(){},t._setupContainer=function(e,t,i){var n=c.game.canvas,r=c.game.container;Ct.os===Ut.ANDROID&&(document.body.style.width=(e._isRotated?i:t)+"px",document.body.style.height=(e._isRotated?t:i)+"px"),r.style.width=n.style.width=t+"px",r.style.height=n.style.height=i+"px",e._devicePixelRatio=1,e.isRetinaEnabled()&&(e._devicePixelRatio=Math.min(e._maxPixelRatio,window.devicePixelRatio||1)),n.width=t*e._devicePixelRatio,n.height=i*e._devicePixelRatio},t._fixContainer=function(){document.body.insertBefore(c.game.container,document.body.firstChild);var e=document.body.style;e.width=window.innerWidth+"px",e.height=window.innerHeight+"px",e.overflow="hidden";var t=c.game.container.style;t.position="fixed",t.left=t.top="0px",document.body.scrollTop=0},e}();Go.EQUAL_TO_FRAME=void 0,Go.PROPORTION_TO_FRAME=void 0;var Vo=function(){function e(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var t=e.prototype;return t.preApply=function(){},t.apply=function(){return{scale:[1,1]}},t.postApply=function(){},t._buildResult=function(e,t,i,n,r,s){Math.abs(e-i)<2&&(i=e),Math.abs(t-n)<2&&(n=t);var a=new S(Math.round((e-i)/2),Math.round((t-n)/2),i,n);return this._result.scale=[r,s],this._result.viewport=a,this._result},e}();Vo.EXACT_FIT=void 0,Vo.SHOW_ALL=void 0,Vo.NO_BORDER=void 0,Vo.FIXED_HEIGHT=void 0,Vo.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="EqualToFrame",t}return R(t,e),t.prototype.apply=function(e){var t=e._frameSize.height,i=c.game.container.style;this._setupContainer(e,e._frameSize.width,e._frameSize.height),e._isRotated?i.margin="0 0 0 "+t+"px":i.margin="0px",i.padding="0px"},t}(Go),t=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="ProportionalToFrame",t}return R(t,e),t.prototype.apply=function(e,t){var i,n,r=e._frameSize.width,s=e._frameSize.height,a=c.game.container.style,o=t.width,h=t.height,u=r/o,l=s/h;u<l?(i=r,n=h*u):(i=o*l,n=s);var _=Math.round((r-i)/2),d=Math.round((s-n)/2);i=r-2*_,n=s-2*d,this._setupContainer(e,i,n),e._isRotated?a.margin="0 0 0 "+s+"px":a.margin="0px",a.paddingLeft=_+"px",a.paddingRight=_+"px",a.paddingTop=d+"px",a.paddingBottom=d+"px"},t}(Go),i=("undefined"==typeof window?global:window).__globalAdapter;i&&(i.adaptContainerStrategy&&i.adaptContainerStrategy(Go.prototype),i.adaptView&&i.adaptView(zo.prototype)),Go.EQUAL_TO_FRAME=new e,Go.PROPORTION_TO_FRAME=new t;var n=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="ExactFit",t}return R(t,e),t.prototype.apply=function(e,t){var i=c.game.canvas.width,n=c.game.canvas.height,r=i/t.width,s=n/t.height;return this._buildResult(i,n,i,n,r,s)},t}(Vo),r=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="ShowAll",t}return R(t,e),t.prototype.apply=function(e,t){var i,n,r=c.game.canvas.width,s=c.game.canvas.height,a=t.width,o=t.height,h=r/a,u=s/o,l=0;return h<u?(i=r,n=o*(l=h)):(i=a*(l=u),n=s),this._buildResult(r,s,i,n,l,l)},t}(Vo),s=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="NoBorder",t}return R(t,e),t.prototype.apply=function(e,t){var i,n,r,s=c.game.canvas.width,a=c.game.canvas.height,o=t.width,h=t.height,u=s/o,l=a/h;return u<l?(n=o*(i=l),r=a):(n=s,r=h*(i=u)),this._buildResult(s,a,n,r,i,i)},t}(Vo),a=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="FixedHeight",t}return R(t,e),t.prototype.apply=function(e,t){var i=c.game.canvas.width,n=c.game.canvas.height,r=n/t.height,s=i,a=n;return this._buildResult(i,n,s,a,r,r)},t}(Vo),o=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="FixedWidth",t}return R(t,e),t.prototype.apply=function(e,t){var i=c.game.canvas.width,n=c.game.canvas.height,r=i/t.width,s=i,a=n;return this._buildResult(i,n,s,a,r,r)},t}(Vo);Vo.EXACT_FIT=new n,Vo.SHOW_ALL=new r,Vo.NO_BORDER=new s,Vo.FIXED_HEIGHT=new a,Vo.FIXED_WIDTH=new o}();var Wo=e("R",function(){function e(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}var t=e.prototype;return t.preApply=function(e){this._containerStrategy.preApply(e),this._contentStrategy.preApply(e)},t.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},t.postApply=function(e){this._containerStrategy.postApply(e),this._contentStrategy.postApply(e)},t.setContainerStrategy=function(e){e instanceof Go&&(this._containerStrategy=e)},t.setContentStrategy=function(e){e instanceof Vo&&(this._contentStrategy=e)},p(e,[{key:"canvasSize",get:function(){return new b(c.game.canvas.width,c.game.canvas.height)}}]),e}());Wo.EXACT_FIT=0,Wo.NO_BORDER=1,Wo.SHOW_ALL=2,Wo.FIXED_HEIGHT=3,Wo.FIXED_WIDTH=4,Wo.UNKNOWN=5,Wo.ContainerStrategy=Go,Wo.ContentStrategy=Vo,c.ResolutionPolicy=Wo,e("v",zo.instance=c.view=new zo),c.winSize=new zt,kt(zo.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),y(di,"EventMouse",["DOWN","UP","MOVE"].map((function(e){return{name:e,newName:"MOUSE_"+e,target:Ri.EventType,targetName:"SystemEvent.EventType"}}))),y(di,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:Ri.EventType,targetName:"SystemEvent.EventType"}]),y(fi,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:Ri.EventType,targetName:"SystemEvent.EventType"}]),y(fi,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:Ri.EventType,targetName:"SystemEvent.EventType"}]),y(fi,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:Ri.EventType,targetName:"SystemEvent.EventType"}]),y(fi,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:Ri.EventType,targetName:"SystemEvent.EventType"}]),y(Lt,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(e){return{name:"LANGUAGE_"+e,newName:e,target:Lt.Language,targetName:"sys.Language"}}))),y(Lt,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(e){return{name:"OS_"+e,newName:e,target:Lt.OS,targetName:"sys.OS"}}))),y(Lt,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(e){return{name:"BROWSER_TYPE_"+e,newName:e,target:Lt.BrowserType,targetName:"sys.BrowserType"}}))),y(Lt,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:Lt.BrowserType,targetName:"sys.BrowserType"}]),y(Lt,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(e){return{name:e,target:Lt.Platform,targetName:"sys.Platform"}}))),y(Lt,"sys",[{name:"IPHONE",newName:"IOS",target:Lt.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:Lt.Platform,targetName:"sys.Platform"}]),kt(Lt,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(e){return{name:e}})));var ko=e("s",{_supportsFullScreen:!1,_onfullscreenchange:null,_onfullscreenerror:null,_preOnFullScreenError:null,_preOnTouch:null,_touchEvent:"",_fn:null,_fnMap:[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement"]],init:function(){var e,t,i;this._fn={};var n,r=this._fnMap;for(e=0,t=r.length;e<t;e++)if((i=r[e])&&void 0!==document[i[1]]){for(e=0,n=i.length;e<n;e++)this._fn[r[0][e]]=i[e];break}this._supportsFullScreen=void 0!==this._fn.requestFullscreen,this._touchEvent="ontouchstart"in window?"touchstart":"mousedown"},get supportsFullScreen(){return this._supportsFullScreen},fullScreen:function(){return!!this._supportsFullScreen&&void 0!==document[this._fn.fullscreenElement]&&null!==document[this._fn.fullscreenElement]},requestFullScreen:function(e,t,i){if(this._supportsFullScreen){if(e=e||document.documentElement,t){var n=this._fn.fullscreenchange;this._onfullscreenchange&&document.removeEventListener(n,this._onfullscreenchange),this._onfullscreenchange=t,document.addEventListener(n,t,!1)}if(i){var r=this._fn.fullscreenerror;this._onfullscreenerror&&document.removeEventListener(r,this._onfullscreenerror),this._onfullscreenerror=i,document.addEventListener(r,i,{once:!0})}var s=e[this._fn.requestFullscreen]();return window.Promise&&s instanceof Promise&&s.catch((function(){})),s}},exitFullScreen:function(){var e;return this.fullScreen()&&(e=document[this._fn.exitFullscreen]()).catch((function(){})),e},autoFullScreen:function(e,t){e=e||document.body,this._ensureFullScreen(e,t),this.requestFullScreen(e,t)},disableAutoFullScreen:function(e){if(this._preOnTouch){var t=c.game.canvas||e,i=this._touchEvent;t.removeEventListener(i,this._preOnTouch),this._preOnTouch=null}},_ensureFullScreen:function(e,t){var i=this,n=c.game.canvas||e,r=this._fn.fullscreenerror,s=this._touchEvent,a=function(){i._preOnFullScreenError=null,i._preOnTouch&&n.removeEventListener(s,i._preOnTouch),i._preOnTouch=function(){i._preOnTouch=null,i.requestFullScreen(e,t)},n.addEventListener(s,i._preOnTouch,{once:!0})};this._preOnFullScreenError&&e.removeEventListener(r,this._preOnFullScreenError),this._preOnFullScreenError=a,e.addEventListener(r,a,{once:!0})}});ko.init(),c.screen=ko}}}));
