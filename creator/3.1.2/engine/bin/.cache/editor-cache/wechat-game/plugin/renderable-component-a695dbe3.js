System.register(["./fog-01fb8507.js","./screen-3553948d.js"],(function(t){"use strict";var e,s,i,n,a,h,r,o,l,_,d,u,c,g,f,m,p,A,S,I,E,y,L,b,v,N,M,R,B,T,C,H,P,D,F,O,U,w,k,G,V,W,z,x,Y,Z,K,X,j,Q,q,J,$,tt,et,st,it,nt,at,ht,rt,ot,lt,_t,dt,ut,ct,gt,ft,mt,pt,At,St,It,Et,yt,Lt;return{setters:[function(t){e=t.c0,s=t.bV,i=t.cj,n=t.c3,a=t.c5,h=t.t,r=t.ci,o=t.eW,l=t.ew,_=t.dH,d=t.dG,u=t.eo,c=t.l,g=t.bL,f=t.cY,m=t.ev,p=t.cF,A=t.cE,S=t.bu,I=t.cb,E=t.bK,y=t.bX,L=t.bY,b=t.ca,v=t.gq,N=t.aS,M=t.f,R=t.bS,B=t.bU,T=t.aG,C=t.d3,H=t.P,P=t.bQ,D=t.L,F=t.N,O=t.cd,U=t.b$,w=t.c1,k=t.cc,G=t.c6,V=t.bT,W=t.ch,z=t.cg,x=t.gr,Y=t.eZ,Z=t.c_,K=t.es,X=t.bR,j=t.fb,Q=t.bW,q=t.F,J=t.b2,$=t.bb,tt=t.gs,et=t.ap,st=t.z,it=t.G,nt=t.d0,at=t.ct,ht=t.eS,rt=t.eV,ot=t.eu,lt=t.eA,_t=t.e7,dt=t.ex,ut=t.eJ,ct=t.gt,gt=t.eE,ft=t.eN,mt=t.eq,pt=t.eF},function(t){At=t.e,St=t.L,It=t.g,Et=t.I,yt=t.n,Lt=t.M}],execute:function(){t("M",void 0);var bt=t("R",function(){function t(t){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._scenePoolHandle=s,this._modelArrayHandle=s,this._batchArrayHandle=s,this._sphereLightsHandle=s,this._spotLightsHandle=s,this._root=t,this._createHandles()}t.registerCreateFunc=function(e){e._createSceneFun=function(e){return new t(e)}};var _=t.prototype;return _.initialize=function(t){return this._name=t.name,this._createHandles(),!0},_.update=function(t){var e=this._mainLight;e&&e.update();for(var s=this._sphereLights,i=0;i<s.length;i++)s[i].update();for(var n=this._spotLights,a=0;a<n.length;a++)n[a].update();for(var h=this._models,r=0;r<h.length;r++){var o=h[r];o.enabled&&(o.updateTransform(t),o.updateUBOs(t))}},_.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._modelArrayHandle&&(e.free(this._modelArrayHandle),this._modelArrayHandle=s),this._scenePoolHandle&&(i.free(this._scenePoolHandle),this._scenePoolHandle=s),this._sphereLightsHandle&&(n.free(this._sphereLightsHandle),this._sphereLightsHandle=s),this._spotLightsHandle&&(n.free(this._spotLightsHandle),this._spotLightsHandle=s),this._batchArrayHandle&&(a.free(this._batchArrayHandle),this._batchArrayHandle=s)},_.addCamera=function(t){t.attachToScene(this),this._cameras.push(t)},_.removeCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return this._cameras.splice(e,1),void t.detachFromScene()},_.removeCameras=function(){for(var t,e=h(this._cameras);!(t=e()).done;)t.value.detachFromScene();this._cameras.splice(0)},_.setMainLight=function(t){this._mainLight=t,i.set(this._scenePoolHandle,r.MAIN_LIGHT,t.handle)},_.unsetMainLight=function(t){if(this._mainLight===t){var e=this._directionalLights;e.length?(this._mainLight=e[e.length-1],this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=o.ROTATION)):this._mainLight=null}},_.addDirectionalLight=function(t){t.attachToScene(this),this._directionalLights.push(t)},_.removeDirectionalLight=function(t){for(var e=0;e<this._directionalLights.length;++e)if(this._directionalLights[e]===t)return t.detachFromScene(),void this._directionalLights.splice(e,1)},_.addSphereLight=function(t){t.attachToScene(this),this._sphereLights.push(t),n.push(this._sphereLightsHandle,t.handle)},_.removeSphereLight=function(t){for(var e=0;e<this._sphereLights.length;++e)if(this._sphereLights[e]===t)return t.detachFromScene(),this._sphereLights.splice(e,1),void n.erase(this._sphereLightsHandle,e)},_.addSpotLight=function(t){t.attachToScene(this),this._spotLights.push(t),n.push(this._spotLightsHandle,t.handle)},_.removeSpotLight=function(t){for(var e=0;e<this._spotLights.length;++e)if(this._spotLights[e]===t)return t.detachFromScene(),this._spotLights.splice(e,1),void n.erase(this._spotLightsHandle,e)},_.removeSphereLights=function(){for(var t=0;t<this._sphereLights.length;++t)this._sphereLights[t].detachFromScene();this._sphereLights.length=0,n.clear(this._sphereLightsHandle)},_.removeSpotLights=function(){for(var t=0;t<this._spotLights.length;++t)this._spotLights[t].detachFromScene();this._spotLights=[],n.clear(this._spotLightsHandle)},_.addModel=function(t){t.attachToScene(this),this._models.push(t),e.push(this._modelArrayHandle,t.handle)},_.removeModel=function(t){for(var s=0;s<this._models.length;++s)if(this._models[s]===t)return t.detachFromScene(),this._models.splice(s,1),void e.erase(this._modelArrayHandle,s)},_.removeModels=function(){for(var t,s=h(this._models);!(t=s()).done;){var i=t.value;i.detachFromScene(),i.destroy()}this._models.length=0,e.clear(this._modelArrayHandle)},_.addBatch=function(t){this._batches.push(t),a.push(this._batchArrayHandle,t.handle)},_.removeBatch=function(t){for(var e=0;e<this._batches.length;++e)if(this._batches[e]===t)return this._batches.splice(e,1),void a.erase(this._batchArrayHandle,e)},_.removeBatches=function(){this._batches.length=0,a.clear(this._batchArrayHandle)},_.onGlobalPipelineStateChanged=function(){for(var t,e=h(this._models);!(t=e()).done;)t.value.onGlobalPipelineStateChanged()},_.generateModelId=function(){return this._modelId++},_._createHandles=function(){this._modelArrayHandle||(this._modelArrayHandle=e.alloc(),this._scenePoolHandle=i.alloc(),i.set(this._scenePoolHandle,r.MODEL_ARRAY,this._modelArrayHandle),this._spotLightsHandle=n.alloc(),i.set(this._scenePoolHandle,r.SPOT_LIGHT_ARRAY,this._spotLightsHandle),this._sphereLightsHandle=n.alloc(),i.set(this._scenePoolHandle,r.SPHERE_LIGHT_ARRAY,this._sphereLightsHandle)),this._batchArrayHandle||(this._batchArrayHandle=a.alloc(),i.set(this._scenePoolHandle,r.BATCH_ARRAY_2D,this._batchArrayHandle))},l(t,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"handle",get:function(){return this._scenePoolHandle}},{key:"batches",get:function(){return this._batches}}]),t}());_(bt.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),_(bt.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var vt=t("C",{});_(vt,"CameraVisFlags",[{name:"GENERAL"}]),d(vt,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:u.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:u.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:u.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:u.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:u.BitMask,targetName:"UI_2D"}]),c.CameraVisFlags=vt;var Nt=t("V",{});_(Nt,"VisibilityFlags",[{name:"GENERAL"}]),d(Nt,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:u.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:u.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:u.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:u.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:u.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:u.Enum,targetName:"UI_2D"}]),c.VisibilityFlags=Nt,d(g.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),_(At.prototype,"Camera.prototype",[{name:"getSplitFrustum"}]);var Mt,Rt=new f(0,0,-1),Bt=new f,Tt=(t("D",function(t){function e(){var e;return(e=t.call(this)||this)._dir=new f(1,-1,-1),e}m(e,t);var s=e.prototype;return s.initialize=function(){t.prototype.initialize.call(this),p.set(this._handle,A.ILLUMINANCE,S.SUN_ILLUM),p.setVec3(this._handle,A.DIRECTION,this._dir),p.set(this._handle,A.TYPE,St.DIRECTIONAL)},s.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=f.transformQuat(Bt,Rt,this._node.worldRotation))},l(e,[{key:"direction",get:function(){return this._dir},set:function(t){f.normalize(this._dir,t),p.setVec3(this._handle,A.DIRECTION,this._dir)}},{key:"illuminance",get:function(){return p.get(this._handle,A.ILLUMINANCE)},set:function(t){p.set(this._handle,A.ILLUMINANCE,t)}}]),e}(It)),new N(null)),Ct=t("c",function(){function t(){this._device=null,this._passes=null,this._subMesh=null,this._patches=null,this._handle=s,this._priority=v.DEFAULT,this._inputAssembler=null,this._descriptorSet=null}var e=t.prototype;return e.initialize=function(t,e,s){void 0===s&&(s=null),this._device=c.director.root.device,this._subMesh=t,this._patches=s,this._passes=e,this._handle=I.alloc(),this._flushPassInfo(),e[0].batchingScheme===E.VB_MERGING&&this._subMesh.genFlatBuffers(),Tt.layout=e[0].localSetLayout;var i=y.alloc(this._device,Tt),n=L.alloc(this._device,t.iaInfo);I.set(this._handle,b.PRIORITY,v.DEFAULT),I.set(this._handle,b.INPUT_ASSEMBLER,n),I.set(this._handle,b.DESCRIPTOR_SET,i),I.set(this._handle,b.SUB_MESH,t.handle),this._inputAssembler=L.get(n),this._descriptorSet=y.get(i)},e.initPlanarShadowShader=function(){var t=c.director.root.pipeline.pipelineSceneData.shadows.getPlanarShader(this._patches);I.set(this._handle,b.PLANAR_SHADER,t)},e.initPlanarShadowInstanceShader=function(){var t=c.director.root.pipeline.pipelineSceneData.shadows.getPlanarInstanceShader(this._patches);I.set(this._handle,b.PLANAR_INSTANCE_SHADER,t)},e.destroy=function(){y.free(I.get(this._handle,b.DESCRIPTOR_SET)),L.free(I.get(this._handle,b.INPUT_ASSEMBLER)),I.free(this._handle),this._descriptorSet=null,this._inputAssembler=null,this._priority=v.DEFAULT,this._handle=s,this._patches=null,this._subMesh=null,this._passes=null},e.update=function(){for(var t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update()},e.onPipelineStateChanged=function(){var t=this._passes;if(t){for(var e=0;e<t.length;e++){var s=t[e];s.beginChangeStatesSilently(),s.tryCompile(),s.endChangeStatesSilently()}this._flushPassInfo()}},e.onMacroPatchesStateChanged=function(t){this._patches=t;var e=this._passes;if(e){for(var s=0;s<e.length;s++){var i=e[s];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},e._flushPassInfo=function(){var t=this._passes;if(t){I.set(this._handle,b.PASS_COUNT,t.length);for(var e=b.PASS_0,s=b.SHADER_0,i=0;i<t.length;i++,e++,s++)I.set(this._handle,e,t[i].handle),I.set(this._handle,s,t[i].getShaderVariant(this._patches))}},l(t,[{key:"passes",get:function(){return this._passes},set:function(t){if(t.length>8)M(12004,8);else if(this._passes=t,this._flushPassInfo(),this._descriptorSet){y.free(I.get(this._handle,b.DESCRIPTOR_SET)),Tt.layout=t[0].localSetLayout;var e=y.alloc(this._device,Tt);I.set(this._handle,b.DESCRIPTOR_SET,e),this._descriptorSet=y.get(e)}}},{key:"subMesh",get:function(){return this._subMesh},set:function(t){this._subMesh=t,this._inputAssembler.destroy(),this._inputAssembler.initialize(t.iaInfo),this._passes[0].batchingScheme===E.VB_MERGING&&this._subMesh.genFlatBuffers(),I.set(this._handle,b.SUB_MESH,t.handle)}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t,I.set(this._handle,b.PRIORITY,t)}},{key:"handle",get:function(){return this._handle}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarShaderHandle",get:function(){return I.get(this._handle,b.PLANAR_SHADER)}},{key:"planarInstanceShaderHandle",get:function(){return I.get(this._handle,b.PLANAR_INSTANCE_SHADER)}}]),t}()),Ht=new R(B.ATTRIBUTE,(function(t,e){return e||new T})),Pt=new C,Dt=new H((function(){return new Ct}),32),Ft=[{name:"CC_RECEIVE_SHADOW",value:!0}];!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SKINNING=1]="SKINNING",t[t.BAKED_SKINNING=2]="BAKED_SKINNING",t[t.BATCH_2D=3]="BATCH_2D",t[t.PARTICLE_BATCH=4]="PARTICLE_BATCH",t[t.LINE=5]="LINE"}(Mt||(Mt=t("M",{})));var Ot,Ut,wt,kt,Gt,Vt,Wt,zt,xt,Yt,Zt=P([D.LINEAR,D.LINEAR,D.NONE,F.CLAMP,F.CLAMP,F.CLAMP]),Kt=P([D.LINEAR,D.LINEAR,D.LINEAR,F.CLAMP,F.CLAMP,F.CLAMP]),Xt=(t("a",function(){function t(){this.type=Mt.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._enabled=!0,this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._visFlags=u.Enum.NONE,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._transformUpdated=!0,this._handle=s,this._hWorldBounds=s,this._localData=new Float32Array(x.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new Z,this._device=c.director.root.device}var e=t.prototype;return e.initialize=function(){if(!this._inited){this._handle=O.alloc();var t=U.alloc(),e=w.alloc();O.set(this._handle,k.INSTANCED_ATTR_ARRAY,e),O.set(this._handle,k.SUB_MODEL_ARRAY,t),O.set(this._handle,k.VIS_FLAGS,u.Enum.NONE),O.set(this._handle,k.ENABLED,1),O.set(this._handle,k.RECEIVE_SHADOW,1),O.set(this._handle,k.CAST_SHADOW,0),this._inited=!0}},e.destroy=function(){for(var t=this._subModels,e=0;e<t.length;e++){var i=this._subModels[e];i.destroy(),Dt.free(i)}if(this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._transformUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._handle){var n=O.get(this._handle,k.SUB_MODEL_ARRAY);n&&U.free(n);var a=O.get(this._handle,k.INSTANCED_BUFFER);a&&G.free(a);var h=O.get(this._handle,k.INSTANCED_ATTR_ARRAY);h&&V(h,w,Ht),O.free(this._handle),this._handle=s}this._hWorldBounds&&(W.free(this._hWorldBounds),this._hWorldBounds=s)},e.attachToScene=function(t){this.scene=t},e.detachFromScene=function(){this.scene=null},e.updateTransform=function(){var t=this.transform;if(t.hasChangedFlags||t._dirtyFlags){t.updateWorldTransform(),this._transformUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&(this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e),W.setVec3(this._hWorldBounds,z.CENTER,e.center),W.setVec3(this._hWorldBounds,z.HALF_EXTENSION,e.halfExtents))}},e.updateWorldBound=function(){var t=this.transform;if(null!==t){t.updateWorldTransform(),this._transformUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&(this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e),W.setVec3(this._hWorldBounds,z.CENTER,e.center),W.setVec3(this._hWorldBounds,z.HALF_EXTENSION,e.halfExtents))}},e.updateUBOs=function(t){for(var e=this._subModels,s=0;s<e.length;s++)e[s].update();if(this._updateStamp=t,this._transformUpdated){this._transformUpdated=!1;var i,n,a,h,r=this.transform._mat,o=this._instMatWorldIdx;if(o>=0){var l=this.instancedAttributes.views;i=r,n=l[o],a=l[o+1],h=l[o+2],n[0]=i.m00,n[1]=i.m01,n[2]=i.m02,n[3]=i.m12,a[0]=i.m04,a[1]=i.m05,a[2]=i.m06,a[3]=i.m13,h[0]=i.m08,h[1]=i.m09,h[2]=i.m10,h[3]=i.m14}else this._localBuffer&&(C.toArray(this._localData,r,x.MAT_WORLD_OFFSET),C.inverseTranspose(Pt,r),C.toArray(this._localData,Pt,x.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData))}},e.createBoundingShape=function(t,e){t&&e&&(this._modelBounds=Y.fromPoints(Y.create(),t,e),this._worldBounds=Y.clone(this._modelBounds),this._hWorldBounds===s&&(this._hWorldBounds=W.alloc(),O.set(this._handle,k.WORLD_BOUNDS,this._hWorldBounds)),W.setVec3(this._hWorldBounds,z.CENTER,this._worldBounds.center),W.setVec3(this._hWorldBounds,z.HALF_EXTENSION,this._worldBounds.halfExtents))},e.initSubModel=function(t,e,s){this.initialize();var i=!1;if(null==this._subModels[t]?(this._subModels[t]=Dt.alloc(),i=!0):this._subModels[t].destroy(),this._subModels[t].initialize(e,s.passes,this.getMacroPatches(t)),this._subModels[t].initPlanarShadowShader(),this._subModels[t].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(t),i){var n=O.get(this._handle,k.SUB_MODEL_ARRAY);U.assign(n,t,this._subModels[t].handle)}},e.setSubModelMesh=function(t,e){this._subModels[t]&&(this._subModels[t].subMesh=e)},e.setSubModelMaterial=function(t,e){this._subModels[t]&&(this._subModels[t].passes=e.passes,this._updateAttributesAndBinding(t))},e.onGlobalPipelineStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onPipelineStateChanged()},e.onMacroPatchesStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e))},e.updateLightingmap=function(t,e){Z.toArray(this._localData,e,x.LIGHTINGMAP_UVPARAM),this._lightmap=t,this._lightmapUVParam=e,null===t&&(t=K.get("empty-texture"));var s=t.getGFXTexture();if(s)for(var i=X.getSampler(this._device,t.mipmaps.length>1?Kt:Zt),n=this._subModels,a=0;a<n.length;a++){var h=n[a].descriptorSet;h.bindTexture(j,s),h.bindSampler(j,i),h.update()}},e.getMacroPatches=function(){return this.receiveShadow?Ft:null},e._updateAttributesAndBinding=function(t){var e=this._subModels[t];if(e){this._initLocalDescriptors(t),this._updateLocalDescriptors(t,e.descriptorSet);var s=Q.get(I.get(e.handle,b.SHADER_0));this._updateInstancedAttributes(s.attributes,e.passes[0])}},e._getInstancedAttributeIndex=function(t){for(var e=this.instancedAttributes.attributes,s=0;s<e.length;s++)if(e[s].name===t)return s;return-1},e._updateInstancedAttributes=function(t,e){if(e.device.hasFeature(q.INSTANCED_ARRAYS)){var s=O.get(this._handle,k.INSTANCED_BUFFER);s&&G.free(s);var i=O.get(this._handle,k.INSTANCED_ATTR_ARRAY);i&&V(i,w,Ht,!1);for(var n=0,a=0;a<t.length;a++){var h=t[a];h.isInstanced&&(n+=J[h.format].size)}var r=G.alloc(n),o=G.getBuffer(r);O.set(this._handle,k.INSTANCED_BUFFER,r);var l=this.instancedAttributes;l.buffer=new Uint8Array(o),l.views.length=l.attributes.length=0;for(var _=0,d=0;d<t.length;d++){var u=t[d];if(u.isInstanced){var c=Ht.alloc(),g=Ht.get(c);g.format=u.format,g.name=u.name,g.isNormalized=u.isNormalized,g.location=u.location,l.attributes.push(g),w.push(i,c);var f=J[u.format];l.views.push(new($(f))(o,_,f.count)),_+=f.size}}e.batchingScheme===E.INSTANCING&&Et.get(e).destroy(),this._instMatWorldIdx=this._getInstancedAttributeIndex(tt),this._transformUpdated=!0}},e._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new et(st.UNIFORM|st.TRANSFER_DST,it.HOST|it.DEVICE,x.SIZE,x.SIZE)))},e._updateLocalDescriptors=function(t,e){this._localBuffer&&e.bindBuffer(x.BINDING,this._localBuffer)},l(t,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return!!O.get(this._handle,k.RECEIVE_SHADOW)},set:function(t){O.set(this._handle,k.RECEIVE_SHADOW,t?1:0),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return!!O.get(this._handle,k.CAST_SHADOW)},set:function(t){O.set(this._handle,k.CAST_SHADOW,t?1:0)}},{key:"handle",get:function(){return this._handle}},{key:"node",get:function(){return this._node},set:function(t){this._node=t,O.set(this._handle,k.NODE,t.handle)}},{key:"transform",get:function(){return this._transform},set:function(t){this._transform=t,O.set(this._handle,k.TRANSFORM,t.handle)}},{key:"visFlags",get:function(){return this._visFlags},set:function(t){this._visFlags=t,O.set(this._handle,k.VIS_FLAGS,t)}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t,O.set(this._handle,k.ENABLED,t?1:0)}}]),t}()),t("S",function(t){function e(){var e;return(e=t.call(this)||this)._needUpdate=!1,e._pos=void 0,e._aabb=void 0,e._hAABB=s,e._aabb=Y.create(),e._pos=new f,e}m(e,t);var i=e.prototype;return i.initialize=function(){t.prototype.initialize.call(this),this._hAABB=W.alloc(),p.set(this._handle,A.TYPE,St.SPHERE),p.set(this._handle,A.SIZE,.15),p.set(this._handle,A.RANGE,1),p.set(this._handle,A.AABB,this._hAABB),p.set(this._handle,A.ILLUMINANCE,1700/yt(.15))},i.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var t=p.get(this._handle,A.RANGE);Y.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1,p.setVec3(this._handle,A.POSITION,this._pos),W.setVec3(this._hAABB,z.CENTER,this._aabb.center),W.setVec3(this._hAABB,z.HALF_EXTENSION,this._aabb.halfExtents)}},i.destroy=function(){return this._hAABB&&(W.free(this._hAABB),this._hAABB=s),t.prototype.destroy.call(this)},l(e,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return p.get(this._handle,A.SIZE)},set:function(t){p.set(this._handle,A.SIZE,t)}},{key:"range",get:function(){return p.get(this._handle,A.RANGE)},set:function(t){p.set(this._handle,A.RANGE,t),this._needUpdate=!0}},{key:"luminance",get:function(){return p.get(this._handle,A.ILLUMINANCE)},set:function(t){p.set(this._handle,A.ILLUMINANCE,t)}},{key:"aabb",get:function(){return this._aabb}}]),e}(It)),new f(0,0,-1)),jt=new nt,Qt=new C,qt=new C,Jt=new C,$t=new C,te=(t("b",function(t){function e(){var e;return(e=t.call(this)||this)._dir=new f(1,-1,-1),e._range=5,e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._hAABB=s,e._hFrustum=s,e._aabb=Y.create(),e._frustum=rt.create(),e._pos=new f,e}m(e,t);var i=e.prototype;return i.initialize=function(){t.prototype.initialize.call(this),this._hAABB=W.alloc(),this._hFrustum=at.alloc(),p.set(this._handle,A.TYPE,St.SPOT),p.set(this._handle,A.SIZE,.15),p.set(this._handle,A.AABB,this._hAABB),p.set(this._handle,A.ILLUMINANCE,1700/yt(.15)),p.set(this._handle,A.RANGE,Math.cos(Math.PI/6)),p.set(this._handle,A.ASPECT,1),p.setVec3(this._handle,A.DIRECTION,this._dir),p.set(this._handle,A.FRUSTUM,this._hFrustum)},i.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),f.transformQuat(this._dir,Xt,this._node.getWorldRotation(jt)),f.normalize(this._dir,this._dir),p.setVec3(this._handle,A.DIRECTION,this._dir),Y.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(Qt),C.invert(Qt,Qt),C.perspective(qt,this._angle,1,.001,this._range),C.multiply(Jt,qt,Qt),this._frustum.update(Jt,$t),this._needUpdate=!1,p.setVec3(this._handle,A.POSITION,this._pos),W.setVec3(this._hAABB,z.CENTER,this._aabb.center),W.setVec3(this._hAABB,z.HALF_EXTENSION,this._aabb.halfExtents),ht(this._hFrustum,this._frustum))},i.destroy=function(){return this._hAABB&&(W.free(this._hAABB),this._hAABB=s),this._hFrustum&&(at.free(this._hFrustum),this._hFrustum=s),t.prototype.destroy.call(this)},l(e,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return p.get(this._handle,A.SIZE)},set:function(t){p.set(this._handle,A.SIZE,t)}},{key:"range",get:function(){return p.get(this._handle,A.RANGE)},set:function(t){this._range=t,p.set(this._handle,A.RANGE,t),this._needUpdate=!0}},{key:"luminance",get:function(){return p.get(this._handle,A.ILLUMINANCE)},set:function(t){p.set(this._handle,A.ILLUMINANCE,t)}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return p.get(this._handle,A.SPOT_ANGLE)},set:function(t){this._angle=t,p.set(this._handle,A.SPOT_ANGLE,Math.cos(.5*t)),this._needUpdate=!0}},{key:"aspect",get:function(){return p.get(this._handle,A.ASPECT)},set:function(t){p.set(this._handle,A.ASPECT,t),this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),e}(It)),{parent:null,owner:null,subModelIdx:0}),ee=t("d",(Ot=ot("cc.RenderableComponent"),Ut=lt([_t]),wt=lt(_t),kt=ut(),Gt=ct(),Ot((Yt=function(t){function e(){for(var e,s=arguments.length,i=new Array(s),n=0;n<s;n++)i[n]=arguments[n];return e=t.call.apply(t,[this].concat(i))||this,gt(e,"_materials",zt,ft(e)),gt(e,"_visFlags",xt,ft(e)),e._materialInstances=[],e._models=[],e}m(e,t);var s=e.prototype;return s.getMaterial=function(t){return t<0||t>=this._materials.length?null:this._materials[t]},s.setMaterial=function(t,e){t&&t instanceof Lt&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[e]=t;var s=this._materialInstances[e];s?s.parent!==this._materials[e]&&(s.destroy(),this._materialInstances[e]=null,this._onMaterialModified(e,this._materials[e])):this._onMaterialModified(e,this._materials[e])},s.getMaterialInstance=function(t){if(!this._materials[t])return null;if(!this._materialInstances[t]){te.parent=this._materials[t],te.owner=this,te.subModelIdx=t;var e=new Lt(te);this.setMaterialInstance(t,e)}return this._materialInstances[t]},s.setMaterialInstance=function(t,e){e&&e.parent?e!==this._materialInstances[t]&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):e!==this._materials[t]&&this.setMaterial(e,t)},s.getRenderMaterial=function(t){return this._materialInstances[t]||this._materials[t]},s._collectModels=function(){return this._models},s._attachToScene=function(){},s._detachFromScene=function(){},s._onMaterialModified=function(){},s._onRebuildPSO=function(){},s._clearMaterials=function(){},s._onVisibilityChange=function(){},l(e,[{key:"visibility",get:function(){return this._visFlags},set:function(t){this._visFlags=t,this._onVisibilityChange(t)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(t){for(var e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(var s=t.length;s<this._materials.length;s++)this.setMaterial(null,s);this._materials.splice(t.length)}}},{key:"materials",get:function(){for(var t=0;t<this._materials.length;t++)this._materialInstances[t]=this.getMaterialInstance(t);return this._materialInstances},set:function(t){var e=t.length-this._materials.length;if(e>0)this._materials.length=t.length,this._materialInstances.length=t.length;else if(e<0)for(var s=this._materials.length-e;s<this._materials.length;++s)this.setMaterialInstance(s,null);for(var i=0;i<this._materialInstances.length;i++)this._materialInstances[i]!=t[i]&&this.setMaterialInstance(i,t[i])}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(t){1===this._materials.length&&this._materials[0]===t||this.setMaterialInstance(0,t)}}]),e}(mt),zt=dt((Wt=Yt).prototype,"_materials",[Ut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xt=dt(Wt.prototype,"_visFlags",[pt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return u.Enum.NONE}}),dt(Wt.prototype,"sharedMaterials",[wt,kt,Gt],Object.getOwnPropertyDescriptor(Wt.prototype,"sharedMaterials"),Wt.prototype),Vt=Wt))||Vt));c.RenderableComponent=ee}}}));
